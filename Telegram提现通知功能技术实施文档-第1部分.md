# Telegram æç°é€šçŸ¥åŠŸèƒ½æŠ€æœ¯å®æ–½æ–‡æ¡£ - ç¬¬1éƒ¨åˆ†

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

**åŠŸèƒ½åç§°**ï¼šTelegram Bot æç°ç”³è¯·å®æ—¶é€šçŸ¥  
**å®æ–½æ—¶é—´**ï¼š2026-01-05  
**é¢„è®¡å¼€å‘æ—¶é—´**ï¼š2-3 å°æ—¶  
**æ€»æˆæœ¬**ï¼š0 å…ƒï¼ˆå®Œå…¨å…è´¹ï¼‰

---

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

å½“ç”¨æˆ·åœ¨å‰ç«¯ç”³è¯·æç°æ—¶ï¼Œç®¡ç†å‘˜èƒ½å¤Ÿï¼š
1. âœ… **å®æ—¶æ”¶åˆ°é€šçŸ¥**ï¼ˆ< 1ç§’å»¶è¿Ÿï¼‰
2. âœ… **æŸ¥çœ‹æç°è¯¦æƒ…**ï¼ˆç”¨æˆ·åœ°å€ã€é‡‘é¢ã€èƒ½é‡æ¶ˆè€—ï¼‰
3. âœ… **å¿«é€Ÿè·³è½¬å®¡æ ¸**ï¼ˆç‚¹å‡»æŒ‰é’®ç›´è¾¾åå°ï¼‰
4. âœ… **æ”¶åˆ°å®Œæˆé€šçŸ¥**ï¼ˆæç°å®Œæˆåè‡ªåŠ¨é€šçŸ¥ï¼‰

---

## ğŸ“ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·å‰ç«¯      â”‚
â”‚  (æç°ç”³è¯·)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ POST /api/withdraw
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åç«¯ API                    â”‚
â”‚  rabbit-ai-backend              â”‚
â”‚                                  â”‚
â”‚  1. âœ… éªŒè¯ç”¨æˆ·ä½™é¢              â”‚
â”‚  2. âœ… åˆ›å»ºæç°è®°å½• (Pending)    â”‚
â”‚  3. âœ¨ å‘é€ Telegram é€šçŸ¥        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Telegram Bot API              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç®¡ç†å‘˜ Telegram å®¢æˆ·ç«¯        â”‚
â”‚                                  â”‚
â”‚  ğŸ”” æ–°æç°ç”³è¯·ï¼                â”‚
â”‚  ğŸ‘¤ 0xd2d2...c760               â”‚
â”‚  ğŸ’° 2 USDT                       â”‚
â”‚  âš¡ 20 èƒ½é‡                      â”‚
â”‚                                  â”‚
â”‚  [ğŸ” æŸ¥çœ‹è¯¦æƒ…] [âœ… ç«‹å³å®¡æ ¸]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Telegram Bot

### 1.1 ä¸ BotFather å¯¹è¯

1. **æ‰“å¼€ Telegram**ï¼Œæœç´¢ `@BotFather`

2. **å‘é€å‘½ä»¤åˆ›å»ºæœºå™¨äºº**ï¼š
   ```
   /newbot
   ```

3. **è®¾ç½®æœºå™¨äººåç§°**ï¼ˆæ˜¾ç¤ºåç§°ï¼Œå¯ä»¥åŒ…å«ä¸­æ–‡ï¼‰ï¼š
   ```
   RabbitDiFi ç®¡ç†é€šçŸ¥æœºå™¨äºº
   ```

4. **è®¾ç½®æœºå™¨äººç”¨æˆ·å**ï¼ˆå¿…é¡»ä»¥ `bot` ç»“å°¾ï¼Œåªèƒ½è‹±æ–‡ï¼‰ï¼š
   ```
   rabbitdifi_admin_bot
   ```

5. **ä¿å­˜ Bot Token**ï¼ˆâš ï¸ é‡è¦ï¼Œåé¢è¦ç”¨ï¼‰ï¼š
   ```
   ç¤ºä¾‹ï¼š123456789:ABCdefGHIjklMNOpqrsTUVwxyz1234567
   ```

### 1.2 è·å–ç®¡ç†å‘˜ Chat ID

1. **æœç´¢æœºå™¨äºº** `@userinfobot`

2. **å‘é€ä»»æ„æ¶ˆæ¯**

3. **è·å¾—ä½ çš„ Chat ID**ï¼ˆâš ï¸ ä¿å­˜ä¸‹æ¥ï¼‰ï¼š
   ```
   ç¤ºä¾‹ï¼š123456789
   ```

### 1.3 å¯åŠ¨æœºå™¨äºº

1. **åœ¨ Telegram æœç´¢ä½ çš„æœºå™¨äºº**ï¼š`@rabbitdifi_admin_bot`

2. **ç‚¹å‡» START**ï¼ˆå¿…é¡»å…ˆç‚¹å‡»ï¼Œå¦åˆ™æœºå™¨äººæ— æ³•ç»™ä½ å‘æ¶ˆæ¯ï¼‰

---

## ğŸ’» ç¬¬äºŒæ­¥ï¼šåç«¯ä»£ç å®ç°

### 2.1 å®‰è£…ä¾èµ–åŒ…

```bash
cd rabbit-ai-backend
npm install node-telegram-bot-api
npm install @types/node-telegram-bot-api --save-dev
```

### 2.2 é…ç½®ç¯å¢ƒå˜é‡

**ç¼–è¾‘ `rabbit-ai-backend/.env`**ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```bash
# Telegram Bot é…ç½®
TELEGRAM_BOT_TOKEN=ä½ çš„Bot Tokenï¼ˆç¬¬ä¸€æ­¥è·å–ï¼‰
TELEGRAM_ADMIN_CHAT_ID=ä½ çš„Chat IDï¼ˆç¬¬ä¸€æ­¥è·å–ï¼‰
TELEGRAM_NOTIFICATIONS_ENABLED=true
```

**ç¤ºä¾‹**ï¼š
```bash
# Telegram Bot é…ç½®
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz1234567
TELEGRAM_ADMIN_CHAT_ID=123456789
TELEGRAM_NOTIFICATIONS_ENABLED=true
```

### 2.3 æ›´æ–°é…ç½®æ–‡ä»¶

**ç¼–è¾‘ `rabbit-ai-backend/src/config.ts`**ï¼Œåœ¨ `config` å¯¹è±¡ä¸­æ·»åŠ ï¼š

```typescript
// åœ¨æ–‡ä»¶æœ«å°¾ï¼Œconfig å¯¹è±¡ä¸­æ·»åŠ 
export const config = {
  // ... ç°æœ‰é…ç½®ä¿æŒä¸å˜ ...
  
  // ğŸŸ¢ æ–°å¢ï¼šTelegram é€šçŸ¥é…ç½®
  telegram: {
    botToken: process.env.TELEGRAM_BOT_TOKEN || '',
    adminChatId: process.env.TELEGRAM_ADMIN_CHAT_ID || '',
    enabled: process.env.TELEGRAM_NOTIFICATIONS_ENABLED === 'true',
  },
};
```

### 2.4 åˆ›å»º Telegram æœåŠ¡æ–‡ä»¶

**åˆ›å»ºæ–°æ–‡ä»¶ `rabbit-ai-backend/src/services/telegram.ts`**ï¼š

```typescript
import TelegramBot from 'node-telegram-bot-api';
import { config } from '../config.js';

// åˆ›å»º Telegram Bot å®ä¾‹ï¼ˆä»…åœ¨å¯ç”¨æ—¶ï¼‰
let bot: TelegramBot | null = null;

if (config.telegram.enabled && config.telegram.botToken) {
  bot = new TelegramBot(config.telegram.botToken, { polling: false });
  console.log('[Telegram Bot] âœ… å·²åˆå§‹åŒ–');
} else {
  console.log('[Telegram Bot] âš ï¸ æœªå¯ç”¨æˆ–é…ç½®ä¸å®Œæ•´');
}

/**
 * å‘é€æç°ç”³è¯·é€šçŸ¥
 */
export async function sendWithdrawalNotification(params: {
  address: string;
  amount: string;
  energyCost: number;
  withdrawalId: string;
}) {
  if (!bot || !config.telegram.enabled) {
    console.log('[Telegram] é€šçŸ¥åŠŸèƒ½æœªå¯ç”¨ï¼Œè·³è¿‡å‘é€');
    return;
  }

  const { address, amount, energyCost, withdrawalId } = params;

  // æ ¼å¼åŒ–åœ°å€ï¼ˆæ˜¾ç¤ºå‰ 6 ä½å’Œå 4 ä½ï¼‰
  const shortAddress = `${address.slice(0, 6)}...${address.slice(-4)}`;

  // æ„é€ æ¶ˆæ¯
  const message = `
ğŸ”” *æ–°çš„æç°ç”³è¯·*

ğŸ‘¤ *ç”¨æˆ·åœ°å€*: \`${shortAddress}\`
ğŸ’° *æç°é‡‘é¢*: *${amount} USDT*
âš¡ *æ¶ˆè€—èƒ½é‡*: ${energyCost}
ğŸ†” *ç”³è¯·ID*: \`${withdrawalId.slice(0, 8)}\`

â° *ç”³è¯·æ—¶é—´*: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}

ğŸ“Š *æ“ä½œ*:
â€¢ [æŸ¥çœ‹åå°](https://admin.rabbitdifi.com/#/finance)
â€¢ [æŸ¥çœ‹ç”¨æˆ·](https://admin.rabbitdifi.com/#/users?address=${address})
  `.trim();

  // æ·»åŠ å¿«æ·æŒ‰é’®
  const keyboard = {
    inline_keyboard: [
      [
        {
          text: 'ğŸ” æŸ¥çœ‹è¯¦æƒ…',
          url: `https://admin.rabbitdifi.com/#/finance`,
        },
        {
          text: 'âœ… ç«‹å³å®¡æ ¸',
          url: `https://admin.rabbitdifi.com/#/finance`,
        },
      ],
    ],
  };

  try {
    await bot.sendMessage(config.telegram.adminChatId, message, {
      parse_mode: 'Markdown',
      reply_markup: keyboard,
    });
    console.log(`[Telegram] âœ… æç°é€šçŸ¥å·²å‘é€: ${withdrawalId}`);
  } catch (error) {
    console.error('[Telegram] âŒ å‘é€é€šçŸ¥å¤±è´¥:', error);
    // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“æç°æµç¨‹
  }
}

/**
 * å‘é€æç°å®Œæˆé€šçŸ¥
 */
export async function sendWithdrawalCompletedNotification(params: {
  address: string;
  amount: string;
  txHash: string;
  withdrawalId: string;
}) {
  if (!bot || !config.telegram.enabled) {
    return;
  }

  const { address, amount, txHash, withdrawalId } = params;
  const shortAddress = `${address.slice(0, 6)}...${address.slice(-4)}`;
  const shortTxHash = `${txHash.slice(0, 10)}...${txHash.slice(-8)}`;

  const message = `
âœ… *æç°å·²å®Œæˆ*

ğŸ‘¤ *ç”¨æˆ·åœ°å€*: \`${shortAddress}\`
ğŸ’° *æç°é‡‘é¢*: *${amount} USDT*
ğŸ”— *äº¤æ˜“å“ˆå¸Œ*: \`${shortTxHash}\`
ğŸ†” *ç”³è¯·ID*: \`${withdrawalId.slice(0, 8)}\`

â° *å®Œæˆæ—¶é—´*: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}

[ğŸ“‹ æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…](https://bscscan.com/tx/${txHash})
  `.trim();

  try {
    await bot.sendMessage(config.telegram.adminChatId, message, {
      parse_mode: 'Markdown',
    });
    console.log(`[Telegram] âœ… æç°å®Œæˆé€šçŸ¥å·²å‘é€: ${withdrawalId}`);
  } catch (error) {
    console.error('[Telegram] âŒ å‘é€å®Œæˆé€šçŸ¥å¤±è´¥:', error);
  }
}

/**
 * å‘é€æµ‹è¯•é€šçŸ¥
 */
export async function sendTestNotification() {
  if (!bot || !config.telegram.enabled) {
    throw new Error('Telegram Bot æœªå¯ç”¨æˆ–é…ç½®ä¸å®Œæ•´');
  }

  const message = `
ğŸ¤– *Telegram Bot æµ‹è¯•*

âœ… Bot é…ç½®æ­£ç¡®ï¼
â° å½“å‰æ—¶é—´: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}

æ‚¨å°†é€šè¿‡æ­¤æœºå™¨äººæ¥æ”¶æç°ç”³è¯·é€šçŸ¥ã€‚
  `.trim();

  try {
    await bot.sendMessage(config.telegram.adminChatId, message, {
      parse_mode: 'Markdown',
    });
    console.log('[Telegram] âœ… æµ‹è¯•é€šçŸ¥å·²å‘é€');
    return { success: true, message: 'æµ‹è¯•é€šçŸ¥å‘é€æˆåŠŸ' };
  } catch (error) {
    console.error('[Telegram] âŒ å‘é€æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
    throw error;
  }
}
```

### 2.5 é›†æˆåˆ°æç°æµç¨‹

**ç¼–è¾‘ `rabbit-ai-backend/src/services/withdraw.ts`**ï¼š

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

```typescript
// åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 
import { sendWithdrawalNotification } from './telegram.js';
```

åœ¨ `applyWithdraw` å‡½æ•°ä¸­ï¼Œæ‰¾åˆ°åˆ›å»ºæç°è®°å½•çš„éƒ¨åˆ†ï¼ˆçº¦åœ¨ç¬¬ 140-150 è¡Œï¼‰ï¼Œæ·»åŠ é€šçŸ¥é€»è¾‘ï¼š

```typescript
// åˆ›å»ºæç°è®°å½•
const { data: withdrawal, error: insertErr } = await supabase
  .from('withdrawals')
  .insert({
    address: addr,
    amount: amountStr,
    energy_cost: requiredEnergy,
    status: 'Pending',
    created_at: nowIso,
  })
  .select()
  .single();

if (insertErr || !withdrawal) {
  throw new ApiError('INSERT_FAILED', insertErr?.message || 'Failed to create withdrawal');
}

// ğŸŸ¢ æ–°å¢ï¼šå‘é€ Telegram é€šçŸ¥
try {
  await sendWithdrawalNotification({
    address: addr,
    amount: amountStr,
    energyCost: requiredEnergy,
    withdrawalId: withdrawal.id,
  });
} catch (notificationError) {
  // é€šçŸ¥å¤±è´¥ä¸å½±å“æç°æµç¨‹
  console.error('[Withdraw] Telegram é€šçŸ¥å‘é€å¤±è´¥:', notificationError);
}

return {
  ok: true,
  message: 'Withdrawal request submitted',
  withdrawalId: withdrawal.id,
};
```

### 2.6 é›†æˆåˆ°æç°å®Œæˆæµç¨‹

**ç¼–è¾‘ `rabbit-ai-backend/src/services/admin.ts`**ï¼š

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

```typescript
// åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 
import { sendWithdrawalCompletedNotification } from './telegram.js';
```

æ‰¾åˆ° `completeWithdrawal` å‡½æ•°ï¼ˆçº¦åœ¨ç¬¬ 330-366 è¡Œï¼‰ï¼Œåœ¨æ›´æ–°æç°è®°å½•çŠ¶æ€ä¹‹åæ·»åŠ é€šçŸ¥é€»è¾‘ï¼š

```typescript
// æ›´æ–°æç°è®°å½•çŠ¶æ€
await supabase
  .from('withdrawals')
  .update({
    status: 'Completed',
    payout_tx_hash: params.payoutTxHash,
    updated_at: new Date().toISOString(),
  })
  .eq('id', params.withdrawalId);

// ğŸŸ¢ æ–°å¢ï¼šå‘é€å®Œæˆé€šçŸ¥
try {
  await sendWithdrawalCompletedNotification({
    address: w.address,
    amount: w.amount,
    txHash: params.payoutTxHash,
    withdrawalId: params.withdrawalId,
  });
} catch (notificationError) {
  console.error('[CompleteWithdrawal] Telegram é€šçŸ¥å‘é€å¤±è´¥:', notificationError);
}

return { ok: true };
```

### 2.7 æ·»åŠ æµ‹è¯• API

**ç¼–è¾‘ `rabbit-ai-backend/src/api/routes/admin.ts`**ï¼š

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

```typescript
// åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 
import { sendTestNotification } from '../../services/telegram.js';
```

åœ¨æ–‡ä»¶æœ«å°¾ï¼ˆæ³¨å†Œå…¶ä»–è·¯ç”±çš„åœ°æ–¹ï¼‰æ·»åŠ æµ‹è¯•è·¯ç”±ï¼š

```typescript
// ğŸŸ¢ æ–°å¢ï¼šæµ‹è¯• Telegram é€šçŸ¥
app.post('/api/admin/test-telegram', async (req: FastifyRequest, reply: FastifyReply) => {
  if (!assertAdmin(req, reply)) return;

  try {
    const result = await sendTestNotification();
    return { ok: true, ...result };
  } catch (error: any) {
    return reply.status(500).send({
      ok: false,
      code: 'TEST_FAILED',
      message: error.message || 'Failed to send test notification',
    });
  }
});
```

---

## ğŸ”§ ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘å’Œé‡å¯åç«¯

### 3.1 ç¼–è¯‘ TypeScript

```bash
cd rabbit-ai-backend
npm run build
```

### 3.2 é‡å¯åç«¯æœåŠ¡

**å¦‚æœä½¿ç”¨ PM2**ï¼š
```bash
pm2 restart rabbit-ai-backend
pm2 logs rabbit-ai-backend --lines 50
```

**å¦‚æœä½¿ç”¨å…¶ä»–æ–¹å¼**ï¼š
```bash
# åœæ­¢ç°æœ‰è¿›ç¨‹ï¼Œç„¶åé‡æ–°å¯åŠ¨
npm start
```

### 3.3 æ£€æŸ¥æ—¥å¿—

ç¡®è®¤çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š
```
[Telegram Bot] âœ… å·²åˆå§‹åŒ–
```

å¦‚æœçœ‹åˆ°ï¼š
```
[Telegram Bot] âš ï¸ æœªå¯ç”¨æˆ–é…ç½®ä¸å®Œæ•´
```

è¯·æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„é…ç½®æ˜¯å¦æ­£ç¡®ã€‚

---

## âœ… ç¬¬ä¸€éƒ¨åˆ†å®Œæˆ

**å·²å®Œæˆçš„å·¥ä½œ**ï¼š
- âœ… åˆ›å»º Telegram Bot
- âœ… è·å– Bot Token å’Œ Chat ID
- âœ… å®‰è£…ä¾èµ–åŒ…
- âœ… é…ç½®ç¯å¢ƒå˜é‡
- âœ… åˆ›å»º Telegram æœåŠ¡
- âœ… é›†æˆåˆ°æç°æµç¨‹
- âœ… é›†æˆåˆ°å®Œæˆæµç¨‹
- âœ… æ·»åŠ æµ‹è¯• API
- âœ… ç¼–è¯‘å’Œé‡å¯

**ä¸‹ä¸€æ­¥**ï¼š
- â³ æµ‹è¯•é€šçŸ¥åŠŸèƒ½
- â³ æµ‹è¯•æç°æµç¨‹
- â³ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- â³ é«˜çº§åŠŸèƒ½é…ç½®

---

**ç¬¬1éƒ¨åˆ†å®Œæˆæ—¶é—´**ï¼š2026-01-05  
**é¢„è®¡ç”¨æ—¶**ï¼š1-1.5 å°æ—¶  
**ä¸‹ä¸€æ­¥**ï¼šæŸ¥çœ‹ç¬¬2éƒ¨åˆ†ï¼ˆæµ‹è¯•ä¸éƒ¨ç½²ï¼‰

