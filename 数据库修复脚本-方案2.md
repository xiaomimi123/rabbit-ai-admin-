# æ•°æ®åº“ä¿®å¤è„šæœ¬ - æ–¹æ¡ˆ2ï¼ˆusdt_total ä½œä¸ºä½™é¢ï¼‰

## ğŸ“‹ ä¿®å¤è¯´æ˜

**ä¿®å¤ç›®æ ‡**ï¼šå°†æ•°æ®åº“ä¸­çš„ `usdt_total` è¡¥å¿å›æ­£ç¡®çš„ä½™é¢

**åŸå› **ï¼š
- ä¹‹å‰çš„é€»è¾‘ï¼šæç°æ—¶æ‰£é™¤äº† `usdt_total`ï¼Œæ˜¾ç¤ºæ—¶åˆå‡å»äº† `totalWithdrawn`
- å¯¼è‡´ï¼šæç°é‡‘é¢è¢«é‡å¤æ‰£é™¤
- ä¿®å¤åï¼š`usdt_total` ä½œä¸º"å½“å‰ä½™é¢"ï¼Œæ˜¾ç¤ºæ—¶ä¸å†å‡å» `totalWithdrawn`
- éœ€è¦è¡¥å¿ï¼šå°†ä¹‹å‰è¢«å¤šæ‰£é™¤çš„é‡‘é¢åŠ å›æ¥

---

## ğŸ” æ­¥éª¤1ï¼šæŸ¥è¯¢å—å½±å“ç”¨æˆ·

### æµ‹è¯•è´¦å·

```sql
-- æŸ¥è¯¢æµ‹è¯•è´¦å·çš„å½“å‰çŠ¶æ€
SELECT 
    u.address,
    u.usdt_total as current_usdt_total,
    u.usdt_locked,
    u.last_settlement_time,
    u.updated_at,
    COALESCE(SUM(CASE WHEN w.status IN ('Pending', 'Completed') THEN w.amount::numeric ELSE 0 END), 0) as total_withdrawn,
    COUNT(w.id) as withdrawal_count
FROM users u
LEFT JOIN withdrawals w ON LOWER(w.address) = LOWER(u.address)
WHERE LOWER(u.address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760')
GROUP BY u.address, u.usdt_total, u.usdt_locked, u.last_settlement_time, u.updated_at;
```

**é¢„æœŸç»“æœ**ï¼š
```
address: 0xd2d24d6839e26a87af01b621d1b2d348295fc760
current_usdt_total: 22.082 USDT
total_withdrawn: 15.74 USDT
```

**åº”è¯¥çš„ usdt_total**ï¼š
```
æ­£ç¡®çš„ usdt_total = current_usdt_total + total_withdrawn
                  = 22.082 + 15.74
                  = 37.822 USDT
```

---

## ğŸ”§ æ­¥éª¤2ï¼šå¤‡ä»½æ•°æ®

```sql
-- åˆ›å»ºå¤‡ä»½è¡¨
CREATE TABLE IF NOT EXISTS users_backup_20260105 AS 
SELECT * FROM users;

CREATE TABLE IF NOT EXISTS withdrawals_backup_20260105 AS 
SELECT * FROM withdrawals;
```

---

## ğŸ’‰ æ­¥éª¤3ï¼šä¿®å¤æµ‹è¯•è´¦å·æ•°æ®

### æ–¹æ³•Aï¼šæ‰‹åŠ¨è®¡ç®—è¡¥å¿é‡‘é¢

```sql
-- å¯¹äºæµ‹è¯•è´¦å·ï¼Œæ‰‹åŠ¨è¡¥å¿è¢«å¤šæ‰£é™¤çš„é‡‘é¢
-- current_usdt_total = 22.082
-- total_withdrawn = 15.74
-- åº”è¯¥è¡¥å¿ = 15.74 USDT

UPDATE users 
SET usdt_total = usdt_total + 15.74,
    updated_at = NOW()
WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');
```

### æ–¹æ³•Bï¼šä½¿ç”¨å­æŸ¥è¯¢è‡ªåŠ¨è®¡ç®—ï¼ˆæ¨èï¼‰

```sql
-- ğŸŸ¢ æ¨èï¼šä½¿ç”¨å­æŸ¥è¯¢è‡ªåŠ¨è®¡ç®—æ¯ä¸ªç”¨æˆ·éœ€è¦è¡¥å¿çš„é‡‘é¢
UPDATE users u
SET 
    usdt_total = u.usdt_total + COALESCE(
        (SELECT SUM(w.amount::numeric) 
         FROM withdrawals w 
         WHERE LOWER(w.address) = LOWER(u.address)
           AND w.status IN ('Pending', 'Completed')),
        0
    ),
    updated_at = NOW()
WHERE LOWER(u.address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');
```

---

## âœ… æ­¥éª¤4ï¼šéªŒè¯ä¿®å¤ç»“æœ

### éªŒè¯æµ‹è¯•è´¦å·

```sql
-- æŸ¥è¯¢ä¿®å¤åçš„çŠ¶æ€
SELECT 
    u.address,
    u.usdt_total as fixed_usdt_total,
    u.usdt_locked,
    COALESCE(SUM(CASE WHEN w.status IN ('Pending', 'Completed') THEN w.amount::numeric ELSE 0 END), 0) as total_withdrawn
FROM users u
LEFT JOIN withdrawals w ON LOWER(w.address) = LOWER(u.address)
WHERE LOWER(u.address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760')
GROUP BY u.address, u.usdt_total, u.usdt_locked;
```

**é¢„æœŸç»“æœ**ï¼š
```
address: 0xd2d24d6839e26a87af01b621d1b2d348295fc760
fixed_usdt_total: 37.822 USDT (22.082 + 15.74)
total_withdrawn: 15.74 USDT
```

### éªŒè¯å‰ç«¯æ˜¾ç¤º

**ä¿®å¤åï¼Œå‰ç«¯åº”è¯¥æ˜¾ç¤º**ï¼š
```
usdt_total = 37.822 USDT
å¢é‡æ”¶ç›Š â‰ˆ 0.1-0.2 USDTï¼ˆå–å†³äºæŸ¥çœ‹æ—¶é—´ï¼‰
å®æ—¶æ€»æ”¶ç›Š = 37.822 + 0.1 = 37.922 USDT
å¯æç°æ”¶ç›Š = 37.922 USDTï¼ˆä¸å‡å» totalWithdrawnï¼‰

é¢„æœŸæ˜¾ç¤ºï¼šçº¦ 38 USDT âœ…
```

**ä¸ç”¨æˆ·é¢„æœŸå¯¹æ¯”**ï¼š
- æç°å‰ï¼š10 USDT
- æç°äº†ï¼š2 USDT
- é¢„æœŸæ˜¾ç¤ºï¼š8 USDT
- **ä½†å®é™…åº”è¯¥æ˜¯**ï¼š
  - æç°å‰çœŸå®ä½™é¢ï¼šçº¦ 24 USDTï¼ˆusdt_total + å¢é‡ï¼‰
  - æç°äº†ï¼š2 USDT
  - ä¿®å¤åæ˜¾ç¤ºï¼šçº¦ 38 USDTï¼ˆ24 + è¢«å¤šæ‰£çš„ 15.74ï¼‰

---

## ğŸ” æ­¥éª¤5ï¼šæŸ¥è¯¢æ‰€æœ‰å—å½±å“ç”¨æˆ·

### ç”Ÿäº§ç¯å¢ƒä¿®å¤ï¼ˆè°¨æ…æ‰§è¡Œï¼‰

```sql
-- æŸ¥è¯¢æ‰€æœ‰æœ‰æç°è®°å½•çš„ç”¨æˆ·
SELECT 
    u.address,
    u.usdt_total as current_usdt_total,
    COALESCE(SUM(CASE WHEN w.status IN ('Pending', 'Completed') THEN w.amount::numeric ELSE 0 END), 0) as total_withdrawn,
    u.usdt_total + COALESCE(SUM(CASE WHEN w.status IN ('Pending', 'Completed') THEN w.amount::numeric ELSE 0 END), 0) as should_be_usdt_total,
    COUNT(w.id) as withdrawal_count
FROM users u
LEFT JOIN withdrawals w ON LOWER(w.address) = LOWER(u.address)
    AND w.status IN ('Pending', 'Completed')
WHERE EXISTS (
    SELECT 1 FROM withdrawals w2 
    WHERE LOWER(w2.address) = LOWER(u.address) 
      AND w2.status IN ('Pending', 'Completed')
)
GROUP BY u.address, u.usdt_total
ORDER BY total_withdrawn DESC;
```

---

## ğŸ’‰ æ­¥éª¤6ï¼šæ‰¹é‡ä¿®å¤æ‰€æœ‰ç”¨æˆ·ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

### âš ï¸ è­¦å‘Šï¼šæ‰§è¡Œå‰è¯·ç¡®ä¿å·²å¤‡ä»½æ•°æ®ï¼

```sql
-- ğŸ”´ è­¦å‘Šï¼šæ­¤æ“ä½œå°†ä¿®æ”¹æ‰€æœ‰æœ‰æç°è®°å½•çš„ç”¨æˆ·æ•°æ®
-- ğŸ”´ æ‰§è¡Œå‰è¯·åŠ¡å¿…ç¡®è®¤å¤‡ä»½å®Œæˆ

-- æ‰¹é‡ä¿®å¤æ‰€æœ‰ç”¨æˆ·
UPDATE users u
SET 
    usdt_total = u.usdt_total + COALESCE(
        (SELECT SUM(w.amount::numeric) 
         FROM withdrawals w 
         WHERE LOWER(w.address) = LOWER(u.address)
           AND w.status IN ('Pending', 'Completed')),
        0
    ),
    updated_at = NOW()
WHERE EXISTS (
    SELECT 1 FROM withdrawals w 
    WHERE LOWER(w.address) = LOWER(u.address)
      AND w.status IN ('Pending', 'Completed')
);
```

---

## ğŸ“Š æ­¥éª¤7ï¼šéªŒè¯æ‰¹é‡ä¿®å¤ç»“æœ

```sql
-- ç»Ÿè®¡ä¿®å¤ç»“æœ
SELECT 
    COUNT(DISTINCT u.address) as affected_users,
    SUM(COALESCE(w_total.total, 0)) as total_compensated_amount
FROM users u
INNER JOIN (
    SELECT 
        address,
        SUM(amount::numeric) as total
    FROM withdrawals
    WHERE status IN ('Pending', 'Completed')
    GROUP BY address
) w_total ON LOWER(w_total.address) = LOWER(u.address);
```

---

## ğŸ¯ å¿«é€Ÿæ‰§è¡ŒæŒ‡å—

### å¯¹äºæµ‹è¯•è´¦å·ï¼ˆç«‹å³æ‰§è¡Œï¼‰

```sql
-- 1. å¤‡ä»½
CREATE TABLE IF NOT EXISTS users_backup_20260105 AS 
SELECT * FROM users WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');

-- 2. ä¿®å¤
UPDATE users u
SET 
    usdt_total = u.usdt_total + COALESCE(
        (SELECT SUM(w.amount::numeric) 
         FROM withdrawals w 
         WHERE LOWER(w.address) = LOWER(u.address)
           AND w.status IN ('Pending', 'Completed')),
        0
    ),
    updated_at = NOW()
WHERE LOWER(u.address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');

-- 3. éªŒè¯
SELECT 
    address,
    usdt_total,
    (SELECT SUM(amount::numeric) FROM withdrawals w WHERE LOWER(w.address) = LOWER(users.address) AND w.status IN ('Pending', 'Completed')) as total_withdrawn
FROM users 
WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');
```

---

## âœ… ä¿®å¤å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] **æ­¥éª¤1**ï¼šæŸ¥è¯¢æµ‹è¯•è´¦å·å½“å‰çŠ¶æ€
- [ ] **æ­¥éª¤2**ï¼šåˆ›å»ºå¤‡ä»½è¡¨
- [ ] **æ­¥éª¤3**ï¼šä¿®å¤æµ‹è¯•è´¦å·æ•°æ®
- [ ] **æ­¥éª¤4**ï¼šéªŒè¯ä¿®å¤ç»“æœï¼ˆæ•°æ®åº“ï¼‰
- [ ] **æ­¥éª¤5**ï¼šéªŒè¯å‰ç«¯æ˜¾ç¤ºï¼ˆçº¦ 38 USDTï¼‰
- [ ] **æ­¥éª¤6**ï¼šæŸ¥è¯¢æ‰€æœ‰å—å½±å“ç”¨æˆ·
- [ ] **æ­¥éª¤7**ï¼šæ‰¹é‡ä¿®å¤æ‰€æœ‰ç”¨æˆ·ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] **æ­¥éª¤8**ï¼šéªŒè¯æ‰¹é‡ä¿®å¤ç»“æœ
- [ ] **æ­¥éª¤9**ï¼šé€šçŸ¥ç”¨æˆ·å·²ä¿®å¤

---

## ğŸ“ ä¿®å¤è®°å½•

**æ‰§è¡Œæ—¶é—´**ï¼š____________

**æ‰§è¡Œäººå‘˜**ï¼š____________

**å—å½±å“ç”¨æˆ·æ•°**ï¼š____________

**è¡¥å¿æ€»é‡‘é¢**ï¼š____________ USDT

**å¤‡æ³¨**ï¼š____________

---

**è„šæœ¬åˆ›å»ºæ—¶é—´**ï¼š2026-01-05  
**é€‚ç”¨åœºæ™¯**ï¼šæ–¹æ¡ˆ2ä¿®å¤ï¼ˆusdt_total ä½œä¸ºä½™é¢ï¼‰  
**çŠ¶æ€**ï¼šâœ… å‡†å¤‡å°±ç»ª

