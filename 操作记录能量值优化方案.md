# æ“ä½œè®°å½•èƒ½é‡å€¼ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°

**ç”¨æˆ·åé¦ˆ**ï¼š
åœ¨ç”¨æˆ·ç®¡ç†é¡µé¢ä¸­ï¼Œæ¯æ¬¡éƒ½è¦ç­‰å¾…è·å–é“¾ä¸Šçš„å®æ—¶ä¿¡æ¯ï¼ˆæ˜¾ç¤º"é“¾ä¸ŠæŸ¥è¯¢ä¸­... / 1 èƒ½é‡å€¼"ï¼‰ï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒå·®ã€‚

**é—®é¢˜è¡¨ç°**ï¼š
- ç”¨æˆ·ç®¡ç†é¡µé¢æ˜¾ç¤º"é“¾ä¸ŠæŸ¥è¯¢ä¸­..."ï¼Œéœ€è¦ç­‰å¾…é“¾ä¸ŠæŸ¥è¯¢å®Œæˆ
- ä½œä¸ºåå°ç®¡ç†é¡µé¢ï¼Œæ²¡å¿…è¦å®æ—¶æ•°æ®
- æ¯æ¬¡åˆ·æ–°éƒ½è¦é‡æ–°æŸ¥è¯¢é“¾ä¸Šæ•°æ®ï¼Œå“åº”æ…¢

**âš ï¸ ä¸ºä»€ä¹ˆå¿…é¡»åºŸå¼ƒ"å®æ—¶æŸ¥é“¾"ï¼Ÿ**

å½“å‰é€»è¾‘ï¼šæ‰“å¼€é¡µé¢ â†’ å‰ç«¯å‘åŒºå—é“¾è¦æ•°æ® â†’ åŒºå—é“¾è¿”å› â†’ æ˜¾ç¤º

**è‡´å‘½é—®é¢˜**ï¼š
- âŒ **æ€§èƒ½é—®é¢˜**ï¼šå¦‚æœæœ‰ 1000 ä¸ªç”¨æˆ·ï¼Œå‰ç«¯å°±è¦å‘ 1000 ä¸ªè¯·æ±‚ï¼Œé¡µé¢ä¼šå¡æ­»
- âŒ **RPC èŠ‚ç‚¹é™åˆ¶**ï¼šå¤§é‡è¯·æ±‚ä¼šå¯¼è‡´ RPC èŠ‚ç‚¹ï¼ˆå¦‚ QuickNodeï¼‰å› è¯·æ±‚è¿‡å¤šè€Œ**å°ç¦ IP**
- âŒ **æˆæœ¬é—®é¢˜**ï¼šå¯èƒ½äº§ç”Ÿ**å·¨é¢è´¦å•**ï¼ˆæŒ‰è¯·æ±‚è®¡è´¹ï¼‰
- âŒ **ç”¨æˆ·ä½“éªŒå·®**ï¼šæ¯ä¸ªç”¨æˆ·ç­‰å¾… 1-5 ç§’ï¼Œ1000 ä¸ªç”¨æˆ·éœ€è¦ç­‰å¾…æ•°å°æ—¶

**ç»“è®º**ï¼šåå°åˆ—è¡¨é¡µ**ç»å¯¹ä¸èƒ½ç›´æ¥è¿åŒºå—é“¾**ï¼Œå¿…é¡»ä½¿ç”¨æ•°æ®åº“ç¼“å­˜ã€‚

---

## ğŸ” å½“å‰å®ç°åˆ†æ

### 1. å‰ç«¯å®ç°

**æ–‡ä»¶**: `rabbit-ai-admin/pages/Users.tsx`

**å½“å‰é€»è¾‘**ï¼š
- è°ƒç”¨ `getAdminUserList` API è·å–ç”¨æˆ·åˆ—è¡¨
- ç”¨æˆ·åˆ—è¡¨åŒ…å«ï¼š`address`, `energyTotal`, `energyLocked`, `inviteCount`, `referrer`, `registeredAt`, `lastActive`, `usdtBalance`
- **ä¸åŒ…å« RAT ä½™é¢ä¿¡æ¯**
- å‰ç«¯åœ¨è·å–ç”¨æˆ·åˆ—è¡¨åï¼Œå¼‚æ­¥è°ƒç”¨ `getRatBalance()` ä¸ºæ¯ä¸ªç”¨æˆ·æŸ¥è¯¢é“¾ä¸Šçš„ RAT ä½™é¢
- åœ¨ RAT ä½™é¢æŸ¥è¯¢å®Œæˆä¹‹å‰ï¼Œæ˜¾ç¤º"é“¾ä¸ŠæŸ¥è¯¢ä¸­..."

### 2. åç«¯å®ç°

**æ–‡ä»¶**: `rabbit-ai-backend/src/services/admin.ts` - `adminListUsers()`

**å½“å‰é€»è¾‘**ï¼š
```typescript
export async function adminListUsers(params: { limit: number; offset: number; search?: string }) {
  let query = supabase
    .from('users')
    .select('address,referrer_address,invite_count,energy_total,energy_locked,usdt_total,usdt_locked,created_at,updated_at', { count: 'exact' });
  
  // ... æœç´¢å’Œåˆ†é¡µé€»è¾‘ ...
  
  return {
    ok: true,
    items: (data || []).map((r: any) => ({
      address: r.address,
      energyTotal: Number(r.energy_total || 0),
      energyLocked: Number(r.energy_locked || 0),
      inviteCount: Number(r.invite_count || 0),
      referrer: r.referrer_address || null,
      registeredAt: r.created_at,
      lastActive: r.updated_at,
      usdtBalance: Number(r.usdt_total || 0) - Number(r.usdt_locked || 0),
    })),
    total: count || 0,
  };
}
```

**é—®é¢˜**ï¼š
- âŒ `users` è¡¨ä¸­æ²¡æœ‰ `rat_balance` å­—æ®µ
- âŒ å‰ç«¯éœ€è¦é€ä¸ªè°ƒç”¨é“¾ä¸Š API è·å– RAT ä½™é¢
- âŒ æ¯æ¬¡éƒ½è¦ç­‰å¾…é“¾ä¸ŠæŸ¥è¯¢ï¼Œå“åº”æ…¢ï¼ˆæ¯ä¸ªç”¨æˆ· 1-5 ç§’ï¼‰

### 3. æ•°æ®åº“ç»“æ„

**ç›¸å…³è¡¨**ï¼š
- `users` è¡¨ï¼šåŒ…å« `energy_total`ï¼ˆèƒ½é‡å€¼ï¼‰å­—æ®µï¼Œ**ä½†ä¸åŒ…å« RAT ä½™é¢å­—æ®µ**
- éœ€è¦æ·»åŠ  `rat_balance` å­—æ®µåˆ° `users` è¡¨ï¼Œæˆ–åˆ›å»ºç¼“å­˜è¡¨

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šåç«¯ JOIN æ•°æ®åº“ï¼ˆæ¨èï¼‰â­

**ä¼˜åŠ¿**ï¼š
- âœ… å“åº”é€Ÿåº¦å¿«ï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼Œæ— éœ€é“¾ä¸Šè°ƒç”¨ï¼‰
- âœ… æ•°æ®ä¸€è‡´æ€§å¥½ï¼ˆä½¿ç”¨æ•°æ®åº“ä¸­çš„èƒ½é‡å€¼ï¼‰
- âœ… å®ç°ç®€å•ï¼ˆåªéœ€ä¿®æ”¹åç«¯ SQL æŸ¥è¯¢ï¼‰
- âœ… é€‚åˆåå°ç®¡ç†é¡µé¢ï¼ˆä¸éœ€è¦å®æ—¶é“¾ä¸Šæ•°æ®ï¼‰

**å®ç°æ­¥éª¤**ï¼š

#### 1. æ•°æ®åº“è¿ç§»ï¼šæ·»åŠ  RAT ä½™é¢å­—æ®µ

**æ–‡ä»¶**: `rabbit-ai-backend/db/add_rat_balance_to_users.sql`

```sql
-- ğŸŸ¢ å…³é”®ï¼šä½¿ç”¨ TEXT ç±»å‹å­˜å‚¨ Wei å€¼ï¼Œé¿å…ç²¾åº¦ä¸¢å¤±
-- æˆ–è€…ä½¿ç”¨ DECIMAL(36, 18) å­˜å‚¨æ ¼å¼åŒ–åçš„å€¼
-- âš ï¸ ç»å¯¹ä¸è¦ä½¿ç”¨ FLOAT æˆ– DOUBLEï¼Œä¼šä¸¢å¤±ç²¾åº¦ï¼

-- æ–¹æ¡ˆ Aï¼šå­˜å‚¨ Wei å€¼ï¼ˆæ¨èï¼Œç²¾åº¦æœ€é«˜ï¼‰
ALTER TABLE public.users 
ADD COLUMN IF NOT EXISTS rat_balance_wei TEXT NOT NULL DEFAULT '0';

-- æ–¹æ¡ˆ Bï¼šå­˜å‚¨æ ¼å¼åŒ–åçš„å€¼ï¼ˆå¦‚æœç¡®å®šç²¾åº¦éœ€æ±‚ï¼‰
-- ALTER TABLE public.users 
-- ADD COLUMN IF NOT EXISTS rat_balance DECIMAL(36, 18) NOT NULL DEFAULT 0;

-- æ·»åŠ æ›´æ–°æ—¶é—´å­—æ®µï¼ˆç”¨äºè·Ÿè¸ªä½™é¢æ›´æ–°æ—¶é—´ï¼‰
ALTER TABLE public.users 
ADD COLUMN IF NOT EXISTS rat_balance_updated_at TIMESTAMPTZ;

-- æ·»åŠ ç´¢å¼•ï¼ˆå¦‚æœéœ€è¦æŒ‰ RAT ä½™é¢æ’åºï¼‰
-- æ³¨æ„ï¼šå¦‚æœä½¿ç”¨ TEXT ç±»å‹ï¼Œéœ€è¦è½¬æ¢ä¸ºæ•°å­—å†æ’åº
CREATE INDEX IF NOT EXISTS idx_users_rat_balance_updated ON public.users(rat_balance_updated_at DESC);
```

**âš ï¸ ç²¾åº¦é—®é¢˜è¯´æ˜**ï¼š
- âŒ **FLOAT/DOUBLE**ï¼šä¼šä¸¢å¤±ç²¾åº¦ï¼Œå¯¼è‡´ç®—è´¦æ—¶"å°‘äº†å‡ åˆ†é’±"
- âœ… **TEXT å­˜ Wei å€¼**ï¼šç²¾åº¦æœ€é«˜ï¼Œæ¨èæ–¹æ¡ˆ
- âœ… **DECIMAL(36, 18)**ï¼šå¦‚æœç¡®å®šç²¾åº¦éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨

#### 2. ä¿®æ”¹åç«¯æŸ¥è¯¢é€»è¾‘

**æ–‡ä»¶**: `rabbit-ai-backend/src/services/admin.ts`

```typescript
// âœ… ä¼˜åŒ–åçš„æŸ¥è¯¢é€»è¾‘
export async function adminListUsers(params: { limit: number; offset: number; search?: string }) {
  let query = supabase
    .from('users')
    .select('address,referrer_address,invite_count,energy_total,energy_locked,usdt_total,usdt_locked,rat_balance_wei,rat_balance_updated_at,created_at,updated_at', { count: 'exact' }); // ğŸŸ¢ æ–°å¢ï¼šrat_balance_wei å­—æ®µ

  // æœç´¢åŠŸèƒ½ï¼šå¦‚æœæä¾›äº†æœç´¢è¯ï¼ŒæŒ‰åœ°å€æœç´¢
  if (params.search && params.search.trim()) {
    const searchTerm = params.search.trim().toLowerCase();
    query = query.ilike('address', `%${searchTerm}%`);
  }

  // æ’åºï¼šæŒ‰åˆ›å»ºæ—¶é—´å€’åº
  query = query.order('created_at', { ascending: false });

  // åˆ†é¡µ
  const from = params.offset;
  const to = from + params.limit - 1;
  query = query.range(from, to);

  const { data, error, count } = await query;
  if (error) throw error;

  return {
    ok: true,
    items: (data || []).map((r: any) => {
      // ğŸŸ¢ å°† Wei å€¼è½¬æ¢ä¸ºæ ¼å¼åŒ–åçš„æ•°å€¼ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
      const ratBalanceWei = r.rat_balance_wei || '0';
      const ratBalance = parseFloat(ethers.utils.formatEther(ratBalanceWei));
      
      return {
        address: r.address,
        energyTotal: Number(r.energy_total || 0),
        energyLocked: Number(r.energy_locked || 0),
        inviteCount: Number(r.invite_count || 0),
        referrer: r.referrer_address || null,
        registeredAt: r.created_at,
        lastActive: r.updated_at,
        usdtBalance: Number(r.usdt_total || 0) - Number(r.usdt_locked || 0),
        ratBalance: ratBalance, // ğŸŸ¢ æ–°å¢ï¼šRAT ä½™é¢ï¼ˆæ ¼å¼åŒ–åçš„å€¼ï¼‰
        ratBalanceWei: ratBalanceWei, // ğŸŸ¢ æ–°å¢ï¼šWei å€¼ï¼ˆç”¨äºç²¾ç¡®è®¡ç®—ï¼‰
        ratBalanceUpdatedAt: r.rat_balance_updated_at, // ğŸŸ¢ æ–°å¢ï¼šæ›´æ–°æ—¶é—´
      };
    }),
    total: count || 0,
  };
}
```

#### 3. åˆ›å»º RAT ä½™é¢åŒæ­¥æœåŠ¡ï¼ˆäº‹ä»¶é©±åŠ¨ + å®šæ—¶å…œåº•ï¼‰

**æ–‡ä»¶**: `rabbit-ai-backend/src/services/ratBalanceSync.ts`

```typescript
/**
 * ğŸŸ¢ å…³é”®ç­–ç•¥ï¼šäº‹ä»¶é©±åŠ¨ + å®šæ—¶å…œåº•
 * 
 * äº‹ä»¶é©±åŠ¨ï¼šæ¯å½“ç”¨æˆ· Claim æˆåŠŸã€æç°æˆåŠŸã€æˆ–æ‰‹åŠ¨ä¿®æ”¹æ•°æ®æ—¶ï¼Œç«‹å³åŒæ­¥è¯¥ç”¨æˆ·
 * å®šæ—¶å…œåº•ï¼šæ¯å¤©å‡Œæ™¨å…¨é‡åŒæ­¥ï¼Œæ ¡å‡†æ•°æ®
 */

/**
 * åŒæ­¥å•ä¸ªç”¨æˆ·çš„ RAT ä½™é¢ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰
 * åœ¨ä»¥ä¸‹åœºæ™¯è°ƒç”¨ï¼š
 * 1. ç”¨æˆ· Claim æˆåŠŸå
 * 2. ç”¨æˆ·æç°æˆåŠŸå
 * 3. ç®¡ç†å‘˜æ‰‹åŠ¨ä¿®æ”¹ç”¨æˆ·æ•°æ®å
 */
export async function syncSingleUserRatBalance(
  provider: ethers.providers.Provider,
  address: string
) {
  try {
    const ratContract = new ethers.Contract(CONTRACTS.RAT_TOKEN, ABIS.ERC20, provider);
    const balanceWei = await ratContract.balanceOf(address);
    
    // ğŸŸ¢ å­˜å‚¨ Wei å€¼ï¼ˆTEXT ç±»å‹ï¼‰ï¼Œé¿å…ç²¾åº¦ä¸¢å¤±
    const balanceWeiString = balanceWei.toString();
    
    const { error } = await supabase
      .from('users')
      .update({
        rat_balance_wei: balanceWeiString, // å­˜å‚¨ Wei å€¼
        rat_balance_updated_at: new Date().toISOString(),
      })
      .eq('address', address.toLowerCase());
    
    if (error) throw error;
    
    console.log(`[RAT Balance Sync] Updated ${address}: ${balanceWeiString} Wei`);
    return { ok: true, balanceWei: balanceWeiString };
  } catch (e) {
    console.error(`[RAT Balance Sync] Failed to sync ${address}:`, e);
    throw e;
  }
}

/**
 * æ‰¹é‡æ›´æ–°æ‰€æœ‰ç”¨æˆ·çš„ RAT ä½™é¢ï¼ˆå®šæ—¶å…œåº•ï¼‰
 * å»ºè®®æ¯å¤©å‡Œæ™¨æ‰§è¡Œä¸€æ¬¡ï¼Œæ ¡å‡†æ•°æ®
 */
export async function syncAllRatBalances(provider: ethers.providers.Provider) {
  console.log('[RAT Balance Sync] Starting full sync...');
  
  // è·å–æ‰€æœ‰ç”¨æˆ·åœ°å€
  const { data: users, error } = await supabase
    .from('users')
    .select('address');
  
  if (error) throw error;
  
  if (!users || users.length === 0) {
    console.log('[RAT Balance Sync] No users found');
    return { ok: true, updated: 0 };
  }
  
  // ğŸŸ¢ æ‰¹é‡æŸ¥è¯¢é“¾ä¸Š RAT ä½™é¢ï¼ˆä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–æ€§èƒ½ï¼‰
  const ratContract = new ethers.Contract(CONTRACTS.RAT_TOKEN, ABIS.ERC20, provider);
  
  // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…ä¸€æ¬¡æ€§æŸ¥è¯¢è¿‡å¤š
  const batchSize = 50;
  let updatedCount = 0;
  
  for (let i = 0; i < users.length; i += batchSize) {
    const batch = users.slice(i, i + batchSize);
    
    const balancePromises = batch.map(async (user: any) => {
      try {
        const balanceWei = await ratContract.balanceOf(user.address);
        return {
          address: user.address,
          balanceWei: balanceWei.toString(), // å­˜å‚¨ Wei å€¼
        };
      } catch (e) {
        console.error(`Failed to fetch RAT balance for ${user.address}:`, e);
        return {
          address: user.address,
          balanceWei: '0',
        };
      }
    });
    
    const balances = await Promise.allSettled(balancePromises);
    
    // æ‰¹é‡æ›´æ–°æ•°æ®åº“
    const updates = balances.map((result) => {
      if (result.status === 'fulfilled') {
        return supabase
          .from('users')
          .update({
            rat_balance_wei: result.value.balanceWei,
            rat_balance_updated_at: new Date().toISOString(),
          })
          .eq('address', result.value.address);
      }
      return null;
    }).filter(Boolean);
    
    await Promise.all(updates);
    updatedCount += updates.length;
    
    console.log(`[RAT Balance Sync] Processed ${i + batch.length}/${users.length} users`);
    
    // é¿å…è¯·æ±‚è¿‡å¿«ï¼Œæ¯æ‰¹ä¹‹é—´ç¨ä½œå»¶è¿Ÿ
    if (i + batchSize < users.length) {
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }
  
  console.log(`[RAT Balance Sync] Full sync completed. Updated ${updatedCount} users`);
  return { ok: true, updated: updatedCount };
}
```

#### 4. åœ¨å…³é”®äº‹ä»¶ä¸­è§¦å‘å•ç”¨æˆ·åŒæ­¥

**æ–‡ä»¶**: `rabbit-ai-backend/src/services/admin.ts` æˆ–ç›¸å…³æœåŠ¡æ–‡ä»¶

```typescript
// ğŸŸ¢ åœ¨ç”¨æˆ· Claim æˆåŠŸåè§¦å‘åŒæ­¥
export async function processClaim(...) {
  // ... å¤„ç† Claim é€»è¾‘ ...
  
  // åŒæ­¥è¯¥ç”¨æˆ·çš„ RAT ä½™é¢
  try {
    await syncSingleUserRatBalance(provider, address);
  } catch (e) {
    console.error('Failed to sync RAT balance after claim:', e);
    // ä¸é˜»å¡ä¸»æµç¨‹ï¼Œè®°å½•é”™è¯¯å³å¯
  }
}

// ğŸŸ¢ åœ¨ç”¨æˆ·æç°æˆåŠŸåè§¦å‘åŒæ­¥
export async function completeWithdrawal(...) {
  // ... å¤„ç†æç°é€»è¾‘ ...
  
  // åŒæ­¥è¯¥ç”¨æˆ·çš„ RAT ä½™é¢
  try {
    await syncSingleUserRatBalance(provider, address);
  } catch (e) {
    console.error('Failed to sync RAT balance after withdrawal:', e);
  }
}

// ğŸŸ¢ åœ¨ç®¡ç†å‘˜æ‰‹åŠ¨ä¿®æ”¹ç”¨æˆ·æ•°æ®åè§¦å‘åŒæ­¥
export async function adjustUserAsset(...) {
  // ... å¤„ç†èµ„äº§è°ƒæ•´é€»è¾‘ ...
  
  // å¦‚æœè°ƒæ•´çš„æ˜¯ RATï¼ŒåŒæ­¥è¯¥ç”¨æˆ·çš„ RAT ä½™é¢
  if (asset === 'RAT') {
    try {
      await syncSingleUserRatBalance(provider, address);
    } catch (e) {
      console.error('Failed to sync RAT balance after adjustment:', e);
    }
  }
}
```

#### 4. æ›´æ–°å‰ç«¯ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `rabbit-ai-admin/types.ts`

```typescript
export interface User {
  address: string;
  energyTotal: number;
  energyLocked: number;
  inviteCount: number;
  referrer: string | null;
  registeredAt: string;
  lastActive: string;
  usdtBalance: number;
  ratBalance?: number; // ğŸŸ¢ æ–°å¢ï¼šRAT ä½™é¢å­—æ®µ
  ratBalanceUpdatedAt?: string; // ğŸŸ¢ æ–°å¢ï¼šæ›´æ–°æ—¶é—´å­—æ®µ
}
```

#### 5. æ›´æ–°å‰ç«¯æ˜¾ç¤ºé€»è¾‘

**æ–‡ä»¶**: `rabbit-ai-admin/pages/Users.tsx`

```typescript
// âœ… ä¼˜åŒ–åçš„æ˜¾ç¤ºé€»è¾‘ï¼ˆç§»é™¤é“¾ä¸ŠæŸ¥è¯¢ï¼‰
const fetchUsers = async (isRefresh = false) => {
  if (!isRefresh) {
    setLoading(true);
  }
  try {
    const data = await getAdminUserList({
      limit: 100,
      offset: 0,
      search: searchTerm || undefined,
    });
    
    // ğŸŸ¢ ä¼˜åŒ–ï¼šç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„ RAT ä½™é¢ï¼Œæ— éœ€é“¾ä¸ŠæŸ¥è¯¢
    const usersList = data.items.map((item) => ({
      address: item.address,
      energyTotal: item.energyTotal,
      energyLocked: item.energyLocked,
      inviteCount: item.inviteCount,
      referrer: item.referrer,
      registeredAt: new Date(item.registeredAt).toLocaleString(),
      lastActive: new Date(item.lastActive).toLocaleString(),
      usdtBalance: item.usdtBalance,
      ratBalance: item.ratBalance || 0, // ğŸŸ¢ ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„å€¼
      ratLocked: 0,
    }));
    
    setUsers(usersList);
    setLoading(false);
    setIsInitialLoad(false);
    
    // ğŸŸ¢ ç§»é™¤ï¼šä¸å†éœ€è¦å¼‚æ­¥æŸ¥è¯¢é“¾ä¸Š RAT ä½™é¢
  } catch (e: any) {
    console.error(e);
    showNotification('error', `è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${e?.message || 'æœªçŸ¥é”™è¯¯'}`);
  } finally {
    setLoading(false);
    setIsInitialLoad(false);
  }
};

// âœ… ä¼˜åŒ–åçš„æ˜¾ç¤ºé€»è¾‘
<td className="px-6 py-4">
  <div className="flex items-center gap-2">
    <Gem size={12} className="text-emerald-500" />
    <span className="text-sm font-black text-emerald-400">
      {user.ratBalance?.toLocaleString() || '0'}
    </span>
    <span className="text-[10px] text-zinc-600">/ {user.energyTotal} èƒ½é‡å€¼</span>
  </div>
</td>
```

**æ•ˆæœ**ï¼š
- âœ… ä¸å†æ˜¾ç¤º"é“¾ä¸ŠæŸ¥è¯¢ä¸­..."
- âœ… ç›´æ¥æ˜¾ç¤ºæ•°æ®åº“ä¸­çš„èƒ½é‡å€¼
- âœ… å“åº”é€Ÿåº¦å¿«ï¼Œæ— éœ€ç­‰å¾…é“¾ä¸ŠæŸ¥è¯¢

---

### æ–¹æ¡ˆ Bï¼šåç«¯ç¼“å­˜é“¾ä¸Šæ•°æ®ï¼ˆå¤‡é€‰ï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… æ•°æ®æ›´æ¥è¿‘å®æ—¶ï¼ˆå®šæœŸæ›´æ–°ï¼‰
- âœ… å‡å°‘é“¾ä¸ŠæŸ¥è¯¢æ¬¡æ•°

**åŠ£åŠ¿**ï¼š
- âŒ éœ€è¦é¢å¤–çš„ç¼“å­˜æœºåˆ¶
- âŒ å®ç°å¤æ‚åº¦è¾ƒé«˜
- âŒ ä»ç„¶éœ€è¦å®šæœŸé“¾ä¸ŠæŸ¥è¯¢

**å®ç°æ€è·¯**ï¼š
1. åç«¯å®šæœŸï¼ˆå¦‚æ¯å°æ—¶ï¼‰æ‰¹é‡æŸ¥è¯¢é“¾ä¸Š RAT ä½™é¢
2. å°†ç»“æœç¼“å­˜åˆ°æ•°æ®åº“æˆ– Redis
3. å‰ç«¯æŸ¥è¯¢æ—¶ä½¿ç”¨ç¼“å­˜æ•°æ®

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦æ›´æ¥è¿‘å®æ—¶çš„æ•°æ®
- æœ‰è¶³å¤Ÿçš„æœåŠ¡å™¨èµ„æºè¿›è¡Œå®šæœŸæŸ¥è¯¢

---

### æ–¹æ¡ˆ Cï¼šå‰ç«¯ç§»é™¤èƒ½é‡å€¼æ˜¾ç¤ºï¼ˆæœ€ç®€å•ï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… å®ç°æœ€ç®€å•ï¼ˆåªéœ€åˆ é™¤æ˜¾ç¤ºä»£ç ï¼‰
- âœ… å®Œå…¨æ¶ˆé™¤é“¾ä¸ŠæŸ¥è¯¢

**åŠ£åŠ¿**ï¼š
- âŒ å¤±å»èƒ½é‡å€¼ä¿¡æ¯å±•ç¤º
- âŒ å¯èƒ½å½±å“ç®¡ç†éœ€æ±‚

**é€‚ç”¨åœºæ™¯**ï¼š
- æ“ä½œè®°å½•é¡µé¢ä¸éœ€è¦æ˜¾ç¤ºèƒ½é‡å€¼
- èƒ½é‡å€¼ä¿¡æ¯åœ¨å…¶ä»–é¡µé¢ï¼ˆå¦‚ç”¨æˆ·ç®¡ç†é¡µé¢ï¼‰å·²æ˜¾ç¤º

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å“åº”é€Ÿåº¦ | å®ç°éš¾åº¦ | æ•°æ®å‡†ç¡®æ€§ | æ¨èåº¦ |
|------|---------|---------|-----------|--------|
| **æ–¹æ¡ˆ Aï¼šåç«¯ JOIN æ•°æ®åº“** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **æ–¹æ¡ˆ Bï¼šåç«¯ç¼“å­˜é“¾ä¸Šæ•°æ®** | â­â­â­â­ | â­â­ | â­â­â­â­â­ | â­â­â­ |
| **æ–¹æ¡ˆ Cï¼šç§»é™¤èƒ½é‡å€¼æ˜¾ç¤º** | â­â­â­â­â­ | â­â­â­â­â­ | N/A | â­â­ |

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

**æ¨èä½¿ç”¨æ–¹æ¡ˆ Aï¼šåç«¯ JOIN æ•°æ®åº“**

**ç†ç”±**ï¼š
1. âœ… **å“åº”é€Ÿåº¦å¿«**ï¼šæ•°æ®åº“æŸ¥è¯¢é€šå¸¸ < 100msï¼Œé“¾ä¸ŠæŸ¥è¯¢å¯èƒ½éœ€è¦ 1-5 ç§’
2. âœ… **å®ç°ç®€å•**ï¼šåªéœ€ä¿®æ”¹åç«¯ SQL æŸ¥è¯¢ï¼Œå‰ç«¯å‡ ä¹æ— éœ€æ”¹åŠ¨
3. âœ… **é€‚åˆåå°ç®¡ç†**ï¼šåå°ç®¡ç†é¡µé¢ä¸éœ€è¦å®æ—¶é“¾ä¸Šæ•°æ®ï¼Œæ•°æ®åº“ä¸­çš„æ•°æ®å·²è¶³å¤Ÿå‡†ç¡®
4. âœ… **ç”¨æˆ·ä½“éªŒå¥½**ï¼šæ¶ˆé™¤"é“¾ä¸ŠæŸ¥è¯¢ä¸­..."çš„ç­‰å¾…ï¼Œé¡µé¢åŠ è½½æ›´å¿«

---

## ğŸ”§ å®æ–½æ­¥éª¤

### é˜¶æ®µ 1ï¼šæ•°æ®åº“è¿ç§»ï¼ˆ30 åˆ†é’Ÿï¼‰

1. âœ… æ‰§è¡Œ SQL è¿ç§»ï¼Œæ·»åŠ  `rat_balance` å­—æ®µåˆ° `users` è¡¨
2. âœ… éªŒè¯å­—æ®µæ·»åŠ æˆåŠŸ

### é˜¶æ®µ 2ï¼šåç«¯ä¿®æ”¹ï¼ˆ2-3 å°æ—¶ï¼‰

1. âœ… ä¿®æ”¹ `adminListUsers()` å‡½æ•°ï¼Œæ·»åŠ  `rat_balance_wei` å­—æ®µåˆ°æŸ¥è¯¢
2. âœ… åœ¨è¿”å›æ•°æ®ä¸­æ·»åŠ  `ratBalance` å’Œ `ratBalanceWei` å­—æ®µ
3. âœ… åˆ›å»º `syncSingleUserRatBalance()` å‡½æ•°ï¼Œç”¨äºå•ç”¨æˆ·åŒæ­¥ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰
4. âœ… åˆ›å»º `syncAllRatBalances()` å‡½æ•°ï¼Œç”¨äºå…¨é‡åŒæ­¥ï¼ˆå®šæ—¶å…œåº•ï¼‰
5. âœ… åœ¨å…³é”®äº‹ä»¶ä¸­è§¦å‘å•ç”¨æˆ·åŒæ­¥ï¼š
   - ç”¨æˆ· Claim æˆåŠŸå
   - ç”¨æˆ·æç°æˆåŠŸå
   - ç®¡ç†å‘˜æ‰‹åŠ¨ä¿®æ”¹ç”¨æˆ·æ•°æ®å
6. âœ… è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆcron æˆ– scheduled jobï¼‰æ¯å¤©å‡Œæ™¨æ‰§è¡Œå…¨é‡åŒæ­¥
7. âœ… æµ‹è¯•åç«¯ API è¿”å›æ•°æ®

### é˜¶æ®µ 3ï¼šå‰ç«¯ä¿®æ”¹ï¼ˆ30 åˆ†é’Ÿï¼‰

1. âœ… æ›´æ–° `User` ç±»å‹å®šä¹‰ï¼Œæ·»åŠ  `ratBalance` å­—æ®µ
2. âœ… ä¿®æ”¹ `fetchUsers()` å‡½æ•°ï¼Œç§»é™¤é“¾ä¸ŠæŸ¥è¯¢é€»è¾‘
3. âœ… æ›´æ–°ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤ºé€»è¾‘ï¼Œç›´æ¥æ˜¾ç¤ºåç«¯è¿”å›çš„ RAT ä½™é¢
4. âœ… ç§»é™¤ `getRatBalance()` ç›¸å…³è°ƒç”¨

### é˜¶æ®µ 4ï¼šæµ‹è¯•éªŒè¯ï¼ˆ30 åˆ†é’Ÿï¼‰

1. âœ… æµ‹è¯•ç”¨æˆ·ç®¡ç†é¡µé¢åŠ è½½é€Ÿåº¦
2. âœ… éªŒè¯ RAT ä½™é¢æ˜¾ç¤ºæ­£ç¡®
3. âœ… ç¡®è®¤ä¸å†æ˜¾ç¤º"é“¾ä¸ŠæŸ¥è¯¢ä¸­..."
4. âœ… æµ‹è¯•å®šæœŸåŒæ­¥ä»»åŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - ğŸŸ¢ **äº‹ä»¶é©±åŠ¨åŒæ­¥**ï¼šåœ¨ç”¨æˆ· Claimã€æç°ã€æ‰‹åŠ¨ä¿®æ”¹åç«‹å³åŒæ­¥ï¼Œä¿è¯å…³é”®æ“ä½œåæ•°æ®å‡†ç¡®
   - ğŸŸ¢ **å®šæ—¶å…œåº•åŒæ­¥**ï¼šæ¯å¤©å‡Œæ™¨å…¨é‡åŒæ­¥ï¼Œæ ¡å‡†æ‰€æœ‰æ•°æ®
   - å¦‚æœç”¨æˆ·éœ€è¦å®æ—¶æ•°æ®ï¼Œå¯ä»¥æ·»åŠ "åˆ·æ–°"æŒ‰é’®æ‰‹åŠ¨è§¦å‘å•ç”¨æˆ·åŒæ­¥

2. **ç²¾åº¦é—®é¢˜**ï¼š
   - âš ï¸ **ç»å¯¹ä¸è¦ä½¿ç”¨ FLOAT/DOUBLE**ï¼šä¼šä¸¢å¤±ç²¾åº¦ï¼Œå¯¼è‡´ç®—è´¦æ—¶"å°‘äº†å‡ åˆ†é’±"
   - âœ… **æ¨èä½¿ç”¨ TEXT å­˜å‚¨ Wei å€¼**ï¼šç²¾åº¦æœ€é«˜ï¼Œä¾‹å¦‚ `"1000000000000000000"`
   - âœ… **æˆ–è€…ä½¿ç”¨ DECIMAL(36, 18)**ï¼šå¦‚æœç¡®å®šç²¾åº¦éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨
   - å‰ç«¯æ˜¾ç¤ºæ—¶ï¼Œä½¿ç”¨ `ethers.utils.formatEther()` è½¬æ¢ä¸ºæ ¼å¼åŒ–åçš„æ•°å€¼

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - JOIN æŸ¥è¯¢å¯èƒ½å½±å“æ€§èƒ½ï¼Œå»ºè®®æ·»åŠ ç´¢å¼•
   - å¦‚æœæ•°æ®é‡å¤§ï¼Œè€ƒè™‘åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

3. **å‘åå…¼å®¹**ï¼š
   - `energyTotal` å­—æ®µè®¾ä¸ºå¯é€‰ï¼ˆ`energyTotal?: number`ï¼‰
   - å¦‚æœåç«¯æœªè¿”å›ï¼Œå‰ç«¯æ˜¾ç¤º "N/A"

---

## âœ… é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
- âŒ æ˜¾ç¤º"é“¾ä¸ŠæŸ¥è¯¢ä¸­..."ï¼Œéœ€è¦ç­‰å¾… 1-5 ç§’
- âŒ æ¯æ¬¡åˆ·æ–°éƒ½è¦é‡æ–°æŸ¥è¯¢é“¾ä¸Šæ•°æ®
- âŒ ç”¨æˆ·ä½“éªŒå·®

### ä¿®å¤å
- âœ… ç›´æ¥æ˜¾ç¤ºæ•°æ®åº“ä¸­çš„èƒ½é‡å€¼ï¼Œå“åº” < 100ms
- âœ… æ— éœ€é“¾ä¸ŠæŸ¥è¯¢ï¼Œé¡µé¢åŠ è½½å¿«
- âœ… ç”¨æˆ·ä½“éªŒæ˜¾è‘—æ”¹å–„

---

---

## ğŸ¯ å…³é”®å®æ–½è¦ç‚¹æ€»ç»“

### 1. ä¸ºä»€ä¹ˆå¿…é¡»åºŸå¼ƒ"å®æ—¶æŸ¥é“¾"ï¼Ÿ
- âŒ 1000 ä¸ªç”¨æˆ· = 1000 ä¸ªè¯·æ±‚ï¼Œé¡µé¢ä¼šå¡æ­»
- âŒ RPC èŠ‚ç‚¹ä¼šå› è¯·æ±‚è¿‡å¤šè€Œ**å°ç¦ IP**
- âŒ å¯èƒ½äº§ç”Ÿ**å·¨é¢è´¦å•**ï¼ˆæŒ‰è¯·æ±‚è®¡è´¹ï¼‰
- âœ… **ç»“è®º**ï¼šåå°åˆ—è¡¨é¡µç»å¯¹ä¸èƒ½ç›´æ¥è¿åŒºå—é“¾

### 2. åŒæ­¥ç­–ç•¥ï¼šäº‹ä»¶é©±åŠ¨ + å®šæ—¶å…œåº•
- ğŸŸ¢ **äº‹ä»¶é©±åŠ¨**ï¼šç”¨æˆ· Claim/æç°/æ‰‹åŠ¨ä¿®æ”¹åç«‹å³åŒæ­¥è¯¥ç”¨æˆ·
- ğŸŸ¢ **å®šæ—¶å…œåº•**ï¼šæ¯å¤©å‡Œæ™¨å…¨é‡åŒæ­¥ï¼Œæ ¡å‡†æ‰€æœ‰æ•°æ®
- âœ… æ—¢ä¿è¯å…³é”®æ“ä½œåæ•°æ®å‡†ç¡®ï¼Œåˆé¿å…é¢‘ç¹å…¨é‡åŒæ­¥

### 3. æ•°æ®åº“ç²¾åº¦é—®é¢˜
- âŒ **ç»å¯¹ä¸è¦ç”¨ FLOAT/DOUBLE**ï¼šä¼šä¸¢å¤±ç²¾åº¦
- âœ… **æ¨èç”¨ TEXT å­˜ Wei å€¼**ï¼šç²¾åº¦æœ€é«˜
- âœ… **æˆ–è€…ç”¨ DECIMAL(36, 18)**ï¼šå¦‚æœç¡®å®šç²¾åº¦éœ€æ±‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**æ–¹æ¡ˆçŠ¶æ€**: âœ… å¾…å®æ–½  
**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆ Aï¼ˆæ•°æ®åº“å­˜å‚¨ + äº‹ä»¶é©±åŠ¨åŒæ­¥ + å®šæ—¶å…œåº•ï¼‰  
**é¢„è®¡å·¥ä½œé‡**: 3-4 å°æ—¶ï¼ˆåŒ…æ‹¬æ•°æ®åº“è¿ç§»ã€åç«¯ä¿®æ”¹ã€å‰ç«¯ä¿®æ”¹ã€å®šæ—¶ä»»åŠ¡è®¾ç½®ï¼‰

