# æç°èƒ½é‡å€¼æ‰£é™¤ç²¾åº¦é—®é¢˜å®¡æŸ¥æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

**é—®é¢˜ç°è±¡**ï¼š
- ç”¨æˆ·æç°åï¼Œèƒ½é‡å€¼æ˜¾ç¤ºä¸ºï¼š`56.099999999999994` âŒ
- èƒ½é‡å€¼åº”è¯¥æ˜¯æ•´æ•°ï¼Œä½†å‡ºç°äº†æµ®ç‚¹æ•°

**ç”¨æˆ·æ€€ç–‘**ï¼š
- æç° 1 USDT æ‰£é™¤ 10 ç‚¹èƒ½é‡å€¼ âœ…
- æç° 0.99 USDT æŒ‰æ¯”ä¾‹æ‰£é™¤ï¼š0.99 Ã— 10 = **9.9 ç‚¹èƒ½é‡å€¼** âš ï¸
- **9.9 æ˜¯æµ®ç‚¹æ•°ï¼Œè¿™å°±æ˜¯å¯¼è‡´èƒ½é‡å€¼å‡ºç°å°æ•°ä½çš„æ ¹æœ¬åŸå› ï¼**

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### 1. æç°èƒ½é‡å€¼æ‰£é™¤é€»è¾‘

**æ–‡ä»¶ä½ç½®**ï¼š`rabbit-ai-backend/src/services/withdraw.ts` ç¬¬ 101 è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```typescript
// âš ï¸ ä¸šåŠ¡è§„åˆ™ï¼ˆé£æ§å‚æ•°ï¼‰ï¼š
// 1. èƒ½é‡æ¶ˆè€—æ¯”ä¾‹ï¼š1 USDT = 10 Energyï¼ˆä¸æ˜¯ 1:1ï¼ï¼‰
// 2. æ‰€éœ€èƒ½é‡ = æç°é‡‘é¢ Ã— 10ï¼ˆå·²å–æ¶ˆæœ€ä½ 30 èƒ½é‡é—¨æ§›ï¼‰
const requiredEnergy = amount * 10;
```

**é—®é¢˜åˆ†æ**ï¼š

| æç°é‡‘é¢ | è®¡ç®—å…¬å¼ | æ‰€éœ€èƒ½é‡ | ç±»å‹ | çŠ¶æ€ |
|---------|---------|---------|------|------|
| 1.00 USDT | 1.00 Ã— 10 | 10 | æ•´æ•° | âœ… æ­£ç¡® |
| 0.99 USDT | 0.99 Ã— 10 | 9.9 | æµ®ç‚¹æ•° | âŒ é”™è¯¯ |
| 0.5 USDT | 0.5 Ã— 10 | 5 | æ•´æ•° | âœ… æ­£ç¡® |
| 0.33 USDT | 0.33 Ã— 10 | 3.3 | æµ®ç‚¹æ•° | âŒ é”™è¯¯ |
| 2.15 USDT | 2.15 Ã— 10 | 21.5 | æµ®ç‚¹æ•° | âŒ é”™è¯¯ |

**æ ¹æœ¬åŸå› **ï¼š
- âŒ `amount * 10` ç›´æ¥è®¡ç®—ï¼Œæ²¡æœ‰å–æ•´å¤„ç†
- âŒ å½“æç°é‡‘é¢æ˜¯ 0.99ã€0.33ã€2.15 ç­‰å°æ•°æ—¶ï¼Œ`requiredEnergy` å°±ä¼šæ˜¯æµ®ç‚¹æ•°
- âŒ æµ®ç‚¹æ•°ä¼šäº§ç”Ÿ JavaScript ç²¾åº¦é—®é¢˜ï¼ˆå¦‚ 56.099999999999994ï¼‰

### 2. èƒ½é‡å€¼é”å®šé€»è¾‘

**æ–‡ä»¶ä½ç½®**ï¼š`rabbit-ai-backend/src/services/withdraw.ts` ç¬¬ 109 è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```typescript
const newEnergyLocked = energyLocked + requiredEnergy;
```

**é—®é¢˜åˆ†æ**ï¼š
- `requiredEnergy` å¦‚æœæ˜¯ 9.9ï¼ˆæµ®ç‚¹æ•°ï¼‰
- `energyLocked` åŸæœ¬æ˜¯ 46.2ï¼ˆä¹‹å‰ç´¯ç§¯çš„æµ®ç‚¹æ•°ï¼‰
- `newEnergyLocked` = 46.2 + 9.9 = 56.1 âš ï¸
- JavaScript æµ®ç‚¹æ•°è¿ç®—ï¼š46.2 + 9.9 = 56.099999999999994 âŒ

### 3. èƒ½é‡å€¼æ‰£é™¤é€»è¾‘

**æ–‡ä»¶ä½ç½®**ï¼š`rabbit-ai-backend/src/services/admin.ts` ç¬¬ 454 è¡Œ

**ä»£ç **ï¼š
```typescript
const nextEnergyTotal = Math.max(0, u.energyTotal - energyLockedAmount);
```

**é—®é¢˜åˆ†æ**ï¼š
- `energyLockedAmount` æ˜¯ä»æ•°æ®åº“è¯»å–çš„ `energy_locked_amount`
- å¦‚æœæç°æ—¶å­˜å‚¨çš„æ˜¯ 9.9ï¼Œè¿™é‡Œä¹Ÿä¼šä½¿ç”¨ 9.9 è¿›è¡Œæ‰£é™¤
- æœ€ç»ˆå¯¼è‡´ `energyTotal` ä¹Ÿå˜æˆæµ®ç‚¹æ•°

---

## ğŸ” æ•°æ®æµè¿½è¸ª

### æç°æµç¨‹ä¸­çš„èƒ½é‡å€¼å˜åŒ–

**æ­¥éª¤ 1ï¼šç”¨æˆ·ç”³è¯·æç° 0.99 USDT**

```typescript
// rabbit-ai-backend/src/services/withdraw.ts ç¬¬ 101 è¡Œ
const requiredEnergy = 0.99 * 10; // = 9.9 âŒ æµ®ç‚¹æ•°
```

**æ­¥éª¤ 2ï¼šé”å®šèƒ½é‡å€¼**

```typescript
// rabbit-ai-backend/src/services/withdraw.ts ç¬¬ 109 è¡Œ
const newEnergyLocked = 46.2 + 9.9; // = 56.099999999999994 âŒ
```

**æ­¥éª¤ 3ï¼šåˆ›å»ºæç°è®°å½•**

```typescript
// rabbit-ai-backend/src/services/withdraw.ts ç¬¬ 167-176 è¡Œ
await supabase.from('withdrawals').insert({
  address: addr,
  amount: 0.99,
  status: 'Pending',
  energy_locked_amount: 9.9, // âŒ å­˜å‚¨äº†æµ®ç‚¹æ•°
  // ...
});
```

**æ­¥éª¤ 4ï¼šå®Œæˆæç°ï¼Œæ‰£é™¤èƒ½é‡å€¼**

```typescript
// rabbit-ai-backend/src/services/admin.ts ç¬¬ 454 è¡Œ
const nextEnergyTotal = 66.1 - 9.9; // = 56.199999999999996 âŒ
```

**ç»“æœ**ï¼š
- æ•°æ®åº“ä¸­çš„ `energy_total` = 56.199999999999996
- å‰ç«¯æ˜¾ç¤ºï¼š`56.099999999999994` æˆ– `56.199999999999996`

---

## ğŸ“Š é—®é¢˜å½±å“èŒƒå›´

### 1. å—å½±å“çš„åœºæ™¯

| åœºæ™¯ | æç°é‡‘é¢ | æ‰€éœ€èƒ½é‡ | é—®é¢˜ |
|-----|---------|---------|------|
| âœ… æ•´æ•°æç° | 1.0, 2.0, 3.0 USDT | 10, 20, 30 | ä¸å—å½±å“ |
| âœ… 0.5 å€æ•°æç° | 0.5, 1.5, 2.5 USDT | 5, 15, 25 | ä¸å—å½±å“ |
| âŒ å…¶ä»–å°æ•°æç° | 0.99, 0.33, 2.15 USDT | 9.9, 3.3, 21.5 | **å—å½±å“** |

### 2. æ•°æ®åº“æ•°æ®

**æŸ¥è¯¢å—å½±å“çš„æç°è®°å½•**ï¼š
```sql
SELECT 
  id, 
  address, 
  amount, 
  energy_locked_amount,
  status,
  created_at
FROM withdrawals
WHERE energy_locked_amount != FLOOR(energy_locked_amount)
ORDER BY created_at DESC;
```

**æŸ¥è¯¢å—å½±å“çš„ç”¨æˆ·**ï¼š
```sql
SELECT 
  address,
  energy_total,
  energy_locked,
  created_at,
  updated_at
FROM users
WHERE energy_total != FLOOR(energy_total) 
   OR energy_locked != FLOOR(energy_locked);
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šå‘ä¸Šå–æ•´ï¼ˆæ¨èï¼‰

**ä¿®å¤æ€è·¯**ï¼š
- ä½¿ç”¨ `Math.ceil()` å‘ä¸Šå–æ•´
- ç¡®ä¿èƒ½é‡å€¼æ‰£é™¤**ä¸å°‘äº**æ‰€éœ€èƒ½é‡
- å¯¹ç”¨æˆ·ç¨å¾®ä¸¥æ ¼ä¸€ç‚¹ï¼ˆå¤šæ‰£ 1 ç‚¹èƒ½é‡ï¼‰

**ä¿®å¤ä»£ç **ï¼š

```typescript
// rabbit-ai-backend/src/services/withdraw.ts ç¬¬ 101 è¡Œ
// ä¿®æ”¹å‰
const requiredEnergy = amount * 10;

// ä¿®æ”¹å
const requiredEnergy = Math.ceil(amount * 10);
```

**ç¤ºä¾‹**ï¼š
- æç° 1.00 USDTï¼š`Math.ceil(1.00 * 10)` = 10 âœ…
- æç° 0.99 USDTï¼š`Math.ceil(0.99 * 10)` = 10 âœ…ï¼ˆå‘ä¸Šå–æ•´ï¼‰
- æç° 0.5 USDTï¼š`Math.ceil(0.5 * 10)` = 5 âœ…
- æç° 0.33 USDTï¼š`Math.ceil(0.33 * 10)` = 4 âœ…ï¼ˆå‘ä¸Šå–æ•´ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… ç¡®ä¿èƒ½é‡å€¼å§‹ç»ˆæ˜¯æ•´æ•°
- âœ… å¯¹ç”¨æˆ·ç¨å¾®ä¸¥æ ¼ä¸€ç‚¹ï¼ˆå¤šæ‰£ 1 ç‚¹èƒ½é‡ï¼Œé˜²æ­¢æ»¥ç”¨ï¼‰
- âœ… ç¬¦åˆé£æ§åŸåˆ™

**ç¼ºç‚¹**ï¼š
- âš ï¸ å¯¹ç”¨æˆ·ç¨å¾®ä¸åˆ©ï¼ˆ0.99 USDT æ‰£ 10 ç‚¹èƒ½é‡ï¼Œè€Œä¸æ˜¯ 9.9ï¼‰

---

### æ–¹æ¡ˆ 2ï¼šå‘ä¸‹å–æ•´

**ä¿®å¤æ€è·¯**ï¼š
- ä½¿ç”¨ `Math.floor()` å‘ä¸‹å–æ•´
- ç¡®ä¿èƒ½é‡å€¼æ‰£é™¤**ä¸å¤šäº**æ‰€éœ€èƒ½é‡
- å¯¹ç”¨æˆ·æ›´å‹å¥½

**ä¿®å¤ä»£ç **ï¼š

```typescript
// rabbit-ai-backend/src/services/withdraw.ts ç¬¬ 101 è¡Œ
// ä¿®æ”¹å‰
const requiredEnergy = amount * 10;

// ä¿®æ”¹å
const requiredEnergy = Math.floor(amount * 10);
```

**ç¤ºä¾‹**ï¼š
- æç° 1.00 USDTï¼š`Math.floor(1.00 * 10)` = 10 âœ…
- æç° 0.99 USDTï¼š`Math.floor(0.99 * 10)` = 9 âœ…ï¼ˆå‘ä¸‹å–æ•´ï¼‰
- æç° 0.5 USDTï¼š`Math.floor(0.5 * 10)` = 5 âœ…
- æç° 0.33 USDTï¼š`Math.floor(0.33 * 10)` = 3 âœ…ï¼ˆå‘ä¸‹å–æ•´ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… ç¡®ä¿èƒ½é‡å€¼å§‹ç»ˆæ˜¯æ•´æ•°
- âœ… å¯¹ç”¨æˆ·æ›´å‹å¥½ï¼ˆå°‘æ‰£ 1 ç‚¹èƒ½é‡ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ å¯èƒ½è¢«æ»¥ç”¨ï¼ˆç”¨æˆ·å¯ä»¥é€šè¿‡æç° 0.99 USDT æ¥èŠ‚çœèƒ½é‡ï¼‰

---

### æ–¹æ¡ˆ 3ï¼šå››èˆäº”å…¥

**ä¿®å¤æ€è·¯**ï¼š
- ä½¿ç”¨ `Math.round()` å››èˆäº”å…¥
- æœ€æ¥è¿‘å®é™…æ‰€éœ€èƒ½é‡

**ä¿®å¤ä»£ç **ï¼š

```typescript
// rabbit-ai-backend/src/services/withdraw.ts ç¬¬ 101 è¡Œ
// ä¿®æ”¹å‰
const requiredEnergy = amount * 10;

// ä¿®æ”¹å
const requiredEnergy = Math.round(amount * 10);
```

**ç¤ºä¾‹**ï¼š
- æç° 1.00 USDTï¼š`Math.round(1.00 * 10)` = 10 âœ…
- æç° 0.99 USDTï¼š`Math.round(0.99 * 10)` = 10 âœ…ï¼ˆå››èˆäº”å…¥ï¼‰
- æç° 0.94 USDTï¼š`Math.round(0.94 * 10)` = 9 âœ…ï¼ˆå››èˆäº”å…¥ï¼‰
- æç° 0.5 USDTï¼š`Math.round(0.5 * 10)` = 5 âœ…

**ä¼˜ç‚¹**ï¼š
- âœ… ç¡®ä¿èƒ½é‡å€¼å§‹ç»ˆæ˜¯æ•´æ•°
- âœ… æœ€æ¥è¿‘å®é™…æ‰€éœ€èƒ½é‡

**ç¼ºç‚¹**ï¼š
- âš ï¸ è§„åˆ™ä¸å¤Ÿæ˜ç¡®ï¼ˆæœ‰æ—¶å‘ä¸Šï¼Œæœ‰æ—¶å‘ä¸‹ï¼‰

---

## ğŸ¯ æ¨èä¿®å¤æ–¹æ¡ˆ

**æ¨èä½¿ç”¨æ–¹æ¡ˆ 1ï¼šå‘ä¸Šå–æ•´ï¼ˆMath.ceilï¼‰**

**åŸå› **ï¼š
1. âœ… ç¡®ä¿èƒ½é‡å€¼å§‹ç»ˆæ˜¯æ•´æ•°
2. âœ… ç¬¦åˆé£æ§åŸåˆ™ï¼ˆå®å¯å¤šæ‰£ï¼Œä¸èƒ½å°‘æ‰£ï¼‰
3. âœ… é˜²æ­¢ç”¨æˆ·é€šè¿‡æç°å°æ•°é‡‘é¢æ¥èŠ‚çœèƒ½é‡
4. âœ… è§„åˆ™æ¸…æ™°ï¼šæç° X USDTï¼Œæ‰£é™¤ `âŒˆX Ã— 10âŒ‰` ç‚¹èƒ½é‡

**ä¸šåŠ¡è§„åˆ™æ›´æ–°**ï¼š
- **æ—§è§„åˆ™**ï¼šæç° X USDTï¼Œæ‰£é™¤ `X Ã— 10` ç‚¹èƒ½é‡
- **æ–°è§„åˆ™**ï¼šæç° X USDTï¼Œæ‰£é™¤ `âŒˆX Ã— 10âŒ‰` ç‚¹èƒ½é‡ï¼ˆå‘ä¸Šå–æ•´ï¼‰

**ç¤ºä¾‹**ï¼š
- æç° 1.00 USDT â†’ æ‰£é™¤ 10 ç‚¹èƒ½é‡
- æç° 0.99 USDT â†’ æ‰£é™¤ 10 ç‚¹èƒ½é‡
- æç° 0.5 USDT â†’ æ‰£é™¤ 5 ç‚¹èƒ½é‡
- æç° 0.33 USDT â†’ æ‰£é™¤ 4 ç‚¹èƒ½é‡

---

## ğŸ”§ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

**åç«¯**ï¼š
- `rabbit-ai-backend/src/services/withdraw.ts` - ä¿®æ”¹ç¬¬ 101 è¡Œ

**ä¿®æ”¹å†…å®¹**ï¼š
```typescript
// ä¿®æ”¹å‰
const requiredEnergy = amount * 10;

// ä¿®æ”¹å
const requiredEnergy = Math.ceil(amount * 10);
```

---

## ğŸ“ æ•°æ®æ¸…ç†å»ºè®®

### 1. æ¸…ç†ç°æœ‰æµ®ç‚¹æ•°æ•°æ®

**SQL è„šæœ¬**ï¼š
```sql
-- æ¸…ç† users è¡¨ä¸­çš„æµ®ç‚¹æ•°èƒ½é‡å€¼
UPDATE users
SET 
  energy_total = FLOOR(energy_total),
  energy_locked = FLOOR(energy_locked),
  updated_at = NOW()
WHERE energy_total != FLOOR(energy_total) 
   OR energy_locked != FLOOR(energy_locked);

-- æ¸…ç† withdrawals è¡¨ä¸­çš„æµ®ç‚¹æ•°èƒ½é‡å€¼
UPDATE withdrawals
SET 
  energy_locked_amount = CEIL(energy_locked_amount)
WHERE energy_locked_amount != FLOOR(energy_locked_amount);
```

### 2. éªŒè¯æ¸…ç†ç»“æœ

**SQL è„šæœ¬**ï¼š
```sql
-- éªŒè¯ users è¡¨
SELECT COUNT(*) as count
FROM users
WHERE energy_total != FLOOR(energy_total) 
   OR energy_locked != FLOOR(energy_locked);
-- åº”è¯¥è¿”å› 0

-- éªŒè¯ withdrawals è¡¨
SELECT COUNT(*) as count
FROM withdrawals
WHERE energy_locked_amount != FLOOR(energy_locked_amount);
-- åº”è¯¥è¿”å› 0
```

---

## ğŸ‰ ä¿®å¤åçš„æ•ˆæœ

### ä¿®å¤å‰

**æç° 0.99 USDT**ï¼š
1. `requiredEnergy = 0.99 * 10 = 9.9` âŒ
2. `newEnergyLocked = 46.2 + 9.9 = 56.099999999999994` âŒ
3. å‰ç«¯æ˜¾ç¤ºï¼š`56.099999999999994 âš¡` âŒ

### ä¿®å¤å

**æç° 0.99 USDT**ï¼š
1. `requiredEnergy = Math.ceil(0.99 * 10) = 10` âœ…
2. `newEnergyLocked = 46 + 10 = 56` âœ…
3. å‰ç«¯æ˜¾ç¤ºï¼š`56 âš¡` âœ…

---

## ğŸ“Š å½±å“è¯„ä¼°

### 1. å¯¹ç°æœ‰ç”¨æˆ·çš„å½±å“

- âœ… **æ­£é¢å½±å“**ï¼šèƒ½é‡å€¼æ˜¾ç¤ºæ¢å¤æ­£å¸¸ï¼ˆæ•´æ•°ï¼‰
- âš ï¸ **è´Ÿé¢å½±å“**ï¼šæç°å°æ•°é‡‘é¢æ—¶ï¼Œå¯èƒ½å¤šæ‰£ 1 ç‚¹èƒ½é‡
- ğŸ“Š **å½±å“èŒƒå›´**ï¼šä»…å½±å“æç°å°æ•°é‡‘é¢çš„ç”¨æˆ·

### 2. å¯¹å†å²æ•°æ®çš„å½±å“

- âš ï¸ å†å²æ•°æ®ä¸­å·²ç»å­˜åœ¨æµ®ç‚¹æ•°èƒ½é‡å€¼
- âœ… éœ€è¦æ‰§è¡Œæ•°æ®æ¸…ç† SQL
- âœ… å‰ç«¯æ˜¾ç¤ºå·²ä¿®å¤ï¼ˆä½¿ç”¨ `Math.floor()` å–æ•´ï¼‰

### 3. å¯¹å‰ç«¯çš„å½±å“

- âœ… å‰ç«¯å·²ä¿®å¤ï¼ˆä½¿ç”¨ `Math.floor()` æ˜¾ç¤ºï¼‰
- âœ… å³ä½¿åç«¯è¿”å›æµ®ç‚¹æ•°ï¼Œå‰ç«¯ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤ºä¸ºæ•´æ•°

---

## âœ… æ£€æŸ¥æ¸…å•

- [ ] ä¿®æ”¹åç«¯ä»£ç ï¼š`rabbit-ai-backend/src/services/withdraw.ts` ç¬¬ 101 è¡Œ
- [ ] æµ‹è¯•æç°åŠŸèƒ½ï¼šæç° 0.99 USDTï¼ŒéªŒè¯æ‰£é™¤ 10 ç‚¹èƒ½é‡
- [ ] æµ‹è¯•æç°åŠŸèƒ½ï¼šæç° 0.33 USDTï¼ŒéªŒè¯æ‰£é™¤ 4 ç‚¹èƒ½é‡
- [ ] æ‰§è¡Œæ•°æ®æ¸…ç† SQLï¼Œæ¸…ç†ç°æœ‰æµ®ç‚¹æ•°æ•°æ®
- [ ] éªŒè¯æ¸…ç†ç»“æœï¼šç¡®ä¿æ‰€æœ‰èƒ½é‡å€¼éƒ½æ˜¯æ•´æ•°
- [ ] éªŒè¯å‰ç«¯æ˜¾ç¤ºï¼šç¡®ä¿èƒ½é‡å€¼æ˜¾ç¤ºä¸ºæ•´æ•°

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2026-01-05  
**é—®é¢˜çŠ¶æ€**ï¼šğŸ”´ å¾…ä¿®å¤  
**ä¼˜å…ˆçº§**ï¼šé«˜  
**å»ºè®®**ï¼šç«‹å³ä¿®å¤åç«¯èƒ½é‡å€¼è®¡ç®—é€»è¾‘

