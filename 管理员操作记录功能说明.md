# 管理员操作记录功能说明

## 📋 功能概述

在管理员后台的"操作记录"页面增加了 4 种新的记录类型，用于追踪管理员对用户资产的调整操作。

### 新增记录类型

1. **管理员赠送USDT** (`AddUSDT`)
2. **管理员扣除USDT** (`DeductUSDT`)
3. **管理员赠送能量值** (`AddEnergy`)
4. **管理员扣除能量值** (`DeductEnergy`)

---

## 🗄️ 数据库变更

### 新增表：`admin_operations`

```sql
CREATE TABLE admin_operations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  address TEXT NOT NULL,                     -- 用户地址
  operation_type TEXT NOT NULL,              -- 操作类型
  amount NUMERIC NOT NULL,                   -- 变化量（正数=增加，负数=减少）
  amount_before NUMERIC NOT NULL,            -- 操作前金额
  amount_after NUMERIC NOT NULL,             -- 操作后金额
  admin_address TEXT,                        -- 执行操作的管理员地址（可选）
  notes TEXT,                                -- 备注
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 索引

- `idx_admin_operations_address`: 按用户地址查询
- `idx_admin_operations_type`: 按操作类型筛选
- `idx_admin_operations_created_at`: 按时间排序

---

## 🔧 后端实现

### 1. 自动记录操作

当管理员调整用户资产时，系统会自动在 `admin_operations` 表中记录操作详情：

#### `adminAdjustUserEnergy` 函数

```typescript
// 🟢 新增：记录管理员操作
const operationType = delta > 0 ? 'AddEnergy' : 'DeductEnergy';
await supabase.from('admin_operations').insert({
  address: addr,
  operation_type: operationType,
  amount: delta,
  amount_before: u.energyTotal,
  amount_after: nextTotal,
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString(),
});
```

#### `adminAdjustUserUsdt` 函数

```typescript
// 🟢 新增：记录管理员操作
const operationType = delta > 0 ? 'AddUSDT' : 'DeductUSDT';
await supabase.from('admin_operations').insert({
  address: addr,
  operation_type: operationType,
  amount: delta,
  amount_before: u.usdtTotal,
  amount_after: nextTotal,
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString(),
});
```

### 2. 扩展 `getAdminOperations` API

新增了对 `admin_operations` 表的查询支持：

```typescript
// 3. 获取管理员操作记录
const adminOpTypes = ['AddUSDT', 'DeductUSDT', 'AddEnergy', 'DeductEnergy'];
if (type === 'all' || adminOpTypes.includes(type)) {
  let adminQuery = supabase
    .from('admin_operations')
    .select('id,address,operation_type,amount,amount_before,amount_after,created_at')
    .order('created_at', { ascending: false })
    .range(offset, offset + limit - 1);

  if (address) {
    adminQuery = adminQuery.eq('address', address);
  }

  if (type !== 'all') {
    adminQuery = adminQuery.eq('operation_type', type);
  }

  const { data: adminOps, error: aErr } = await adminQuery;
  if (aErr) throw aErr;

  (adminOps || []).forEach((a: any) => {
    operations.push({
      id: a.id,
      address: a.address,
      type: a.operation_type,
      amount: String(Math.abs(a.amount)), // 显示绝对值
      status: 'Success',
      timestamp: a.created_at,
      amountBefore: String(a.amount_before),
      amountAfter: String(a.amount_after),
    });
  });
}
```

---

## 🎨 前端实现

### 1. 类型定义扩展

```typescript
export interface OperationRecord {
  id: string;
  address: string;
  type: 'Withdrawal' | 'AirdropClaim' | 'AddUSDT' | 'DeductUSDT' | 'AddEnergy' | 'DeductEnergy';
  amount: string;
  status: 'Success' | 'Pending' | 'Failed' | 'Rejected';
  timestamp: string;
  txHash?: string;
  amountBefore?: string;  // 🟢 新增
  amountAfter?: string;   // 🟢 新增
}
```

### 2. 筛选下拉框

在"操作记录"页面的筛选下拉框中增加了 4 个新选项：

```tsx
<select value={typeFilter} onChange={(e) => setTypeFilter(e.target.value as any)}>
  <option value="all">所有类型</option>
  <option value="Withdrawal">USDT 提现</option>
  <option value="AirdropClaim">空投领取</option>
  <option value="AddUSDT">管理员赠送USDT</option>
  <option value="DeductUSDT">管理员扣除USDT</option>
  <option value="AddEnergy">管理员赠送能量值</option>
  <option value="DeductEnergy">管理员扣除能量值</option>
</select>
```

### 3. 操作类型显示

每种操作类型都有独特的图标和颜色：

| 操作类型 | 图标 | 颜色 | 显示文字 |
|---------|------|------|---------|
| `AddUSDT` | ➕ Plus | 蓝色 `text-blue-400` | 赠送USDT |
| `DeductUSDT` | ➖ Minus | 橙色 `text-orange-400` | 扣除USDT |
| `AddEnergy` | ➕ Plus | 紫色 `text-purple-400` | 赠送能量值 |
| `DeductEnergy` | ➖ Minus | 粉色 `text-pink-400` | 扣除能量值 |

### 4. 金额显示

管理员操作记录会显示：
- **操作金额**：变化的数值（绝对值）
- **单位**：USDT 或 能量
- **变化详情**：`操作前金额 → 操作后金额`

```tsx
<div className="space-y-0.5">
  <span className={`text-sm font-black ${color}`}>
    {rec.amount}
    {rec.type.includes('USDT') ? ' USDT' : rec.type.includes('Energy') ? ' 能量' : ''}
  </span>
  {rec.amountBefore !== undefined && rec.amountAfter !== undefined && (
    <div className="text-[10px] text-zinc-600">
      {rec.amountBefore} → {rec.amountAfter}
    </div>
  )}
</div>
```

---

## 📊 使用场景

### 场景 1：管理员赠送USDT

1. 管理员在"用户管理"页面选择用户，点击"调整USDT"
2. 输入正数金额（如 `+10`）
3. 系统执行 `adminAdjustUserUsdt(address, 10)`
4. 自动在 `admin_operations` 表中记录：
   - `operation_type`: `AddUSDT`
   - `amount`: `10`
   - `amount_before`: `100` (假设)
   - `amount_after`: `110`
5. 在"操作记录"页面可查看此记录

### 场景 2：管理员扣除能量值

1. 管理员在"用户管理"页面选择用户，点击"调整能量值"
2. 输入负数金额（如 `-50`）
3. 系统执行 `adminAdjustUserEnergy(address, -50)`
4. 自动在 `admin_operations` 表中记录：
   - `operation_type`: `DeductEnergy`
   - `amount`: `-50`
   - `amount_before`: `200` (假设)
   - `amount_after`: `150`
5. 在"操作记录"页面可查看此记录

---

## ✅ 功能特点

### 1. 自动记录

- ✅ 无需手动操作，调整用户资产时自动记录
- ✅ 记录完整的操作信息（前、后金额）
- ✅ 时间戳精确到毫秒

### 2. 完整追溯

- ✅ 记录操作前后的金额变化
- ✅ 可按用户地址筛选
- ✅ 可按操作类型筛选
- ✅ 支持搜索和分页

### 3. 清晰展示

- ✅ 独特的图标和颜色区分不同操作
- ✅ 显示金额变化箭头（`before → after`）
- ✅ 自动显示单位（USDT/能量）

### 4. 状态一致

- ✅ 所有管理员操作记录状态都是 `Success`
- ✅ 不需要链上凭证（`txHash` 为空）
- ✅ 与提现、空投记录一致的展示风格

---

## 🔍 数据流程

```
管理员操作
    ↓
adminAdjustUserUsdt / adminAdjustUserEnergy
    ↓
更新 users 表 (usdt_total / energy_total)
    ↓
插入 admin_operations 表 (记录操作详情)
    ↓
前端调用 getAdminOperations API
    ↓
合并 withdrawals, claims, admin_operations 数据
    ↓
按时间排序并返回
    ↓
前端操作记录页面显示
```

---

## 📝 注意事项

### 1. 权限控制

- ⚠️ 目前系统未限制管理员权限
- ⚠️ 建议后续添加管理员身份验证
- ⚠️ 建议记录执行操作的管理员地址

### 2. 数据一致性

- ✅ 操作记录与用户资产变更同步
- ✅ 使用事务确保数据一致性
- ✅ 记录包含操作前后金额，便于审计

### 3. 性能优化

- ✅ 为常用查询字段创建了索引
- ✅ 使用分页避免一次性加载大量数据
- ✅ 按时间倒序排序，最新记录在前

---

## 🎯 未来扩展

### 可能的增强功能

1. **管理员身份记录**
   - 记录执行操作的管理员账号
   - 支持按管理员筛选操作记录

2. **操作备注**
   - 允许管理员添加操作原因/备注
   - 方便后续审计和查询

3. **批量操作**
   - 支持批量调整多个用户的资产
   - 自动记录所有批量操作

4. **操作审批**
   - 重要操作需要审批流程
   - 记录审批人和审批时间

5. **数据导出**
   - 支持导出操作记录为 CSV/Excel
   - 方便财务对账和审计

---

## 📊 测试建议

### 测试用例

1. **赠送USDT**
   - ✅ 调整正数金额
   - ✅ 验证 `usdt_total` 增加
   - ✅ 验证 `admin_operations` 记录正确
   - ✅ 验证前端显示正确

2. **扣除USDT**
   - ✅ 调整负数金额
   - ✅ 验证 `usdt_total` 减少
   - ✅ 验证不会低于 `usdt_locked`
   - ✅ 验证记录正确

3. **赠送能量值**
   - ✅ 调整正数金额
   - ✅ 验证 `energy_total` 增加
   - ✅ 验证记录正确

4. **扣除能量值**
   - ✅ 调整负数金额
   - ✅ 验证 `energy_total` 减少
   - ✅ 验证不会低于 `energy_locked`
   - ✅ 验证记录正确

5. **筛选功能**
   - ✅ 测试"所有类型"筛选
   - ✅ 测试单个类型筛选
   - ✅ 测试搜索功能

---

**功能实现时间**：2026-01-05  
**实现状态**：✅ 已完成  
**测试状态**：⚠️ 待测试

