# 提现功能测试计划

## 📋 测试目标

验证用户提取流动性收益时：
1. ✅ 金额计算是否正确
2. ✅ 是否会出现异常扣除
3. ✅ 前后端数据是否一致
4. ✅ 用户体验是否符合预期

---

## 📊 测试用户当前状态

**测试用户地址**：`0xd2d24d6839e26a87af01b621d1b2d348295fc760`

**数据库当前状态**（2026-01-05 查询时间）：

| 字段 | 值 | 说明 |
|------|-----|------|
| `usdt_total` | **24.0807 USDT** | 已固化收益（包含持币收益+管理员赠送） |
| `usdt_locked` | 0 USDT | 当前无锁定金额 |
| `energy_total` | 157 | 总能量值 |
| `energy_locked` | 0 | 当前无锁定能量 |
| `rat_balance_wei` | 16660700000000000000000 | **16660.7 RAT** |
| `last_settlement_time` | 2026-01-05 09:50:42.615+00 | 上次结算时间 |

**历史提现记录**（最近10笔）：

| 时间 | 金额 | 状态 |
|------|------|------|
| 2026-01-05 08:54:58 | 1 USDT | Completed |
| 2026-01-05 08:42:47 | 2 USDT | Completed |
| 2026-01-05 08:26:42 | 2 USDT | Completed |
| 2026-01-05 08:25:09 | 0.99 USDT | Completed |
| 2026-01-05 08:10:52 | 1 USDT | Completed |
| 2026-01-05 07:14:53 | 3 USDT | Completed |
| 2026-01-01 07:28:15 | 1 USDT | Completed |
| 2025-12-31 11:05:06 | 0.1 USDT | Completed |
| 2025-12-31 09:55:46 | 0.05 USDT | Completed |
| 2025-12-31 06:49:05 | 0.6 USDT | Completed |

**总提现金额（最近10笔）**：11.74 USDT

---

## 🧮 预期收益计算

### 1. VIP 等级确定

**RAT 余额**：16660.7 RAT

**VIP 等级**：
- VIP Level 1（10,000-49,999 RAT）
- **日利率**：2%（0.02）

### 2. 时间计算

**假设当前时间**：2026-01-05 10:00:00（UTC）

**时间差**：
- 从 `last_settlement_time`（2026-01-05 09:50:42.615）到现在
- 时间差 = 约 **9.4 分钟** = **0.0065 天**

### 3. 增量收益计算

**公式**：
```
增量收益 = RAT余额 × 单价 × 日利率 × 天数
         = 16660.7 × 0.01 × 0.02 × 0.0065
         ≈ 0.0217 USDT
```

### 4. 实时总收益计算

**公式**：
```
实时总收益 = usdt_total + 增量收益
          = 24.0807 + 0.0217
          ≈ 24.1024 USDT
```

### 5. 可提现收益计算

**公式**：
```
可提现收益 = 实时总收益 - 总提现金额
          = 24.1024 - 11.74
          ≈ 12.36 USDT
```

**⚠️ 注意**：实际总提现金额需要查询所有 `Completed` 和 `Pending` 状态的提现记录。

---

## 🧪 测试步骤

### 步骤1：记录提现前状态

**需要记录的数据**：
1. ✅ **数据库状态**：
   - `usdt_total`（当前值：24.0807 USDT）
   - `usdt_locked`（当前值：0 USDT）
   - `energy_total`（当前值：157）
   - `energy_locked`（当前值：0）
   - `last_settlement_time`（当前值：2026-01-05 09:50:42.615）

2. ✅ **前端显示**：
   - 打开用户前端页面（`0xd2d24d6839e26a87af01b621d1b2d348295fc760`）
   - 记录"流动性收益池"显示的金额（预期：约 12.36 USDT）
   - 记录"预计每日收益"显示的金额（预期：3.33 USDT）
   - 记录"能量值"显示的数值（预期：157）

3. ✅ **后端 API 验证**：
   ```bash
   # 调用收益计算 API
   curl "https://api.rabbitdifi.com/asset/earnings?address=0xd2d24d6839e26a87af01b621d1b2d348295fc760"
   ```
   - 记录返回的 `pendingUsdt` 值

### 步骤2：执行提现

**测试金额**：建议提现 **2 USDT**

**提现前检查**：
- ✅ 可提现金额 ≥ 2 USDT
- ✅ 能量值 ≥ 20（1 USDT = 10 能量）

**提现步骤**：
1. 用户前端点击"提现"按钮
2. 输入金额：`2`
3. 点击"确认提现"
4. 等待后端处理（提现记录状态：`Pending`）
5. 管理员后台完成提现（提现记录状态：`Completed`）

### 步骤3：记录提现后状态

**立即查询数据库**（提现后 1 分钟内）：
```sql
SELECT 
  usdt_total,
  usdt_locked,
  energy_total,
  energy_locked,
  last_settlement_time,
  updated_at
FROM users 
WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');
```

**预期结果**：

| 字段 | 提现前 | 提现后（预期） | 说明 |
|------|--------|---------------|------|
| `usdt_total` | 24.0807 | **22.1024** | 实时总收益 - 提现金额 = 24.1024 - 2 |
| `usdt_locked` | 0 | **0** | 提现完成后解锁 |
| `energy_total` | 157 | **157** | 不变 |
| `energy_locked` | 0 | **0** | 提现完成后解锁 |
| `last_settlement_time` | 2026-01-05 09:50:42.615 | **保持不变** ✅ | 🟢 关键：提现不重置结算时间 |

### 步骤4：验证前端显示

**刷新用户前端页面**，记录：
- "流动性收益池"显示的金额（预期：约 10.36 USDT）
  - 计算：实时总收益 - 总提现金额 = 22.1024 - (11.74 + 2) = 8.36 USDT（基准）
  - 加上增量收益（几秒到几分钟）：约 8.36-8.38 USDT
  - ⚠️ **注意**：前端可能有缓存，需要清除缓存或等待几秒

- "能量值"显示（预期：137）
  - 计算：157 - 20 = 137

### 步骤5：验证计算一致性

**后端 API 验证**：
```bash
curl "https://api.rabbitdifi.com/asset/earnings?address=0xd2d24d6839e26a87af01b621d1b2d348295fc760"
```

**验证点**：
1. ✅ `pendingUsdt` 与前端显示一致（误差 < 0.01 USDT）
2. ✅ `pendingUsdt` = 实时总收益 - 总提现金额
3. ✅ `dailyRate` = 2%（VIP Level 1）
4. ✅ `currentTier` = 1
5. ✅ `balance` = 16660.7 RAT

---

## 🎯 验证要点

### 关键验证1：usdt_total 是否正确扣除

**公式**：
```
新的 usdt_total = 实时总收益 - 提现金额
               = (usdt_total + 增量收益) - 提现金额
```

**验证方法**：
- 提现前 `usdt_total` = 24.0807 USDT
- 增量收益 ≈ 0.0217 USDT（从上次结算到提现时）
- 实时总收益 = 24.0807 + 0.0217 = 24.1024 USDT
- 提现金额 = 2 USDT
- **预期**：新的 `usdt_total` = 24.1024 - 2 = **22.1024 USDT**

### 关键验证2：last_settlement_time 是否保留

**预期**：
- ✅ `last_settlement_time` **不应该改变**
- ✅ 保持原值：`2026-01-05 09:50:42.615+00`

**原因**：
- 我们已经修复了 `applyWithdraw` 函数，提现时不重置 `last_settlement_time`
- 这样用户提现后，增量收益继续从原时间点累积，不会出现"提现后收益突然减少"的问题

### 关键验证3：能量值是否正确扣除

**公式**：
```
扣除能量 = Math.ceil(提现金额 × 10)
        = Math.ceil(2 × 10)
        = 20
```

**验证方法**：
- 提现前 `energy_total` = 157
- **预期**：提现后 `energy_total` = 157 - 20 = **137**

### 关键验证4：前端显示是否准确

**预期前端显示**：
- "流动性收益池"：约 **8.36-8.38 USDT**
  - 计算：(新的 usdt_total + 增量收益) - 总提现金额
  - = (22.1024 + 0.02) - 13.74
  - ≈ 8.36-8.38 USDT

**验证方法**：
1. 刷新前端页面（清除缓存）
2. 观察"流动性收益池"的数字
3. 等待几秒，观察数字是否平滑增长（增量收益效果）

### 关键验证5：是否存在重复扣除

**⚠️ 这是之前的 Bug，现已修复**

**验证方法**：
- 查看提现完成后，`usdt_total` 是否再次被扣除
- **预期**：`completeWithdrawal` 函数只解锁 `usdt_locked`，不修改 `usdt_total`

**验证 SQL**：
```sql
-- 查看提现记录和用户数据的时间戳
SELECT 
    w.id,
    w.amount,
    w.status,
    w.created_at as withdraw_created_at,
    w.updated_at as withdraw_updated_at,
    u.usdt_total,
    u.last_settlement_time,
    u.updated_at as user_updated_at
FROM withdrawals w
JOIN users u ON LOWER(w.address) = LOWER(u.address)
WHERE LOWER(w.address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760')
ORDER BY w.created_at DESC
LIMIT 3;
```

**预期**：
- 提现申请时（`applyWithdraw`），`usdt_total` 更新一次
- 提现完成时（`completeWithdrawal`），`usdt_total` **不再变化**

---

## 📝 测试记录模板

### 测试执行记录

**测试时间**：____________

**测试人员**：____________

#### 提现前状态

| 项目 | 预期值 | 实际值 | 状态 |
|------|--------|--------|------|
| 数据库 `usdt_total` | 24.0807 USDT | ________ | ☐ |
| 数据库 `energy_total` | 157 | ________ | ☐ |
| 前端"流动性收益池" | 约 12.36 USDT | ________ | ☐ |
| 前端"能量值" | 157 | ________ | ☐ |
| API `pendingUsdt` | 约 12.36 USDT | ________ | ☐ |

#### 提现后状态（提现 2 USDT）

| 项目 | 预期值 | 实际值 | 状态 |
|------|--------|--------|------|
| 数据库 `usdt_total` | 约 22.10 USDT | ________ | ☐ |
| 数据库 `last_settlement_time` | 保持不变 | ________ | ☐ |
| 数据库 `energy_total` | 137 | ________ | ☐ |
| 前端"流动性收益池" | 约 8.36-8.38 USDT | ________ | ☐ |
| 前端"能量值" | 137 | ________ | ☐ |
| API `pendingUsdt` | 约 8.36-8.38 USDT | ________ | ☐ |

#### 验证要点

| 验证项 | 预期结果 | 实际结果 | 状态 |
|--------|---------|---------|------|
| usdt_total 正确扣除 | 减少约 2 USDT | ________ | ☐ |
| last_settlement_time 保留 | 保持不变 | ________ | ☐ |
| 能量值正确扣除 | 减少 20 | ________ | ☐ |
| 前端显示准确 | 与后端一致 | ________ | ☐ |
| 无重复扣除 | usdt_total 只扣一次 | ________ | ☐ |

---

## 🚨 异常情况处理

### 情况1：前端显示金额与预期不符

**可能原因**：
1. 前端缓存未清除
2. API 返回数据延迟
3. 前端计算逻辑错误

**处理方法**：
1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 等待 5-10 秒后刷新页面
3. 直接调用 API 验证后端数据
4. 如果后端数据正确，检查前端代码

### 情况2：usdt_total 扣除金额不对

**可能原因**：
1. 增量收益计算错误
2. 提现时逻辑有误
3. `last_settlement_time` 未正确保留

**处理方法**：
1. 查看后端日志，检查 `applyWithdraw` 的计算过程
2. 验证 `last_settlement_time` 是否保留
3. 检查 `completeWithdrawal` 是否再次扣除（重复扣除 bug）

### 情况3：能量值扣除不是整数

**可能原因**：
1. 浮点数精度问题
2. `Math.ceil()` 未生效

**处理方法**：
1. 检查 `requiredEnergy` 计算是否使用 `Math.ceil()`
2. 验证数据库中 `energy_locked` 是否为整数

### 情况4：提现后收益突然减少很多

**可能原因**：
1. `last_settlement_time` 被重置（已修复）
2. 前端 `anchorTime` 未重置（已修复）

**处理方法**：
1. 验证 `last_settlement_time` 是否保留
2. 等待几分钟，观察收益是否正常增长
3. 如果仍不正常，检查前端缓存逻辑

---

## ✅ 测试通过标准

### 必须满足的条件

1. ✅ **usdt_total 扣除正确**：
   - 新的 `usdt_total` = (旧的 `usdt_total` + 增量收益) - 提现金额
   - 误差 < 0.01 USDT

2. ✅ **last_settlement_time 保留**：
   - 提现前后 `last_settlement_time` **不变**

3. ✅ **能量值扣除正确**：
   - 扣除能量 = `Math.ceil(提现金额 × 10)`
   - 结果为整数

4. ✅ **前端显示准确**：
   - 前端"流动性收益池"与 API `pendingUsdt` 一致
   - 误差 < 0.01 USDT

5. ✅ **无重复扣除**：
   - `usdt_total` 只在 `applyWithdraw` 时扣除一次
   - `completeWithdrawal` 不修改 `usdt_total`

6. ✅ **用户体验良好**：
   - 提现后，前端显示的金额符合用户预期
   - 数字滚动效果平滑，无突然跳变

---

## 📊 相关文档

- [流动性收益池计算逻辑修复报告](./流动性收益池计算逻辑修复报告.md)
- [流动性收益池重复扣除问题修复报告](./流动性收益池重复扣除问题修复报告.md)
- [提现金额异常问题最终分析报告](./提现金额异常问题最终分析报告.md)
- [提现能量值扣除精度问题审查报告](./提现能量值扣除精度问题审查报告.md)

---

**测试计划创建时间**：2026-01-05  
**测试状态**：⏳ 待执行  
**优先级**：🔴 高优先级

---

## 🎯 下一步操作

**建议测试流程**：
1. ✅ 阅读本测试计划
2. ⏳ 执行"步骤1：记录提现前状态"
3. ⏳ 执行"步骤2：执行提现（2 USDT）"
4. ⏳ 执行"步骤3：记录提现后状态"
5. ⏳ 执行"步骤4：验证前端显示"
6. ⏳ 执行"步骤5：验证计算一致性"
7. ⏳ 填写"测试记录模板"
8. ⏳ 如有异常，参考"异常情况处理"

**如有问题，请随时告诉我！**

