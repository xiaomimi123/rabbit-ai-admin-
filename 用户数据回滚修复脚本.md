# 用户数据回滚修复脚本

## 📋 问题描述

**用户地址**：`0xd2d24d6839e26a87af01b621d1b2d348295fc760`

**问题现象**：
- 提现前：可提现金额显示 4.34 USDT
- 提现 2 USDT 后：应该显示 2.34 USDT，但实际显示 0.34 USDT
- **被多扣了 2 USDT**

**根本原因**：
- 之前的 bug 导致 `usdt_total` 在 `completeWithdrawal` 时被错误地再次扣除
- 代码修复不会自动修复数据库中已经被错误扣除的数据
- 需要手动回滚数据

---

## 🔍 当前数据库状态

| 字段 | 值 |
|------|-----|
| `usdt_total` | 13.082009033853419 USDT |
| `total_withdrawn` | 12.74 USDT |
| `current_pending` | 0.342009033853419 USDT |

---

## 📊 计算正确的值

**用户期望**：
- 提现后应该显示：**2.34 USDT**

**计算过程**：
```
期望的 usdt_total = 期望可提现金额 + 总提现金额
                  = 2.34 + 12.74
                  = 15.08 USDT

当前 usdt_total = 13.082 USDT

需要增加 = 15.08 - 13.082
        = 1.998 USDT
        ≈ 2 USDT
```

---

## 🛠️ 修复 SQL 脚本

### 方案 1：直接设置正确的 usdt_total（推荐）

```sql
-- 🟢 修复用户 usdt_total：从 13.082 增加到 15.08（增加约 2 USDT）
UPDATE users
SET 
  usdt_total = 15.08,
  updated_at = NOW()
WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');
```

### 方案 2：增加 2 USDT（更精确）

```sql
-- 🟢 修复用户 usdt_total：增加 2 USDT
UPDATE users
SET 
  usdt_total = usdt_total + 2.0,
  updated_at = NOW()
WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');
```

### 方案 3：根据期望可提现金额计算（最精确）

```sql
-- 🟢 修复用户 usdt_total：根据期望可提现金额计算
UPDATE users
SET 
  usdt_total = (
    -- 期望提现后可提现金额
    2.34 +
    -- 总提现金额
    (SELECT COALESCE(SUM(CAST(amount AS NUMERIC)), 0)
     FROM withdrawals
     WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760')
       AND status IN ('Pending', 'Completed'))
  ),
  updated_at = NOW()
WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');
```

---

## ✅ 验证 SQL

执行修复后，运行以下 SQL 验证结果：

```sql
-- 验证修复结果
SELECT 
  address,
  usdt_total,
  (SELECT COALESCE(SUM(CAST(amount AS NUMERIC)), 0)
   FROM withdrawals
   WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760')
     AND status IN ('Pending', 'Completed')) as total_withdrawn,
  (usdt_total - (SELECT COALESCE(SUM(CAST(amount AS NUMERIC)), 0)
                 FROM withdrawals
                 WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760')
                   AND status IN ('Pending', 'Completed'))) as pending_usdt
FROM users
WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');
```

**预期结果**：
- `usdt_total` = 15.08 USDT
- `total_withdrawn` = 12.74 USDT
- `pending_usdt` = 2.34 USDT ✅

---

## 📝 执行步骤

1. **备份数据**（可选但推荐）：
   ```sql
   -- 备份当前数据
   SELECT * FROM users 
   WHERE LOWER(address) = LOWER('0xd2d24d6839e26a87af01b621d1b2d348295fc760');
   ```

2. **执行修复 SQL**：
   - 在 Supabase SQL Editor 中执行方案 1、2 或 3 中的任意一个

3. **验证结果**：
   - 执行验证 SQL，确认 `pending_usdt` = 2.34 USDT

4. **测试前端显示**：
   - 刷新前端页面，确认显示 2.34 USDT 左右

---

## ⚠️ 注意事项

1. **只修复这一个用户**：SQL 脚本中已经指定了用户地址，不会影响其他用户
2. **保留 last_settlement_time**：修复脚本不会修改 `last_settlement_time`，增量收益计算不受影响
3. **不影响提现记录**：只修改 `usdt_total`，不修改提现记录
4. **代码已修复**：修复后，新的提现不会再出现这个问题

---

## 🎯 推荐方案

**推荐使用方案 1**：直接设置 `usdt_total = 15.08`

**原因**：
- 简单直接
- 基于用户期望值计算
- 易于验证

---

**报告生成时间**：2026-01-05  
**问题状态**：🔴 需要手动修复数据库  
**优先级**：高

