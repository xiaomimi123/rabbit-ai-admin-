# æµåŠ¨æ€§æ”¶ç›Šæ± æ˜¾ç¤ºä¸è®¡ç®—é€»è¾‘å…¨é¢å®¡æŸ¥æŠ¥å‘Š - ç¬¬2éƒ¨åˆ†

## ğŸ“‹ å®¡æŸ¥æ¦‚è¿°ï¼ˆç»­ï¼‰

**ç¬¬2éƒ¨åˆ†å†…å®¹**ï¼š
- åç«¯æ”¶ç›Šè®¡ç®—é€»è¾‘
- Lazy Settle æœºåˆ¶
- `last_settlement_time` ç®¡ç†
- æç°æµç¨‹ä¸­çš„æ”¶ç›Šå¤„ç†
- ç®¡ç†å‘˜è°ƒæ•´ USDT çš„å½±å“

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `rabbit-ai-backend/src/services/earnings.ts`ï¼ˆæ”¶ç›Šè®¡ç®—ï¼‰
- `rabbit-ai-backend/src/services/withdraw.ts`ï¼ˆæç°æµç¨‹ï¼‰
- `rabbit-ai-backend/src/services/admin.ts`ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰

---

## ğŸ¯ ç¬¬2éƒ¨åˆ†ï¼šåç«¯è®¡ç®—é€»è¾‘å®¡æŸ¥

### ä¸€ã€åç«¯æ”¶ç›Šè®¡ç®—æ ¸å¿ƒé€»è¾‘

#### 1.1 calculateUserEarnings å‡½æ•°

**æ–‡ä»¶ä½ç½®**ï¼š`rabbit-ai-backend/src/services/earnings.ts`

**å‡½æ•°ç­¾å**ï¼š
```typescript
export async function calculateUserEarnings(
  provider: ethers.providers.Provider,
  userAddress: string
): Promise<{
  pendingUsdt: string;
  dailyRate: number;
  currentTier: number;
  holdingDays: number;
  balance: string;
  grossEarnings: string;
  totalWithdrawn: string;
}>
```

**è®¡ç®—æ­¥éª¤**ï¼š

##### æ­¥éª¤1ï¼šè¯»å– RAT ä½™é¢ï¼ˆç¬¬ 28-64 è¡Œï¼‰

```typescript
// ä»é“¾ä¸Šè¯»å– RAT ä½™é¢
const ratContract = new ethers.Contract(config.ratTokenContract, ERC20_ABI, provider);

// æ·»åŠ  8 ç§’è¶…æ—¶ä¿æŠ¤
const balanceWei = await Promise.race([
  ratContract.balanceOf(userAddress),
  timeoutPromise(8000)
]);

const balance = parseFloat(ethers.utils.formatUnits(balanceWei, decimals));
```

**å®¡æŸ¥ç»“æœ**ï¼š

âœ… **ä¼˜ç‚¹**ï¼š
1. **è¶…æ—¶ä¿æŠ¤**ï¼š8 ç§’è¶…æ—¶ï¼Œé˜²æ­¢ RPC è°ƒç”¨æ— é™ç­‰å¾…
2. **é™çº§ç­–ç•¥**ï¼šå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼ 0ï¼Œä¸é˜»å¡æ•´ä¸ªè¯·æ±‚
3. **ç²¾åº¦ä¿æŠ¤**ï¼šä½¿ç”¨ `formatUnits` ä¿æŒç²¾åº¦

âš ï¸ **æ½œåœ¨é—®é¢˜**ï¼š
- RPC å¤±è´¥æ—¶ä½¿ç”¨ `balance = 0`ï¼Œä¼šå¯¼è‡´æ”¶ç›Šè®¡ç®—ä¸º 0
- å¦‚æœç”¨æˆ·å®é™…æŒæœ‰ RATï¼Œä½† RPC å¤±è´¥ï¼Œä¼šæ˜¾ç¤º 0 æ”¶ç›Š
- **å½±å“**ï¼šç”¨æˆ·çœ‹åˆ° 0 æ”¶ç›Šï¼Œä½†å®é™…æœ‰æ”¶ç›Šï¼Œä½“éªŒå·®

**å»ºè®®**ï¼š
- å¯ä»¥ä»æ•°æ®åº“çš„ `rat_balance_wei` å­—æ®µè¯»å–æœ€åä¸€æ¬¡åŒæ­¥çš„ä½™é¢ä½œä¸ºé™çº§
- æˆ–è€…è¿”å›é”™è¯¯ï¼Œè®©å‰ç«¯æ˜¾ç¤º"ä½™é¢è¯»å–å¤±è´¥"

---

##### æ­¥éª¤2ï¼šæŸ¥è¯¢é¦–æ¬¡é¢†å–æ—¶é—´ï¼ˆç¬¬ 66-88 è¡Œï¼‰

```typescript
const { data: firstClaim, error: claimErr } = await supabase
  .from('claims')
  .select('created_at')
  .eq('address', addr)
  .order('created_at', { ascending: true })
  .limit(1)
  .maybeSingle();

if (!firstClaim || !firstClaim.created_at) {
  return {
    pendingUsdt: '0',
    dailyRate: 0,
    currentTier: 0,
    holdingDays: 0,
    balance: balance.toFixed(2),
    grossEarnings: '0',
    totalWithdrawn: '0',
  };
}
```

**å®¡æŸ¥ç»“æœ**ï¼š

âœ… **æ­£ç¡®**ï¼š
- å¦‚æœç”¨æˆ·ä»æœªé¢†å–è¿‡ç©ºæŠ•ï¼Œè¿”å›æ”¶ç›Š 0
- é€»è¾‘æ¸…æ™°ï¼Œç¬¦åˆä¸šåŠ¡éœ€æ±‚

---

##### æ­¥éª¤3ï¼šè¯»å–ç”¨æˆ·æ•°æ®ï¼ˆç¬¬ 90-100 è¡Œï¼‰

```typescript
const { data: userRow, error: userErr } = await supabase
  .from('users')
  .select('usdt_total, last_settlement_time, created_at')
  .eq('address', addr)
  .maybeSingle();
```

**è¯»å–å­—æ®µ**ï¼š
- `usdt_total`ï¼šå·²å›ºåŒ–çš„æ”¶ç›Šï¼ˆåŸºå‡†æ”¶ç›Šï¼‰
- `last_settlement_time`ï¼šä¸Šæ¬¡ç»“ç®—æ—¶é—´ï¼ˆå¢é‡æ”¶ç›Šçš„èµ·ç‚¹ï¼‰
- `created_at`ï¼šç”¨æˆ·åˆ›å»ºæ—¶é—´

**å®¡æŸ¥ç»“æœ**ï¼š

âœ… **æ­£ç¡®**ï¼šè¯»å–äº†æ‰€æœ‰å¿…è¦çš„å­—æ®µ

---

##### æ­¥éª¤4ï¼šç¡®å®š VIP ç­‰çº§ï¼ˆç¬¬ 102-103 è¡Œï¼‰

```typescript
const { dailyRate, tier: currentTier } = getVipTierByBalance(balance);
```

**VIP é…ç½®**ï¼ˆ`vipConfig.ts`ï¼‰ï¼š
- VIP 1ï¼š10,000-49,999 RATï¼Œæ—¥åˆ©ç‡ 2%
- VIP 2ï¼š50,000-99,999 RATï¼Œæ—¥åˆ©ç‡ 2.5%
- VIP 3ï¼š100,000-499,999 RATï¼Œæ—¥åˆ©ç‡ 3%
- VIP 4ï¼šâ‰¥500,000 RATï¼Œæ—¥åˆ©ç‡ 3.5%

**å®¡æŸ¥ç»“æœ**ï¼š

âœ… **æ­£ç¡®**ï¼šæ ¹æ®ä½™é¢ç¡®å®šç­‰çº§å’Œæ—¥åˆ©ç‡

---

##### æ­¥éª¤5ï¼šåˆå§‹åŒ– last_settlement_timeï¼ˆç¬¬ 105-316 è¡Œï¼‰

**å…³é”®é€»è¾‘**ï¼š
```typescript
let lastSettlementTime = userRow?.last_settlement_time 
  ? new Date(userRow.last_settlement_time).getTime()
  : new Date(firstClaim.created_at).getTime();

// ğŸŸ¢ æ£€æµ‹æ˜¯å¦éœ€è¦åˆå§‹åŒ– last_settlement_time
const needsInitialization = balance >= 10000 
  && currentBaseEarnings === 0 
  && Math.abs(lastSettlementTime - firstClaimTime) < 1000;

if (needsInitialization) {
  // æŸ¥è¯¢æ‰€æœ‰ claims å’Œ referral_rewardsï¼Œæ‰¾åˆ°é¦–æ¬¡è¾¾åˆ° 10k çš„æ—¶é—´
  // ...
  const firstReached10kTime = findFirstReached10kTime(allEvents);
  
  // æ›´æ–°æ•°æ®åº“
  await supabase
    .from('users')
    .update({ last_settlement_time: firstReached10kTime })
    .eq('address', addr);
  
  lastSettlementTime = firstReached10kTime.getTime();
}
```

**å®¡æŸ¥ç»“æœ**ï¼š

âœ… **ä¼˜ç‚¹**ï¼š
1. **æ™ºèƒ½åˆå§‹åŒ–**ï¼šé¦–æ¬¡è¾¾åˆ° 10k RAT æ—¶è‡ªåŠ¨è®¾ç½® `last_settlement_time`
2. **å¤šæ¥æºæ£€æµ‹**ï¼šæ£€æŸ¥ `claims` å’Œ `referral_rewards`ï¼Œæ‰¾åˆ°å®é™…è¾¾åˆ° 10k çš„æ—¶é—´
3. **ä¿å®ˆä¼°è®¡**ï¼šå¦‚æœæ— æ³•ç¡®å®šæ—¶é—´ï¼Œä½¿ç”¨é¦–æ¬¡é¢†å–æ—¶é—´ï¼ˆä¸ä¼šå¤šç®—æ”¶ç›Šï¼‰

âš ï¸ **æ½œåœ¨é—®é¢˜**ï¼š

**é—®é¢˜1ï¼šåˆå§‹åŒ–æ¡ä»¶å¯èƒ½ä¸å®Œæ•´**

```typescript
const needsInitialization = balance >= 10000 
  && currentBaseEarnings === 0 
  && Math.abs(lastSettlementTime - firstClaimTime) < 1000;
```

- å¦‚æœç”¨æˆ·é€šè¿‡ç›´æ¥è½¬è´¦è·å¾— RATï¼ˆä¸æ˜¯é€šè¿‡é¢†å–ç©ºæŠ•ï¼‰
- `claims` è¡¨æ²¡æœ‰è®°å½•ï¼Œ`firstClaim` å¯èƒ½ä¸º null
- å‡½æ•°ä¼šæå‰è¿”å›ï¼Œæ°¸è¿œä¸ä¼šåˆå§‹åŒ– `last_settlement_time`

**é—®é¢˜2ï¼šé‚€è¯·å¥–åŠ±å¯èƒ½å¯¼è‡´åˆå§‹åŒ–ä¸å‡†ç¡®**

- ç”¨æˆ·é€šè¿‡é‚€è¯·å¥–åŠ±è¾¾åˆ° 10k
- `claims` è¡¨åªæœ‰å°‘é‡è®°å½•ï¼Œ`referral_rewards` è¡¨æœ‰å¤§é‡è®°å½•
- å¦‚æœé‚€è¯·å¥–åŠ±æ²¡æœ‰ `block_time`ï¼Œä¼šä½¿ç”¨ `created_at`ï¼Œå¯èƒ½ä¸å‡†ç¡®

**å»ºè®®**ï¼š
- å¯¹äºé€šè¿‡ç›´æ¥è½¬è´¦è·å¾— RAT çš„ç”¨æˆ·ï¼Œæä¾›ç®¡ç†å‘˜å·¥å…·æ‰‹åŠ¨è®¾ç½® `last_settlement_time`
- å½“å‰å·²æœ‰ `adminSetUserSettlementTime` å‡½æ•°ï¼Œä½†éœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨è°ƒç”¨

---

##### æ­¥éª¤6ï¼šè®¡ç®—å¢é‡æ”¶ç›Šï¼ˆç¬¬ 318-330 è¡Œï¼‰

**æ ¸å¿ƒå…¬å¼**ï¼š
```typescript
// è®¡ç®—ä»ä¸Šæ¬¡ç»“ç®—åˆ°ç°åœ¨çš„å¤©æ•°
const timeElapsedMs = now - lastSettlementTime;
const daysElapsed = timeElapsedMs / (24 * 3600 * 1000); // å¤©æ•°ï¼ˆå¸¦å°æ•°ï¼‰

// è®¡ç®—å¢é‡æ”¶ç›Š
const TOKEN_PRICE = 0.01; // $0.01 per RAT
const incrementalEarnings = balance * TOKEN_PRICE * (dailyRate / 100) * daysElapsed;

// åŸºå‡†æ”¶ç›Šï¼ˆå·²å›ºåŒ–çš„æ”¶ç›Šï¼‰
const baseEarnings = Number(userRow?.usdt_total || 0);

// å®æ—¶æ€»æ”¶ç›Š = åŸºå‡†æ”¶ç›Š + å¢é‡æ”¶ç›Š
const grossEarnings = baseEarnings + incrementalEarnings;
```

**å®¡æŸ¥ç»“æœ**ï¼š

âœ… **å…¬å¼æ­£ç¡®**ï¼š
- å¢é‡æ”¶ç›Š = ä½™é¢ Ã— å•ä»· Ã— æ—¥åˆ©ç‡ Ã— å¤©æ•°
- ä¸å‰ç«¯çš„ `estimatedDailyEarnings` å…¬å¼ä¸€è‡´
- ä½¿ç”¨ `daysElapsed`ï¼ˆä» `last_settlement_time` å¼€å§‹ï¼‰ï¼Œè€Œä¸æ˜¯ `holdingDays`ï¼ˆä»é¦–æ¬¡é¢†å–å¼€å§‹ï¼‰

âš ï¸ **ä¸å‰ç«¯çš„å·®å¼‚**ï¼š

| ç»´åº¦ | åç«¯ | å‰ç«¯ |
|------|------|------|
| **æ—¶é—´åŸºå‡†** | `daysElapsed`ï¼ˆä» `last_settlement_time` å¼€å§‹ï¼‰ | `holdingDays`ï¼ˆä»é¦–æ¬¡é¢†å–å¼€å§‹ï¼‰ |
| **åŸºå‡†æ”¶ç›Š** | `baseEarnings`ï¼ˆæ•°æ®åº“ `usdt_total`ï¼‰ | `calculatedEarningsBase`ï¼ˆå‰ç«¯è®¡ç®—ï¼‰ |

**å…³é”®é—®é¢˜**ï¼š
- åç«¯ `grossEarnings` = `baseEarnings + incrementalEarnings`
- å‰ç«¯ `calculatedEarningsBase` = `ratBalance Ã— 0.01 Ã— (dailyRate / 100) Ã— holdingDays`
- å¦‚æœ `holdingDays â‰  daysElapsed`ï¼Œå‰ç«¯è®¡ç®—çš„åŸºå‡†ä¼šé”™è¯¯

---

##### æ­¥éª¤7ï¼šæ‰£é™¤æç°é‡‘é¢ï¼ˆç¬¬ 332-360 è¡Œï¼‰

```typescript
// æŸ¥è¯¢æ‰€æœ‰ Pending å’Œ Completed çš„æç°è®°å½•
const { data: withdrawals } = await supabase
  .from('withdrawals')
  .select('amount,status')
  .eq('address', addr)
  .in('status', ['Pending', 'Completed']);

// è®¡ç®—æ€»æç°é‡‘é¢
const totalWithdrawn = withdrawals.reduce((sum, w) => sum + Number(w.amount), 0);

// è®¡ç®—å¯æç°æ”¶ç›Š = æ€»æ”¶ç›Š - å·²æç°
const netEarnings = Math.max(0, grossEarnings - totalWithdrawn);

return {
  pendingUsdt: netEarnings.toFixed(6),
  // ...
};
```

**å®¡æŸ¥ç»“æœ**ï¼š

âœ… **é€»è¾‘æ­£ç¡®**ï¼š
1. **ç»Ÿè®¡ Pending å’Œ Completed**ï¼šä¸¤ç§çŠ¶æ€çš„æç°éƒ½åº”è¯¥æ‰£é™¤
2. **é˜²æ­¢è´Ÿæ•°**ï¼šä½¿ç”¨ `Math.max(0, ...)` ç¡®ä¿ä¸ä¸ºè´Ÿ
3. **ç²¾åº¦**ï¼šè¿”å› 6 ä½å°æ•°ï¼Œæ”¯æŒç§’çº§ç²¾åº¦

---

### äºŒã€Lazy Settle æœºåˆ¶

#### 2.1 ä»€ä¹ˆæ˜¯ Lazy Settle

**å®šä¹‰**ï¼š
- æ”¶ç›Š**ä¸ä¼šå®æ—¶å†™å…¥æ•°æ®åº“**
- åªåœ¨ API è°ƒç”¨æ—¶**ä¸´æ—¶è®¡ç®—**å¢é‡æ”¶ç›Š
- åªåœ¨**æç°æ—¶**æ‰å›ºåŒ–åˆ°æ•°æ®åº“ï¼ˆæ›´æ–° `usdt_total`ï¼‰

**ä¼˜ç‚¹**ï¼š
- å‡å°‘æ•°æ®åº“å†™å…¥ï¼Œæé«˜æ€§èƒ½
- æ”¶ç›Šè®¡ç®—æ›´ç²¾ç¡®ï¼ˆç§’çº§ç²¾åº¦ï¼‰

**ç¼ºç‚¹**ï¼š
- ä¾èµ– `last_settlement_time` çš„å‡†ç¡®æ€§
- å¦‚æœ `last_settlement_time` é”™è¯¯ï¼Œæ”¶ç›Šè®¡ç®—å…¨é”™

---

#### 2.2 æç°æ—¶çš„æ”¶ç›Šå›ºåŒ–

**æ–‡ä»¶ä½ç½®**ï¼š`rabbit-ai-backend/src/services/withdraw.ts`

**applyWithdraw å‡½æ•°**ï¼ˆç¬¬ 8-207 è¡Œï¼‰ï¼š

```typescript
export async function applyWithdraw(
  address: string, 
  amountStr: string,
  provider?: ethers.providers.Provider
) {
  // æ­¥éª¤1ï¼šè¯»å–ç”¨æˆ·æ•°æ®
  const { data: user } = await supabase
    .from('users')
    .select('energy_total, energy_locked, usdt_total, usdt_locked, last_settlement_time, created_at')
    .eq('address', addr)
    .maybeSingle();
  
  // æ­¥éª¤2ï¼šè®¡ç®—å®æ—¶æ”¶ç›Š
  const balance = await fetchRatBalanceFromChain(address, provider);
  const { dailyRate } = getVipTierByBalance(balance);
  
  const lastSettlementTime = user.last_settlement_time 
    ? new Date(user.last_settlement_time).getTime()
    : new Date(firstClaim.created_at).getTime();
  
  const timeElapsedMs = Date.now() - lastSettlementTime;
  const daysElapsed = timeElapsedMs / (24 * 3600 * 1000);
  
  const incrementalEarnings = balance * 0.01 * (dailyRate / 100) * daysElapsed;
  const baseEarnings = Number(user.usdt_total || 0);
  const realTimeEarnings = baseEarnings + incrementalEarnings;
  
  // æ­¥éª¤3ï¼šéªŒè¯å¯æç°é‡‘é¢
  const totalWithdrawn = calculateTotalWithdrawn();
  const availableUsdt = Math.max(0, realTimeEarnings - totalWithdrawn);
  
  if (availableUsdt < amount) {
    throw new ApiError('INSUFFICIENT_BALANCE', `Available: ${availableUsdt}, Requested: ${amount}`);
  }
  
  // æ­¥éª¤4ï¼šéªŒè¯èƒ½é‡å€¼
  const requiredEnergy = Math.ceil(amount * 10); // 1 USDT = 10 èƒ½é‡
  const energyAvailable = user.energy_total - user.energy_locked;
  
  if (energyAvailable < requiredEnergy) {
    throw new ApiError('ENERGY_NOT_ENOUGH', `Required: ${requiredEnergy}, Available: ${energyAvailable}`);
  }
  
  // æ­¥éª¤5ï¼šå›ºåŒ–æ”¶ç›Šå¹¶æ‰£é™¤æç°é‡‘é¢
  const newUsdtTotal = realTimeEarnings - amount;
  const newUsdtLocked = user.usdt_locked + amount;
  const newEnergyLocked = user.energy_locked + requiredEnergy;
  
  // ğŸŸ¢ å…³é”®ä¿®å¤ï¼šä¿ç•™åŸæœ‰çš„ last_settlement_timeï¼Œä¸é‡ç½®
  const { data: existingUser } = await supabase
    .from('users')
    .select('last_settlement_time')
    .eq('address', addr)
    .maybeSingle();
  
  await supabase.from('users').upsert({
    address: addr,
    usdt_total: newUsdtTotal,
    usdt_locked: newUsdtLocked,
    energy_locked: newEnergyLocked,
    last_settlement_time: existingUser?.last_settlement_time || null, // ğŸŸ¢ ä¿ç•™åŸå€¼
    updated_at: new Date().toISOString(),
  }, { onConflict: 'address' });
  
  // æ­¥éª¤6ï¼šåˆ›å»ºæç°è®°å½•
  await supabase.from('withdrawals').insert({
    address: addr,
    amount: amountStr,
    status: 'Pending',
    created_at: new Date().toISOString(),
  });
}
```

**å®¡æŸ¥ç»“æœ**ï¼š

âœ… **æ”¶ç›Šå›ºåŒ–é€»è¾‘æ­£ç¡®**ï¼š
1. **è®¡ç®—å®æ—¶æ”¶ç›Š**ï¼š`realTimeEarnings = baseEarnings + incrementalEarnings`
2. **æ‰£é™¤æç°é‡‘é¢**ï¼š`newUsdtTotal = realTimeEarnings - amount`
3. **æ›´æ–°æ•°æ®åº“**ï¼šå†™å…¥æ–°çš„ `usdt_total`

âœ… **å…³é”®ä¿®å¤å·²å®Œæˆ**ï¼š
- **ä¿ç•™ `last_settlement_time`**ï¼šæç°æ—¶ä¸é‡ç½® `last_settlement_time`
- è¿™æ ·ç”¨æˆ·æç°åï¼Œå¢é‡æ”¶ç›Šç»§ç»­ä»åŸæ¥çš„æ—¶é—´ç‚¹ç´¯ç§¯
- é¿å…äº†ä¹‹å‰"æç°åæ”¶ç›Šçªç„¶å‡å°‘"çš„é—®é¢˜

âš ï¸ **èƒ½é‡å€¼æ‰£é™¤å·²ä¿®å¤**ï¼š
- ä½¿ç”¨ `Math.ceil(amount * 10)` ç¡®ä¿èƒ½é‡æ‰£é™¤æ˜¯æ•´æ•°
- é¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜

---

#### 2.3 æç°å®Œæˆæ—¶çš„å¤„ç†

**æ–‡ä»¶ä½ç½®**ï¼š`rabbit-ai-backend/src/services/admin.ts`

**completeWithdrawal å‡½æ•°**ï¼ˆç¬¬ 330-366 è¡Œï¼‰ï¼š

```typescript
export async function completeWithdrawal(withdrawalId: string) {
  // æ­¥éª¤1ï¼šè¯»å–æç°è®°å½•
  const { data: w } = await supabase
    .from('withdrawals')
    .select('address, amount, energy_cost')
    .eq('id', withdrawalId)
    .maybeSingle();
  
  // æ­¥éª¤2ï¼šè¯»å–ç”¨æˆ·æ•°æ®
  const u = await getUserEnergyRow(w.address);
  
  // æ­¥éª¤3ï¼šè§£é” USDT å’Œèƒ½é‡
  // ğŸŸ¢ ä¿®å¤ï¼šusdt_total ä¸å†é‡å¤æ‰£é™¤
  const nextUsdtTotal = u.usdtTotal; // ä¿æŒä¸å˜
  const nextUsdtLocked = Math.max(0, u.usdtLocked - amtNum);
  const nextEnergyLocked = Math.max(0, u.energyLocked - energyCost);
  
  // æ­¥éª¤4ï¼šæ›´æ–°ç”¨æˆ·æ•°æ®
  await updateUserBalances(
    w.address,
    {
      energyTotal: u.energyTotal,
      energyLocked: nextEnergyLocked,
      usdtTotal: nextUsdtTotal, // ğŸŸ¢ ä¸é‡å¤æ‰£é™¤
      usdtLocked: nextUsdtLocked,
    },
    u.createdAt,
    false // ğŸŸ¢ ä¸æ›´æ–° last_settlement_time
  );
  
  // æ­¥éª¤5ï¼šæ›´æ–°æç°è®°å½•çŠ¶æ€
  await supabase
    .from('withdrawals')
    .update({ status: 'Completed', updated_at: new Date().toISOString() })
    .eq('id', withdrawalId);
}
```

**å®¡æŸ¥ç»“æœ**ï¼š

âœ… **å…³é”®ä¿®å¤å·²å®Œæˆ**ï¼š
1. **ä¸é‡å¤æ‰£é™¤ `usdt_total`**ï¼š
   - ä¹‹å‰ï¼š`nextUsdtTotal = u.usdtTotal - amtNum`ï¼ˆé”™è¯¯ï¼Œé‡å¤æ‰£é™¤ï¼‰
   - ç°åœ¨ï¼š`nextUsdtTotal = u.usdtTotal`ï¼ˆæ­£ç¡®ï¼Œä¿æŒä¸å˜ï¼‰
   
2. **ä¸é‡ç½® `last_settlement_time`**ï¼š
   - `updateLastSettlementTime = false`
   - ä¿ç•™åŸæœ‰çš„ç»“ç®—æ—¶é—´

âœ… **é€»è¾‘æ­£ç¡®**ï¼š
- æç°é‡‘é¢åœ¨ `applyWithdraw` æ—¶å·²ç»ä» `usdt_total` æ‰£é™¤
- `completeWithdrawal` åªéœ€è¦è§£é” `usdt_locked` å’Œ `energy_locked`
- ä¸åº”è¯¥å†æ¬¡æ‰£é™¤ `usdt_total`

---

### ä¸‰ã€ç®¡ç†å‘˜è°ƒæ•´ USDT çš„å½±å“

**æ–‡ä»¶ä½ç½®**ï¼š`rabbit-ai-backend/src/services/admin.ts`

**adminAdjustUserUsdt å‡½æ•°**ï¼ˆç¬¬ 1004-1042 è¡Œï¼‰ï¼š

```typescript
export async function adminAdjustUserUsdt(address: string, delta: number) {
  const u = await getUserEnergyRow(address);
  const nextTotal = Math.max(0, u.usdtTotal + delta);
  
  // ğŸŸ¢ å…³é”®ï¼šæ›´æ–° last_settlement_time
  await updateUserBalances(
    address,
    { 
      energyTotal: u.energyTotal, 
      energyLocked: u.energyLocked, 
      usdtTotal: nextTotal, 
      usdtLocked: u.usdtLocked 
    },
    u.createdAt,
    true // ğŸŸ¢ æ›´æ–° last_settlement_time ä¸ºå½“å‰æ—¶é—´
  );
  
  // ğŸŸ¢ è®°å½•ç®¡ç†å‘˜æ“ä½œ
  await supabase.from('admin_operations').insert({
    address,
    operation_type: delta > 0 ? 'AddUSDT' : 'DeductUSDT',
    amount: delta,
    amount_before: u.usdtTotal,
    amount_after: nextTotal,
  });
}
```

**updateUserBalances å‡½æ•°**ï¼ˆç¬¬ 290-328 è¡Œï¼‰ï¼š

```typescript
async function updateUserBalances(
  address: string,
  next: { energyTotal, energyLocked, usdtTotal, usdtLocked },
  createdAt: string,
  updateLastSettlementTime?: boolean
) {
  // ğŸŸ¢ å…ˆè¯»å–ç°æœ‰çš„ last_settlement_time
  const { data: existingUser } = await supabase
    .from('users')
    .select('last_settlement_time')
    .eq('address', address)
    .maybeSingle();
  
  const updateData: any = {
    address,
    energy_total: next.energyTotal,
    energy_locked: next.energyLocked,
    usdt_total: next.usdtTotal,
    usdt_locked: next.usdtLocked,
    updated_at: new Date().toISOString(),
    created_at: createdAt,
  };
  
  // ğŸŸ¢ æ ¹æ®å‚æ•°å†³å®šæ˜¯å¦æ›´æ–° last_settlement_time
  if (updateLastSettlementTime) {
    updateData.last_settlement_time = new Date().toISOString(); // æ›´æ–°ä¸ºå½“å‰æ—¶é—´
  } else {
    updateData.last_settlement_time = existingUser?.last_settlement_time || null; // ä¿ç•™åŸå€¼
  }
  
  await supabase.from('users').upsert(updateData, { onConflict: 'address' });
}
```

**å®¡æŸ¥ç»“æœ**ï¼š

âœ… **é€»è¾‘æ­£ç¡®**ï¼š
1. **ç®¡ç†å‘˜èµ é€ USDT æ—¶ï¼Œæ›´æ–° `last_settlement_time`**ï¼š
   - å¢é‡æ”¶ç›Šä»èµ é€æ—¶é—´å¼€å§‹è®¡ç®—
   - é¿å…ç”¨æˆ·è·å¾—"è¿‡å»çš„æ”¶ç›Š"

2. **æ˜¾å¼ä¿ç•™ `last_settlement_time`**ï¼š
   - åœ¨ä¸éœ€è¦æ›´æ–°æ—¶ï¼Œæ˜¾å¼è¯»å–å¹¶ä¿ç•™åŸå€¼
   - é¿å… `upsert` æ“ä½œå¯¼è‡´å­—æ®µä¸¢å¤±

âš ï¸ **å¯¹å‰ç«¯çš„å½±å“**ï¼š

**åœºæ™¯**ï¼šç®¡ç†å‘˜èµ é€ 5 USDT

1. **åç«¯å˜åŒ–**ï¼š
   - `usdt_total` += 5ï¼ˆå‡è®¾ä» 3 å˜æˆ 8ï¼‰
   - `last_settlement_time` æ›´æ–°ä¸ºå½“å‰æ—¶é—´ï¼ˆå‡è®¾ 2026-01-05 10:00ï¼‰

2. **å‰ç«¯è®¡ç®—**ï¼š
   - API è¿”å› `pendingUsdt = 8`ï¼ˆæ–°çš„ `usdt_total`ï¼Œå› ä¸º `daysElapsed` å¾ˆå°ï¼‰
   - å‰ç«¯ä½¿ç”¨ `holdingDays = 7`ï¼ˆä»é¦–æ¬¡é¢†å–åˆ°ç°åœ¨ï¼‰
   - å‰ç«¯è®¡ç®— `calculatedBase = balance Ã— 0.01 Ã— 0.02 Ã— 7 = å‡è®¾ 10 USDT`
   - `giftedUsdt = 8 - 10 = -2 USDT`ï¼ˆâŒ è´Ÿæ•°ï¼ï¼‰

3. **æ˜¾ç¤ºé”™è¯¯**ï¼š
   - å®æ—¶æ”¶ç›Š = `calculatedBase + incrementalEarnings + giftedUsdt`
   - å¦‚æœ `giftedUsdt` æ˜¯è´Ÿæ•°ï¼Œæ˜¾ç¤ºä¼šé”™è¯¯

**æ ¹æœ¬åŸå› **ï¼š
- åç«¯çš„ `daysElapsed` è¢«é‡ç½®ä¸º 0ï¼ˆä»å½“å‰æ—¶é—´å¼€å§‹ï¼‰
- å‰ç«¯çš„ `holdingDays` æ²¡æœ‰é‡ç½®ï¼ˆä»ç„¶æ˜¯ 7 å¤©ï¼‰
- å‰ç«¯è®¡ç®—çš„ `calculatedBase` è¿œå¤§äºåç«¯çš„ `baseEarnings`

---

## ğŸ“Š ç¬¬2éƒ¨åˆ†å®¡æŸ¥æ€»ç»“

### âœ… åç«¯è®¡ç®—çš„ä¼˜ç‚¹

1. **Lazy Settle æœºåˆ¶é«˜æ•ˆ**ï¼š
   - å‡å°‘æ•°æ®åº“å†™å…¥
   - æ”¶ç›Šè®¡ç®—ç²¾ç¡®ï¼ˆç§’çº§ï¼‰

2. **æç°æµç¨‹ä¿®å¤æ­£ç¡®**ï¼š
   - ä¸é‡å¤æ‰£é™¤ `usdt_total`
   - ä¸é‡ç½® `last_settlement_time`

3. **ç®¡ç†å‘˜è°ƒæ•´é€»è¾‘æ¸…æ™°**ï¼š
   - èµ é€ USDT æ—¶æ›´æ–° `last_settlement_time`
   - æ˜¾å¼ä¿ç•™åŸå€¼ï¼Œé¿å…å­—æ®µä¸¢å¤±

### âš ï¸ å‘ç°çš„å…³é”®é—®é¢˜

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“ |
|------|----------|------|
| åç«¯ä½¿ç”¨ `daysElapsed`ï¼Œå‰ç«¯ä½¿ç”¨ `holdingDays` | ğŸ”´ é«˜ | ç®¡ç†å‘˜èµ é€åï¼Œå‰ç«¯ `giftedUsdt` è®¡ç®—é”™è¯¯ |
| RPC å¤±è´¥æ—¶ä½™é¢ä¸º 0ï¼Œæ”¶ç›Šè®¡ç®—é”™è¯¯ | ğŸŸ¡ ä¸­ | ç”¨æˆ·çœ‹åˆ° 0 æ”¶ç›Šï¼Œä½†å®é™…æœ‰æ”¶ç›Š |
| é€šè¿‡ç›´æ¥è½¬è´¦è·å¾— RAT çš„ç”¨æˆ·ï¼Œ`last_settlement_time` å¯èƒ½æœªåˆå§‹åŒ– | ğŸŸ¡ ä¸­ | æ”¶ç›Šè®¡ç®—èµ·ç‚¹ä¸å‡†ç¡® |

### ğŸ¯ æ ¸å¿ƒçŸ›ç›¾

**æ—¶é—´åŸºå‡†ä¸åŒæ­¥**ï¼š

| åœºæ™¯ | åç«¯ `daysElapsed` | å‰ç«¯ `holdingDays` | ç»“æœ |
|------|-------------------|-------------------|------|
| **æ­£å¸¸æƒ…å†µ** | 7 å¤©ï¼ˆä»é¦–æ¬¡è¾¾åˆ° 10k å¼€å§‹ï¼‰ | 7 å¤©ï¼ˆä»é¦–æ¬¡é¢†å–å¼€å§‹ï¼‰ | åŸºæœ¬ä¸€è‡´ |
| **ç®¡ç†å‘˜èµ é€ USDT** | 0 å¤©ï¼ˆ`last_settlement_time` é‡ç½®ï¼‰ | 7 å¤©ï¼ˆ`holdingDays` ä¸å˜ï¼‰ | âŒ `giftedUsdt` ä¸ºè´Ÿæ•° |
| **ç”¨æˆ·æç°** | 7 å¤©ï¼ˆ`last_settlement_time` ä¿ç•™ï¼‰ | 7 å¤©ï¼ˆ`holdingDays` ä¸å˜ï¼‰ | âœ… ä¸€è‡´ |

---

## ğŸ”¥ ç»¼åˆåˆ†æï¼šå‰åç«¯ååŒé—®é¢˜

### é—®é¢˜1ï¼šå‰ç«¯è®¡ç®— `calculatedBase` çš„é€»è¾‘æœ‰è¯¯

**å‰ç«¯è®¡ç®—**ï¼š
```typescript
calculatedBase = ratBalance Ã— 0.01 Ã— (dailyRate / 100) Ã— holdingDays
```

**åç«¯è®¡ç®—**ï¼š
```typescript
incrementalEarnings = balance Ã— 0.01 Ã— (dailyRate / 100) Ã— daysElapsed
grossEarnings = baseEarnings + incrementalEarnings
pendingUsdt = grossEarnings - totalWithdrawn
```

**å¯¹æ¯”**ï¼š
- å‰ç«¯ `calculatedBase` è¯•å›¾è®¡ç®—"æŒå¸æ€»æ”¶ç›Š"
- åç«¯ `pendingUsdt` æ˜¯"åŸºå‡†æ”¶ç›Š + å¢é‡æ”¶ç›Š - æç°"
- å‰ç«¯ `giftedUsdt = pendingUsdt - calculatedBase`ï¼Œå‡è®¾ä¸¤è€…çš„å·®å°±æ˜¯èµ é€çš„ USDT
- **ä½†è¿™ä¸ªå‡è®¾åœ¨ç®¡ç†å‘˜èµ é€åæ˜¯é”™è¯¯çš„ï¼**

---

### é—®é¢˜2ï¼šå‰ç«¯ç¼“å­˜é€»è¾‘ä¸çŸ¥é“ `last_settlement_time` å˜åŒ–

**åœºæ™¯**ï¼šç®¡ç†å‘˜èµ é€ 5 USDT

1. åç«¯æ›´æ–° `last_settlement_time` ä¸ºå½“å‰æ—¶é—´
2. å‰ç«¯è°ƒç”¨ APIï¼Œè·å¾—æ–°çš„ `pendingUsdt`
3. å‰ç«¯æ£€æµ‹åˆ°é‡‘é¢å¢åŠ ï¼ˆ`amountDiff > 0`ï¼‰
4. å‰ç«¯åˆ¤æ–­ä¸º"æ­£å¸¸çš„æ”¶ç›Šå¢é•¿ï¼Œä¿æŒæ—§æ—¶é—´æˆ³"
5. **âŒ å‰ç«¯ç»§ç»­ä½¿ç”¨æ—§çš„ `holdingDays` è®¡ç®—ï¼Œå¯¼è‡´é”™è¯¯**

**æ­£ç¡®çš„é€»è¾‘åº”è¯¥æ˜¯**ï¼š
- å¦‚æœåç«¯çš„ `last_settlement_time` å˜åŒ–äº†ï¼Œå‰ç«¯åº”è¯¥é‡ç½® `anchorTime`
- ä½†å‰ç«¯æ— æ³•çŸ¥é“ `last_settlement_time` æ˜¯å¦å˜åŒ–ï¼ˆAPI æ²¡æœ‰è¿”å›ï¼‰

---

## ğŸ¯ å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå‰ç«¯ç®€åŒ–è®¡ç®—é€»è¾‘ï¼ˆæ¨èï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šå‰ç«¯ä¸å†è®¡ç®— `calculatedBase` å’Œ `giftedUsdt`ï¼Œç›´æ¥ä¿¡ä»»åç«¯è¿”å›çš„ `pendingUsdt`

**ä¿®æ”¹ç‚¹**ï¼š
1. ç§»é™¤ `calculatedEarningsBase` çš„è®¡ç®—
2. ç›´æ¥ä½¿ç”¨ `pendingUsdtValue` ä½œä¸ºåŸºå‡†å€¼
3. å¢é‡æ”¶ç›ŠåŸºäº `estimatedDailyEarnings` å’Œ `anchorTime`
4. ä¸å†åŒºåˆ†"æŒå¸æ”¶ç›Š"å’Œ"èµ é€ USDT"

**ä¼˜ç‚¹**ï¼š
- å‰ç«¯é€»è¾‘ç®€åŒ–
- ä¸åç«¯è®¡ç®—ä¸€è‡´
- ç®¡ç†å‘˜èµ é€ USDT åä¸ä¼šå‡ºé”™

**ç¼ºç‚¹**ï¼š
- æ— æ³•åœ¨å‰ç«¯åŒºåˆ†"æŒå¸æ”¶ç›Š"å’Œ"èµ é€ USDT"ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰

---

### æ–¹æ¡ˆ2ï¼šåç«¯è¿”å›æ›´å¤šä¿¡æ¯

**æ ¸å¿ƒæ€è·¯**ï¼šåç«¯ API è¿”å› `last_settlement_time` å’Œ `baseEarnings`ï¼Œå‰ç«¯æ ¹æ®è¿™äº›ä¿¡æ¯è°ƒæ•´ç¼“å­˜

**ä¿®æ”¹ç‚¹**ï¼š
1. åç«¯ `calculateUserEarnings` è¿”å› `lastSettlementTime` å’Œ `baseEarnings`
2. å‰ç«¯æ£€æµ‹ `lastSettlementTime` æ˜¯å¦å˜åŒ–
3. å¦‚æœå˜åŒ–ï¼Œé‡ç½® `anchorTime` ä¸ºå½“å‰æ—¶é—´
4. ä½¿ç”¨åç«¯è¿”å›çš„ `baseEarnings` ä½œä¸ºåŸºå‡†å€¼

**ä¼˜ç‚¹**ï¼š
- å‰ç«¯èƒ½å‡†ç¡®çŸ¥é“åç«¯çš„çŠ¶æ€
- ç®¡ç†å‘˜èµ é€åï¼Œå‰ç«¯èƒ½æ­£ç¡®é‡ç½®

**ç¼ºç‚¹**ï¼š
- éœ€è¦ä¿®æ”¹ API æ¥å£
- å‰ç«¯é€»è¾‘æ›´å¤æ‚

---

### æ–¹æ¡ˆ3ï¼šç§»é™¤å‰ç«¯å®æ—¶è®¡ç®—ï¼ˆæœ€ç®€å•ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šå‰ç«¯ä¸è¿›è¡Œå®æ—¶è®¡ç®—ï¼Œç›´æ¥æ˜¾ç¤ºåç«¯è¿”å›çš„ `pendingUsdt`

**ä¿®æ”¹ç‚¹**ï¼š
1. ç§»é™¤æ‰€æœ‰å®æ—¶è®¡ç®—é€»è¾‘
2. ä½¿ç”¨ `RollingNumber` ç›´æ¥æ˜¾ç¤º `pendingUsdt`
3. æ¯ 5-10 ç§’é‡æ–°è°ƒç”¨ API è·å–æœ€æ–°æ•°æ®

**ä¼˜ç‚¹**ï¼š
- å‰ç«¯é€»è¾‘æœ€ç®€å•
- ç»å¯¹ä¸ä¼šå‡ºé”™ï¼ˆç›´æ¥æ˜¾ç¤ºåç«¯æ•°æ®ï¼‰

**ç¼ºç‚¹**ï¼š
- éœ€è¦é¢‘ç¹è°ƒç”¨ APIï¼ˆæ€§èƒ½é—®é¢˜ï¼‰
- æ•°å­—æ»šåŠ¨ä¸å¤Ÿå¹³æ»‘ï¼ˆ5-10 ç§’æ‰æ›´æ–°ä¸€æ¬¡ï¼‰

---

## ğŸ“ æœ€ç»ˆå»ºè®®

**æ¨èæ–¹æ¡ˆ1ï¼šå‰ç«¯ç®€åŒ–è®¡ç®—é€»è¾‘**

**ç†ç”±**ï¼š
1. ä¿ç•™æ•°å­—æ»šåŠ¨æ•ˆæœï¼ˆç”¨æˆ·ä½“éªŒå¥½ï¼‰
2. ä¸å¢åŠ  API è°ƒç”¨é¢‘ç‡ï¼ˆæ€§èƒ½å¥½ï¼‰
3. å‰ç«¯é€»è¾‘ç®€åŒ–ï¼Œä¸æ˜“å‡ºé”™
4. ä¸åç«¯è®¡ç®—ä¸€è‡´

**éœ€è¦ä¿®æ”¹çš„ä»£ç **ï¼š
- `AssetView.tsx` ä¸­çš„æ”¶ç›Šè®¡ç®—é€»è¾‘
- ç§»é™¤ `calculatedEarningsBase` å’Œ `giftedUsdt` çš„è®¡ç®—
- ç®€åŒ–ç¼“å­˜é€»è¾‘

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2026-01-05  
**å®¡æŸ¥çŠ¶æ€**ï¼šâœ… ç¬¬2éƒ¨åˆ†å®Œæˆ  
**æ€»ä½“çŠ¶æ€**ï¼šâœ… å…¨é¢å®¡æŸ¥å®Œæˆ

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ç¬¬1éƒ¨åˆ†ï¼šå‰ç«¯æ˜¾ç¤ºé€»è¾‘å®¡æŸ¥](./æµåŠ¨æ€§æ”¶ç›Šæ± æ˜¾ç¤ºä¸è®¡ç®—é€»è¾‘å…¨é¢å®¡æŸ¥æŠ¥å‘Š-ç¬¬1éƒ¨åˆ†.md)
- [ç®¡ç†å‘˜æ“ä½œè®°å½•åŠŸèƒ½è¯´æ˜](./ç®¡ç†å‘˜æ“ä½œè®°å½•åŠŸèƒ½è¯´æ˜.md)
- [æç°é‡‘é¢å¼‚å¸¸é—®é¢˜æœ€ç»ˆåˆ†ææŠ¥å‘Š](./æç°é‡‘é¢å¼‚å¸¸é—®é¢˜æœ€ç»ˆåˆ†ææŠ¥å‘Š.md)

