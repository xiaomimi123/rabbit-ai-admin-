# æµåŠ¨æ€§æ”¶ç›Šæ± é‡å¤æ‰£é™¤é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ ä¿®å¤æ¦‚è¿°

**ä¿®å¤æ—¶é—´**ï¼š2026-01-05  
**é—®é¢˜ç±»å‹**ï¼šä¸¥é‡ Bug - æ”¶ç›Šè®¡ç®—é”™è¯¯  
**å½±å“èŒƒå›´**ï¼šæ‰€æœ‰ç”¨æˆ·çš„æç°åŠŸèƒ½  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤å¹¶æäº¤

---

## ğŸ”´ é—®é¢˜æè¿°

### é—®é¢˜ç°è±¡

ç”¨æˆ·åé¦ˆï¼š
- ç”¨æˆ·é’±åŒ…åœ°å€ï¼š`0xd2d24d6839e26a87af01b621d1b2d348295fc760`
- ä¹‹å‰é¡µé¢æ˜¾ç¤ºï¼š11 USDT
- æç°äº†ï¼š3 USDT
- ç°åœ¨æ˜¾ç¤ºï¼š2.1 USDTï¼ˆè€Œä¸æ˜¯é¢„æœŸçš„ 8 USDTï¼‰

### é—®é¢˜æ ¹æº

é€šè¿‡ä»£ç å®¡æŸ¥å‘ç°ï¼Œ`completeWithdrawal` å‡½æ•°åœ¨ç®¡ç†å‘˜å®Œæˆæç°æ—¶ï¼Œé”™è¯¯åœ°å†æ¬¡æ‰£é™¤äº† `usdt_total`ï¼Œå¯¼è‡´ç”¨æˆ·æ”¶ç›Šè¢«é‡å¤æ‰£é™¤ã€‚

---

## ğŸ” é—®é¢˜åˆ†æ

### æç°æµç¨‹åˆ†æ

**æ­£ç¡®çš„æç°æµç¨‹åº”è¯¥æ˜¯**ï¼š

1. **æ­¥éª¤ 1ï¼šç”¨æˆ·ç”³è¯·æç°ï¼ˆ`applyWithdraw`ï¼‰**
   - è®¡ç®—å®æ—¶æ”¶ç›Šï¼š`realTimeEarnings = baseEarnings + incrementalEarnings`
   - å›ºåŒ–æ”¶ç›Šåˆ°æ•°æ®åº“ï¼š`usdt_total = realTimeEarnings - amount` âœ…
   - é”å®šé‡‘é¢ï¼š`usdt_locked = usdt_locked + amount` âœ…
   - åˆ›å»ºæç°è®°å½•ï¼ˆçŠ¶æ€ï¼šPendingï¼‰

2. **æ­¥éª¤ 2ï¼šç®¡ç†å‘˜å®Œæˆæç°ï¼ˆ`completeWithdrawal`ï¼‰**
   - éªŒè¯é“¾ä¸Šäº¤æ˜“
   - é‡Šæ”¾é”å®šé‡‘é¢ï¼š`usdt_locked = usdt_locked - amount` âœ…
   - **ä¸åº”è¯¥**ï¼šå†æ¬¡æ‰£é™¤ `usdt_total` âŒ

### é—®é¢˜ä»£ç ä½ç½®

**æ–‡ä»¶**ï¼š`rabbit-ai-backend/src/services/admin.ts`  
**å‡½æ•°**ï¼š`completeWithdrawal`  
**è¡Œå·**ï¼šç¬¬ 442 è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```typescript
// âŒ é”™è¯¯ä»£ç 
const nextUsdtTotal = Math.max(0, u.usdtTotal - amtNum);
```

**é—®é¢˜åˆ†æ**ï¼š
- `usdt_total` åœ¨ç”¨æˆ·ç”³è¯·æç°æ—¶ï¼ˆ`applyWithdraw`ï¼‰å·²ç»æ­£ç¡®æ›´æ–°ä¸º `realTimeEarnings - amount`
- `completeWithdrawal` å‡½æ•°ä¸åº”è¯¥å†æ¬¡æ‰£é™¤ `usdt_total`
- è¿™å¯¼è‡´ç”¨æˆ·æ”¶ç›Šè¢«é‡å¤æ‰£é™¤

### å½±å“ç¤ºä¾‹

**å‡è®¾åœºæ™¯**ï¼š
- ç”¨æˆ·å®æ—¶æ€»æ”¶ç›Šï¼š11 USDT
- æç°é‡‘é¢ï¼š3 USDT
- å·²æç°æ€»é¢ï¼ˆå†å²ï¼‰ï¼š3.75 USDT

**ä¿®å¤å‰çš„é”™è¯¯æµç¨‹**ï¼š
1. ç”¨æˆ·ç”³è¯·æç°ï¼š
   - `usdt_total = 11 - 3 = 8 USDT` âœ… æ­£ç¡®
   - `usdt_locked = 0 + 3 = 3 USDT` âœ… æ­£ç¡®

2. ç®¡ç†å‘˜å®Œæˆæç°ï¼š
   - `usdt_total = 8 - 3 = 5 USDT` âŒ **é”™è¯¯ï¼é‡å¤æ‰£é™¤**
   - `usdt_locked = 3 - 3 = 0 USDT` âœ… æ­£ç¡®

3. æœ€ç»ˆç»“æœï¼š
   - `usdt_total = 5 USDT` âŒï¼ˆåº”è¯¥æ˜¯ 8 USDTï¼‰
   - å¯æç°æ”¶ç›Š = `5 + å¢é‡ - 6.75 = è´Ÿæ•°æˆ–å¾ˆå°` âŒ

**ä¿®å¤åçš„æ­£ç¡®æµç¨‹**ï¼š
1. ç”¨æˆ·ç”³è¯·æç°ï¼š
   - `usdt_total = 11 - 3 = 8 USDT` âœ… æ­£ç¡®
   - `usdt_locked = 0 + 3 = 3 USDT` âœ… æ­£ç¡®

2. ç®¡ç†å‘˜å®Œæˆæç°ï¼š
   - `usdt_total = 8 USDT` âœ… **ä¿æŒä¸å˜**
   - `usdt_locked = 3 - 3 = 0 USDT` âœ… æ­£ç¡®

3. æœ€ç»ˆç»“æœï¼š
   - `usdt_total = 8 USDT` âœ… æ­£ç¡®
   - å¯æç°æ”¶ç›Š = `8 + å¢é‡ - 6.75 = æ­£ç¡®å€¼` âœ…

---

## âœ… ä¿®å¤å†…å®¹

### ä¿®å¤æ–‡ä»¶

**æ–‡ä»¶è·¯å¾„**ï¼š`rabbit-ai-backend/src/services/admin.ts`  
**å‡½æ•°åç§°**ï¼š`completeWithdrawal`  
**ä¿®å¤è¡Œå·**ï¼šç¬¬ 436-445 è¡Œ

### ä¿®å¤å‰åä»£ç å¯¹æ¯”

#### ä¿®å¤å‰ï¼ˆé”™è¯¯ä»£ç ï¼‰

```typescript
// Update DB: withdrawal completed + adjust energy + adjust usdt
// âœ… ä¿®å¤ï¼šä½¿ç”¨ energy_locked_amount è€Œä¸æ˜¯ amount æ¥æ‰£é™¤èƒ½é‡
// å› ä¸º 1 USDT = 10 Energyï¼Œæ‰€ä»¥æ‰£é™¤èƒ½é‡åº”è¯¥ä½¿ç”¨å®é™…é”å®šçš„èƒ½é‡å€¼
const u = await getUserEnergyRow(userAddr);
const amtNum = Number(amount);

const nextEnergyLocked = Math.max(0, u.energyLocked - energyLockedAmount);
const nextEnergyTotal = Math.max(0, u.energyTotal - energyLockedAmount);
const nextUsdtLocked = Math.max(0, u.usdtLocked - amtNum);
const nextUsdtTotal = Math.max(0, u.usdtTotal - amtNum); // âŒ é”™è¯¯ï¼šé‡å¤æ‰£é™¤
```

#### ä¿®å¤åï¼ˆæ­£ç¡®ä»£ç ï¼‰

```typescript
// Update DB: withdrawal completed + adjust energy + adjust usdt
// âœ… ä¿®å¤ï¼šä½¿ç”¨ energy_locked_amount è€Œä¸æ˜¯ amount æ¥æ‰£é™¤èƒ½é‡
// å› ä¸º 1 USDT = 10 Energyï¼Œæ‰€ä»¥æ‰£é™¤èƒ½é‡åº”è¯¥ä½¿ç”¨å®é™…é”å®šçš„èƒ½é‡å€¼
// ğŸŸ¢ å…³é”®ä¿®å¤ï¼šusdt_total ä¸åº”è¯¥åœ¨ completeWithdrawal æ—¶å†æ¬¡æ‰£é™¤
// åŸå› ï¼šusdt_total åœ¨ç”¨æˆ·ç”³è¯·æç°æ—¶ï¼ˆapplyWithdrawï¼‰å·²ç»æ­£ç¡®æ›´æ–°ä¸º realTimeEarnings - amount
// completeWithdrawal åªéœ€è¦é‡Šæ”¾ usdt_lockedï¼Œä¸åº”è¯¥ä¿®æ”¹ usdt_total
const u = await getUserEnergyRow(userAddr);
const amtNum = Number(amount);

const nextEnergyLocked = Math.max(0, u.energyLocked - energyLockedAmount);
const nextEnergyTotal = Math.max(0, u.energyTotal - energyLockedAmount);
const nextUsdtLocked = Math.max(0, u.usdtLocked - amtNum);
const nextUsdtTotal = u.usdtTotal; // ğŸŸ¢ ä¿®å¤ï¼šä¿æŒä¸å˜ï¼Œä¸æ‰£é™¤ï¼ˆå·²åœ¨ applyWithdraw æ—¶æ‰£é™¤ï¼‰
```

### å…³é”®ä¿®æ”¹ç‚¹

1. **ä¿®æ”¹å‰**ï¼š
   ```typescript
   const nextUsdtTotal = Math.max(0, u.usdtTotal - amtNum);
   ```

2. **ä¿®æ”¹å**ï¼š
   ```typescript
   const nextUsdtTotal = u.usdtTotal; // ğŸŸ¢ ä¿®å¤ï¼šä¿æŒä¸å˜ï¼Œä¸æ‰£é™¤ï¼ˆå·²åœ¨ applyWithdraw æ—¶æ‰£é™¤ï¼‰
   ```

3. **æ·»åŠ çš„æ³¨é‡Š**ï¼š
   - è¯¦ç»†è¯´æ˜äº†ä¸ºä»€ä¹ˆä¸åº”è¯¥å†æ¬¡æ‰£é™¤ `usdt_total`
   - è§£é‡Šäº† `usdt_total` åœ¨ `applyWithdraw` æ—¶å·²ç»æ­£ç¡®æ›´æ–°

---

## ğŸ“Š ä¿®å¤å½±å“åˆ†æ

### ä¿®å¤å‰çš„å½±å“

1. **ç”¨æˆ·æ”¶ç›Šè¢«é‡å¤æ‰£é™¤**ï¼š
   - æ¯æ¬¡æç°ï¼Œ`usdt_total` è¢«æ‰£é™¤ä¸¤æ¬¡
   - å¯¼è‡´ç”¨æˆ·å¯æç°æ”¶ç›Šå‡å°‘

2. **æ”¶ç›Šè®¡ç®—é”™è¯¯**ï¼š
   - ç”¨æˆ·çœ‹åˆ°çš„å¯æç°æ”¶ç›Šä¸å‡†ç¡®
   - å¯èƒ½æ˜¾ç¤ºè´Ÿæ•°æˆ–å¾ˆå°çš„å€¼

3. **æ•°æ®ä¸ä¸€è‡´**ï¼š
   - `usdt_total` ä¸å®é™…æ”¶ç›Šä¸åŒ¹é…
   - å½±å“åç»­æ”¶ç›Šè®¡ç®—

### ä¿®å¤åçš„æ”¹è¿›

1. **æ”¶ç›Šè®¡ç®—æ­£ç¡®**ï¼š
   - `usdt_total` åªåœ¨ç”³è¯·æç°æ—¶æ‰£é™¤ä¸€æ¬¡
   - å®Œæˆæç°æ—¶åªé‡Šæ”¾é”å®šé‡‘é¢

2. **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - `usdt_total` ä¸å®é™…æ”¶ç›ŠåŒ¹é…
   - åç»­æ”¶ç›Šè®¡ç®—å‡†ç¡®

3. **ç”¨æˆ·ä½“éªŒæ”¹å–„**ï¼š
   - ç”¨æˆ·çœ‹åˆ°çš„å¯æç°æ”¶ç›Šå‡†ç¡®
   - ä¸å†å‡ºç°æ”¶ç›Šè¢«é‡å¤æ‰£é™¤çš„æƒ…å†µ

### å½±å“èŒƒå›´

- **å—å½±å“çš„åŠŸèƒ½**ï¼šæ‰€æœ‰ç”¨æˆ·çš„æç°åŠŸèƒ½
- **å—å½±å“çš„æ•°æ®**ï¼š`users.usdt_total` å­—æ®µ
- **å‘åå…¼å®¹æ€§**ï¼šâœ… ä¿®å¤åä¸å½±å“ç°æœ‰æ•°æ®
- **éœ€è¦æ•°æ®ä¿®å¤**ï¼šâš ï¸ å¯èƒ½éœ€è¦ä¿®å¤å†å²æ•°æ®ï¼ˆå¦‚æœä¹‹å‰æœ‰é‡å¤æ‰£é™¤ï¼‰

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ç›¸å…³å‡½æ•°

1. **`applyWithdraw`**ï¼ˆ`rabbit-ai-backend/src/services/withdraw.ts`ï¼‰
   - ç”¨æˆ·ç”³è¯·æç°æ—¶è°ƒç”¨
   - è´Ÿè´£è®¡ç®—å®æ—¶æ”¶ç›Šå¹¶å›ºåŒ–åˆ°æ•°æ®åº“
   - æ›´æ–° `usdt_total = realTimeEarnings - amount` âœ…

2. **`completeWithdrawal`**ï¼ˆ`rabbit-ai-backend/src/services/admin.ts`ï¼‰
   - ç®¡ç†å‘˜å®Œæˆæç°æ—¶è°ƒç”¨
   - è´Ÿè´£éªŒè¯é“¾ä¸Šäº¤æ˜“å¹¶æ›´æ–°æç°çŠ¶æ€
   - **ä¿®å¤å‰**ï¼šé”™è¯¯åœ°å†æ¬¡æ‰£é™¤ `usdt_total` âŒ
   - **ä¿®å¤å**ï¼šåªé‡Šæ”¾ `usdt_locked`ï¼Œä¸ä¿®æ”¹ `usdt_total` âœ…

### æ•°æ®æµ

```
ç”¨æˆ·ç”³è¯·æç° (applyWithdraw)
  â†“
è®¡ç®—å®æ—¶æ”¶ç›Š: realTimeEarnings = baseEarnings + incrementalEarnings
  â†“
å›ºåŒ–æ”¶ç›Š: usdt_total = realTimeEarnings - amount âœ…
  â†“
é”å®šé‡‘é¢: usdt_locked = usdt_locked + amount âœ…
  â†“
åˆ›å»ºæç°è®°å½• (çŠ¶æ€: Pending)
  â†“
ç®¡ç†å‘˜å®Œæˆæç° (completeWithdrawal)
  â†“
éªŒè¯é“¾ä¸Šäº¤æ˜“ âœ…
  â†“
é‡Šæ”¾é”å®š: usdt_locked = usdt_locked - amount âœ…
  â†“
ä¿æŒä¸å˜: usdt_total = usdt_total âœ… (ä¿®å¤å)
  â†“
æ›´æ–°æç°è®°å½• (çŠ¶æ€: Completed) âœ…
```

---

## âœ… éªŒè¯æ­¥éª¤

### 1. ä»£ç å®¡æŸ¥

- [x] æ£€æŸ¥ `completeWithdrawal` å‡½æ•°é€»è¾‘
- [x] ç¡®è®¤ `usdt_total` ä¸å†è¢«é‡å¤æ‰£é™¤
- [x] éªŒè¯æ³¨é‡Šè¯´æ˜æ¸…æ™°

### 2. åŠŸèƒ½æµ‹è¯•å»ºè®®

**æµ‹è¯•åœºæ™¯ 1ï¼šæ­£å¸¸æç°æµç¨‹**
1. ç”¨æˆ·ç”³è¯·æç° 3 USDT
2. æ£€æŸ¥ `usdt_total` æ˜¯å¦æ­£ç¡®æ›´æ–°ä¸º `realTimeEarnings - 3`
3. ç®¡ç†å‘˜å®Œæˆæç°
4. æ£€æŸ¥ `usdt_total` æ˜¯å¦ä¿æŒä¸å˜ï¼ˆä¸å†æ¬¡æ‰£é™¤ï¼‰
5. æ£€æŸ¥ `usdt_locked` æ˜¯å¦æ­£ç¡®é‡Šæ”¾

**æµ‹è¯•åœºæ™¯ 2ï¼šå¤šæ¬¡æç°**
1. ç”¨æˆ·ç”³è¯·æç° 1 USDT
2. ç®¡ç†å‘˜å®Œæˆæç°
3. ç”¨æˆ·å†æ¬¡ç”³è¯·æç° 2 USDT
4. ç®¡ç†å‘˜å®Œæˆæç°
5. éªŒè¯æ¯æ¬¡æç°å `usdt_total` åªæ‰£é™¤ä¸€æ¬¡

**æµ‹è¯•åœºæ™¯ 3ï¼šæ”¶ç›Šè®¡ç®—éªŒè¯**
1. è®°å½•æç°å‰çš„ `usdt_total` å’Œ `totalWithdrawn`
2. ç”¨æˆ·ç”³è¯·æç°
3. ç®¡ç†å‘˜å®Œæˆæç°
4. è®¡ç®—å¯æç°æ”¶ç›Šï¼š`grossEarnings - totalWithdrawn`
5. éªŒè¯è®¡ç®—ç»“æœæ˜¯å¦æ­£ç¡®

### 3. æ•°æ®éªŒè¯

**æŸ¥è¯¢ç”¨æˆ·æ•°æ®**ï¼š
```sql
-- æ£€æŸ¥ç”¨æˆ·æç°è®°å½•å’Œ usdt_total
SELECT 
    u.address,
    u.usdt_total,
    u.usdt_locked,
    u.last_settlement_time,
    SUM(CASE WHEN w.status IN ('Completed', 'Pending') THEN w.amount::numeric ELSE 0 END) as total_withdrawn
FROM users u
LEFT JOIN withdrawals w ON LOWER(u.address) = LOWER(w.address)
WHERE LOWER(u.address) = LOWER('ç”¨æˆ·åœ°å€')
GROUP BY u.address, u.usdt_total, u.usdt_locked, u.last_settlement_time;
```

**éªŒè¯é€»è¾‘**ï¼š
- `usdt_total` åº”è¯¥ç­‰äº `realTimeEarnings - totalWithdrawn`ï¼ˆåœ¨ç”³è¯·æç°æ—¶ï¼‰
- `usdt_total` ä¸åº”è¯¥åœ¨ `completeWithdrawal` æ—¶å†æ¬¡æ‰£é™¤

---

## ğŸ“ ä¿®å¤æ€»ç»“

### ä¿®å¤å†…å®¹

1. **ä¿®å¤äº† `completeWithdrawal` å‡½æ•°**ï¼š
   - ç§»é™¤äº†å¯¹ `usdt_total` çš„é‡å¤æ‰£é™¤
   - `usdt_total` åœ¨å®Œæˆæç°æ—¶ä¿æŒä¸å˜

2. **æ·»åŠ äº†è¯¦ç»†æ³¨é‡Š**ï¼š
   - è¯´æ˜äº†ä¸ºä»€ä¹ˆä¸åº”è¯¥å†æ¬¡æ‰£é™¤ `usdt_total`
   - è§£é‡Šäº† `usdt_total` åœ¨ `applyWithdraw` æ—¶å·²ç»æ­£ç¡®æ›´æ–°

### ä¿®å¤æ•ˆæœ

- âœ… ç”¨æˆ·æ”¶ç›Šä¸å†è¢«é‡å¤æ‰£é™¤
- âœ… æ”¶ç›Šè®¡ç®—é€»è¾‘æ­£ç¡®
- âœ… æ•°æ®ä¸€è‡´æ€§å¾—åˆ°ä¿è¯
- âœ… ç”¨æˆ·ä½“éªŒæ”¹å–„

### åç»­å»ºè®®

1. **æ•°æ®ä¿®å¤**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
   - æ£€æŸ¥å†å²æ•°æ®ï¼Œæ‰¾å‡ºè¢«é‡å¤æ‰£é™¤çš„ç”¨æˆ·
   - ä¿®å¤è¿™äº›ç”¨æˆ·çš„ `usdt_total` å€¼

2. **ç›‘æ§**ï¼š
   - ç›‘æ§æç°åŠŸèƒ½ï¼Œç¡®ä¿ä¸å†å‡ºç°é‡å¤æ‰£é™¤
   - è®°å½•æç°æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

3. **æµ‹è¯•**ï¼š
   - è¿›è¡Œå®Œæ•´çš„æç°æµç¨‹æµ‹è¯•
   - éªŒè¯æ”¶ç›Šè®¡ç®—æ˜¯å¦æ­£ç¡®

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **ä¿®å¤æ–‡ä»¶**ï¼š
  - `rabbit-ai-backend/src/services/admin.ts`ï¼ˆç¬¬ 436-445 è¡Œï¼‰

- **ç›¸å…³æ–‡ä»¶**ï¼š
  - `rabbit-ai-backend/src/services/withdraw.ts`ï¼ˆ`applyWithdraw` å‡½æ•°ï¼‰
  - `rabbit-ai-backend/src/services/earnings.ts`ï¼ˆæ”¶ç›Šè®¡ç®—é€»è¾‘ï¼‰

- **å®¡æŸ¥æŠ¥å‘Š**ï¼š
  - `rabbit-ai-admin/æµåŠ¨æ€§æ”¶ç›Šæ± è®¡ç®—é€»è¾‘å®¡æŸ¥æŠ¥å‘Š.md`

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2026-01-05  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ  
**Git æäº¤**ï¼š`05b382d` - "ä¿®å¤completeWithdrawalå‡½æ•°ï¼šç§»é™¤å¯¹usdt_totalçš„é‡å¤æ‰£é™¤"  
**ä¼˜å…ˆçº§**ï¼šğŸ”´ é«˜ä¼˜å…ˆçº§  
**å½±å“èŒƒå›´**ï¼šæ‰€æœ‰ç”¨æˆ·çš„æç°åŠŸèƒ½

