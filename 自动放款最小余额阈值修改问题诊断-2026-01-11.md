# è‡ªåŠ¨æ”¾æ¬¾æœ€å°ä½™é¢é˜ˆå€¼ä¿®æ”¹é—®é¢˜è¯Šæ–­æŠ¥å‘Š

**è¯Šæ–­æ—¶é—´**: 2026-01-11  
**é—®é¢˜æè¿°**: ç”¨æˆ·åœ¨ç®¡ç†åå°ä¿®æ”¹æœ€å°ä½™é¢é˜ˆå€¼ä¸º20,ä½†é¡µé¢åˆ·æ–°åä»æ˜¾ç¤º50

---

## ğŸ” é—®é¢˜åˆ†æ

### ç”¨æˆ·æ“ä½œ
1. æ‰“å¼€è‡ªåŠ¨æ”¾æ¬¾é…ç½®é¡µé¢
2. ä¿®æ”¹"æœ€å°ä½™é¢é˜ˆå€¼"ä»50æ”¹ä¸º20
3. ç‚¹å‡»"ä¿å­˜é…ç½®"

### è§‚å¯Ÿåˆ°çš„ç°è±¡
1. âœ… åç«¯æ—¥å¿—æ˜¾ç¤º: `[AutoPayout] âœ… é…ç½®å·²æ›´æ–°: é’±åŒ…åœ°å€=0xa90cf50e60fb177548d6eb257a896b8f625e297e, é˜ˆå€¼=10 USDT, å¯ç”¨=true`
2. âŒ æ—¥å¿—ä¸­**æ²¡æœ‰æ˜¾ç¤ºæœ€å°ä½™é¢çš„å€¼**
3. âŒ é¡µé¢åˆ·æ–°å,æœ€å°ä½™é¢é˜ˆå€¼è¿˜æ˜¯æ˜¾ç¤º**50**

---

## ğŸ› é—®é¢˜å®šä½

### é—®é¢˜1: æ—¥å¿—ä¸å®Œæ•´

**æ–‡ä»¶**: `rabbit-ai-backend/src/services/autoPayout.ts`  
**ä½ç½®**: ç¬¬206è¡Œ

```typescript
console.log(`[AutoPayout] âœ… é…ç½®å·²æ›´æ–°: é’±åŒ…åœ°å€=${address}, é˜ˆå€¼=${params.threshold} USDT, å¯ç”¨=${params.enabled}`);
```

**é—®é¢˜**: æ—¥å¿—åªæ‰“å°äº†é’±åŒ…åœ°å€ã€é˜ˆå€¼å’Œå¯ç”¨çŠ¶æ€,**æ²¡æœ‰æ‰“å°æœ€å°ä½™é¢å’Œæ¯æ—¥é™é¢**

**å»ºè®®ä¿®å¤**:
```typescript
console.log(`[AutoPayout] âœ… é…ç½®å·²æ›´æ–°: é’±åŒ…åœ°å€=${address}, é˜ˆå€¼=${params.threshold} USDT, æœ€å°ä½™é¢=${params.minBalance || 100} USDT, æ¯æ—¥é™é¢=${params.dailyLimit || 'æ— é™åˆ¶'}, å¯ç”¨=${params.enabled}`);
```

---

### é—®é¢˜2: éœ€è¦æ£€æŸ¥æ•°æ®åº“å®é™…ä¿å­˜å€¼

**å¯èƒ½åŸå› **:
1. âœ… å‰ç«¯æ­£ç¡®ä¼ é€’äº† `minBalance: 20`
2. âœ… åç«¯æ­£ç¡®æ¥æ”¶äº†å‚æ•°
3. âœ… åç«¯ä»£ç æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“ `min_balance_usdt: params.minBalance || 100.0`
4. â“ ä½†éœ€è¦ç¡®è®¤æ•°æ®åº“ä¸­æ˜¯å¦çœŸçš„ä¿å­˜äº†20

---

## ğŸ“Š è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥æ•°æ®åº“å½“å‰å€¼

éœ€è¦æŸ¥è¯¢æ•°æ®åº“ `auto_payout_config` è¡¨:

```sql
SELECT 
  wallet_address,
  threshold_usdt,
  min_balance_usdt,
  daily_limit_usdt,
  enabled,
  updated_at,
  updated_by
FROM auto_payout_config
ORDER BY updated_at DESC
LIMIT 1;
```

**é¢„æœŸç»“æœ**:
- `min_balance_usdt` åº”è¯¥æ˜¯ `20`

**å¦‚æœæ˜¯50**: è¯´æ˜ä¿å­˜é€»è¾‘æœ‰é—®é¢˜
**å¦‚æœæ˜¯20**: è¯´æ˜æ˜¯å‰ç«¯è·å–é…ç½®çš„é—®é¢˜

---

### æ­¥éª¤2: æ£€æŸ¥å‰ç«¯è·å–é…ç½®é€»è¾‘

**æ–‡ä»¶**: `rabbit-ai-admin/pages/AutoPayoutConfig.tsx`  
**ä½ç½®**: ç¬¬48-70è¡Œ

```typescript
const fetchConfig = async () => {
  try {
    setLoading(true);
    const data = await getAutoPayoutConfig();
    
    if (data.ok) {
      setConfig(data);
      setThreshold(data.threshold);
      setEnabled(data.enabled);
      setMinBalance(data.minBalance);  // ğŸ” è¿™é‡Œè¯»å–æœ€å°ä½™é¢
      setDailyLimit(data.dailyLimit ? data.dailyLimit.toString() : '');
      setPrivateKey('');
    } else {
      showNotification('error', 'åŠ è½½é…ç½®å¤±è´¥');
    }
  } catch (error: any) {
    console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
    showNotification('error', error?.message || 'åŠ è½½é…ç½®å¤±è´¥');
  } finally {
    setLoading(false);
  }
};
```

è¿™é‡Œçš„é€»è¾‘çœ‹èµ·æ¥æ˜¯æ­£ç¡®çš„ã€‚

---

### æ­¥éª¤3: æ£€æŸ¥åç«¯è·å–é…ç½®é€»è¾‘

**æ–‡ä»¶**: `rabbit-ai-backend/src/services/autoPayout.ts`  
**ä½ç½®**: ç¬¬209-245è¡Œ

```typescript
async getConfig(): Promise<{
  walletAddress: string | null;
  threshold: number;
  enabled: boolean;
  minBalance: number;
  dailyLimit: number | null;
  currentBalance: string;
}> {
  const { data } = await supabase
    .from('auto_payout_config')
    .select('*')
    .limit(1)
    .maybeSingle();

  let currentBalance = '0';
  if (data && data.enabled && this.walletAddress && this.usdtContract) {
    try {
      const balanceWei = await this.usdtContract.balanceOf(this.walletAddress);
      const decimals = await this.usdtContract.decimals();
      currentBalance = ethers.utils.formatUnits(balanceWei, decimals);
    } catch (error) {
      console.error('[AutoPayout] è·å–ä½™é¢å¤±è´¥:', error);
    }
  }

  return {
    walletAddress: data?.wallet_address || null,
    threshold: data ? parseFloat(data.threshold_usdt) : 10.0,
    enabled: data?.enabled || false,
    minBalance: data ? parseFloat(data.min_balance_usdt) : 100.0,  // ğŸ” è¿™é‡Œè¯»å–æœ€å°ä½™é¢
    dailyLimit: data?.daily_limit_usdt ? parseFloat(data.daily_limit_usdt) : null,
    currentBalance,
  };
}
```

è¿™é‡Œçš„é€»è¾‘ä¹Ÿæ˜¯æ­£ç¡®çš„ã€‚

---

## ğŸ¯ å¯èƒ½çš„åŸå› 

### åŸå› 1: å‰ç«¯è¾“å…¥å€¼è¢«æ„å¤–é‡ç½®

**å¯èƒ½åœºæ™¯**: ç”¨æˆ·ä¿®æ”¹äº†è¾“å…¥æ¡†,ä½†ç”±äºæŸç§åŸå› (å¦‚çŠ¶æ€æ›´æ–°),è¾“å…¥å€¼è¢«é‡ç½®å›åŸå€¼

**æ’æŸ¥æ–¹æ³•**: 
1. åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­æŸ¥çœ‹ Network è¯·æ±‚
2. æ£€æŸ¥ POST `/api/admin/system/auto-payout/configure` çš„è¯·æ±‚ body
3. ç¡®è®¤ `minBalance` å­—æ®µçš„å€¼æ˜¯å¦ä¸º 20

---

### åŸå› 2: å‰ç«¯ä¼ é€’çš„æ˜¯å­—ç¬¦ä¸²,åç«¯è§£æå¤±è´¥

**å¯èƒ½åœºæ™¯**: å‰ç«¯ä¼ é€’äº† `minBalance: "20"` (å­—ç¬¦ä¸²), åç«¯ schema ä½¿ç”¨ `z.coerce.number()` åº”è¯¥èƒ½æ­£ç¡®è½¬æ¢

**æ’æŸ¥æ–¹æ³•**:
1. æ£€æŸ¥è¯·æ±‚ body
2. ç¡®è®¤ç±»å‹æ˜¯å¦æ­£ç¡®

---

### åŸå› 3: æ•°æ®åº“ upsert å†²çª

**å¯èƒ½åœºæ™¯**: `onConflict: 'id'` å¯èƒ½æ²¡æœ‰æ­£ç¡®æ›´æ–°è®°å½•

**åç«¯ä»£ç **:
```typescript
.upsert({
  // ... fields
  min_balance_usdt: params.minBalance || 100.0,
}, {
  onConflict: 'id',  // ğŸ” è¿™é‡Œå¯èƒ½æœ‰é—®é¢˜
});
```

**é—®é¢˜**: å¦‚æœè¡¨ä¸­æœ‰å¤šæ¡è®°å½•,æˆ–è€… `id` ä¸æ˜¯æ­£ç¡®çš„å†²çªå­—æ®µ,å¯èƒ½å¯¼è‡´æ›´æ–°å¤±è´¥

**ä¿®å¤å»ºè®®**:
```typescript
// æ–¹æ¡ˆ1: å…ˆåˆ é™¤å†æ’å…¥
await supabase.from('auto_payout_config').delete();
await supabase.from('auto_payout_config').insert({...});

// æ–¹æ¡ˆ2: ä½¿ç”¨æ­£ç¡®çš„æ›´æ–°é€»è¾‘
const { data: existing } = await supabase
  .from('auto_payout_config')
  .select('id')
  .limit(1)
  .maybeSingle();

if (existing) {
  await supabase
    .from('auto_payout_config')
    .update({...})
    .eq('id', existing.id);
} else {
  await supabase
    .from('auto_payout_config')
    .insert({...});
}
```

---

## ğŸ”§ ç«‹å³è¯Šæ–­å‘½ä»¤

### 1. æŸ¥çœ‹æµè§ˆå™¨ Network è¯·æ±‚

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. ä¿®æ”¹æœ€å°ä½™é¢é˜ˆå€¼ä¸º 20
4. ç‚¹å‡»"ä¿å­˜é…ç½®"
5. æŸ¥æ‰¾ `auto-payout/configure` è¯·æ±‚
6. æŸ¥çœ‹ Request Payload:

```json
{
  "privateKey": "0x0000...",
  "threshold": 10,
  "enabled": true,
  "minBalance": 20,  // ğŸ” ç¡®è®¤è¿™ä¸ªå€¼
  "dailyLimit": null
}
```

---

### 2. æŸ¥è¯¢æ•°æ®åº“å½“å‰å€¼

ä½¿ç”¨ Supabase MCP å·¥å…·:

```sql
SELECT * FROM auto_payout_config ORDER BY updated_at DESC LIMIT 1;
```

---

### 3. æŸ¥çœ‹åç«¯æ—¥å¿—

æ£€æŸ¥ Render åç«¯æ—¥å¿—,å¯»æ‰¾:
- `[AutoPayout] âœ… é…ç½®å·²æ›´æ–°`
- æ˜¯å¦æœ‰ä»»ä½•é”™è¯¯æ—¥å¿—

---

## âœ… ä¿®å¤å»ºè®®

### ä¿®å¤1: æ”¹è¿›æ—¥å¿—è¾“å‡º (ä¼˜å…ˆçº§: P2)

**æ–‡ä»¶**: `rabbit-ai-backend/src/services/autoPayout.ts`  
**ä¿®æ”¹**: ç¬¬206è¡Œ

```typescript
// ä¿®æ”¹å‰
console.log(`[AutoPayout] âœ… é…ç½®å·²æ›´æ–°: é’±åŒ…åœ°å€=${address}, é˜ˆå€¼=${params.threshold} USDT, å¯ç”¨=${params.enabled}`);

// ä¿®æ”¹å
console.log(`[AutoPayout] âœ… é…ç½®å·²æ›´æ–°: é’±åŒ…åœ°å€=${address}, é˜ˆå€¼=${params.threshold} USDT, æœ€å°ä½™é¢=${params.minBalance || 100} USDT, æ¯æ—¥é™é¢=${params.dailyLimit || 'æ— é™åˆ¶'}, å¯ç”¨=${params.enabled}`);
```

---

### ä¿®å¤2: æ”¹è¿›æ•°æ®åº“æ›´æ–°é€»è¾‘ (ä¼˜å…ˆçº§: P1 - å¦‚æœç¡®è®¤æ˜¯upserté—®é¢˜)

**æ–‡ä»¶**: `rabbit-ai-backend/src/services/autoPayout.ts`  
**ä¿®æ”¹**: ç¬¬172-186è¡Œ

```typescript
// 3. ä¿å­˜é…ç½®åˆ°æ•°æ®åº“
// å…ˆæŸ¥è¯¢ç°æœ‰é…ç½®
const { data: existing } = await supabase
  .from('auto_payout_config')
  .select('id')
  .limit(1)
  .maybeSingle();

let error;
if (existing) {
  // æ›´æ–°ç°æœ‰é…ç½®
  const updateResult = await supabase
    .from('auto_payout_config')
    .update({
      private_key_encrypted: encryptedKey,
      wallet_address: address,
      threshold_usdt: params.threshold,
      enabled: params.enabled,
      min_balance_usdt: params.minBalance || 100.0,
      daily_limit_usdt: params.dailyLimit || null,
      updated_at: new Date().toISOString(),
      updated_by: updatedBy || null,
    })
    .eq('id', existing.id);
  error = updateResult.error;
} else {
  // æ’å…¥æ–°é…ç½®
  const insertResult = await supabase
    .from('auto_payout_config')
    .insert({
      private_key_encrypted: encryptedKey,
      wallet_address: address,
      threshold_usdt: params.threshold,
      enabled: params.enabled,
      min_balance_usdt: params.minBalance || 100.0,
      daily_limit_usdt: params.dailyLimit || null,
      updated_at: new Date().toISOString(),
      updated_by: updatedBy || null,
    });
  error = insertResult.error;
}

if (error) {
  console.error('[AutoPayout] ä¿å­˜é…ç½®å¤±è´¥:', error);
  throw new Error(`Failed to save config: ${error.message}`);
}
```

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ
1. **æŸ¥çœ‹æµè§ˆå™¨ Network è¯·æ±‚**,ç¡®è®¤å‰ç«¯æ˜¯å¦ä¼ é€’äº† `minBalance: 20`
2. **æŸ¥è¯¢æ•°æ®åº“**,ç¡®è®¤ `min_balance_usdt` çš„å®é™…å€¼
3. **æŸ¥çœ‹åç«¯æ—¥å¿—**,ç¡®è®¤æ˜¯å¦æœ‰é”™è¯¯

### æ ¹æ®è¯Šæ–­ç»“æœ
- **å¦‚æœå‰ç«¯æ²¡ä¼ é€’**: æ£€æŸ¥å‰ç«¯ä¿å­˜é€»è¾‘
- **å¦‚æœæ•°æ®åº“æ²¡ä¿å­˜**: å®æ–½ä¿®å¤2 (æ”¹è¿›æ•°æ®åº“æ›´æ–°é€»è¾‘)
- **å¦‚æœæ•°æ®åº“å·²ä¿å­˜**: æ£€æŸ¥å‰ç«¯è·å–é…ç½®é€»è¾‘

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-11  
**é—®é¢˜çº§åˆ«**: ğŸŸ¡ P1 - åŠŸèƒ½å¼‚å¸¸  
**éœ€è¦ç«‹å³è¯Šæ–­**: æ˜¯

