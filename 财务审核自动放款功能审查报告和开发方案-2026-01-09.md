# è´¢åŠ¡å®¡æ ¸è‡ªåŠ¨æ”¾æ¬¾åŠŸèƒ½å®¡æŸ¥æŠ¥å‘Šå’Œå¼€å‘æ–¹æ¡ˆ

**æ—¥æœŸ**: 2026-01-09  
**åŠŸèƒ½**: è‡ªåŠ¨æ”¾æ¬¾åŠŸèƒ½ï¼ˆåŸºäºé‡‘é¢é˜ˆå€¼ï¼‰  
**çŠ¶æ€**: ğŸ“‹ å¾…å¼€å‘

---

## ğŸ“‹ éœ€æ±‚åˆ†æ

### ç”¨æˆ·éœ€æ±‚

1. **å¯¼å…¥é’±åŒ…ç§é’¥**: ç®¡ç†å‘˜å¯ä»¥å¯¼å…¥å‡ºæ¬¾é’±åŒ…çš„ç§é’¥ï¼Œç”¨äºè‡ªåŠ¨æ”¾æ¬¾
2. **é‡‘é¢é˜ˆå€¼é…ç½®**: ä½äº 10 USDT çš„æç°è‡ªåŠ¨æ”¾æ¬¾ï¼Œé«˜äº 10 USDT éœ€è¦æ‰‹åŠ¨å®¡æ ¸
3. **è‡ªåŠ¨æ”¾æ¬¾æµç¨‹**: ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ç¬¦åˆæ¡ä»¶çš„æç°ï¼Œè‡ªåŠ¨å‘é€ USDT è½¬è´¦äº¤æ˜“

### ä¸šåŠ¡ä»·å€¼

- âœ… **æé«˜æ•ˆç‡**: å‡å°‘å°é¢æç°çš„äººå·¥å®¡æ ¸å·¥ä½œé‡
- âœ… **å¿«é€Ÿå“åº”**: ç”¨æˆ·å°é¢æç°å¯ä»¥ç«‹å³åˆ°è´¦
- âœ… **é™ä½è¿è¥æˆæœ¬**: è‡ªåŠ¨åŒ–å¤„ç†å¤§é‡å°é¢æç°

---

## ğŸ” å½“å‰æ”¾æ¬¾é€»è¾‘å®¡æŸ¥

### 1. å½“å‰æ”¾æ¬¾æ–¹å¼

#### æ–¹å¼ 1: MetaMask è‡ªåŠ¨å‘æ”¾ï¼ˆæ¨èï¼‰

**æµç¨‹**:
```
ç®¡ç†å‘˜ç‚¹å‡»"å‘æ”¾"æŒ‰é’®
    â†“
å‰ç«¯éªŒè¯ï¼ˆé’±åŒ…è¿æ¥ã€ä½™é¢æ£€æŸ¥ï¼‰
    â†“
æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    â†“
ç®¡ç†å‘˜ç¡®è®¤
    â†“
å‰ç«¯è°ƒç”¨ MetaMask transferUSDT
    â†“
ç­‰å¾…äº¤æ˜“ç¡®è®¤
    â†“
è°ƒç”¨åç«¯ completeWithdrawal API
    â†“
æ›´æ–°æ•°æ®åº“çŠ¶æ€
```

**ä»£ç ä½ç½®**: `rabbit-ai-admin/pages/FinanceOps.tsx` - `handleRelease` å‡½æ•°

**ç‰¹ç‚¹**:
- âœ… éœ€è¦ç®¡ç†å‘˜æ‰‹åŠ¨æ“ä½œ
- âœ… éœ€è¦è¿æ¥ MetaMask é’±åŒ…
- âœ… å‰ç«¯ç›´æ¥å‘é€äº¤æ˜“
- âœ… å®æ—¶æ£€æŸ¥ä½™é¢

#### æ–¹å¼ 2: æ‰‹åŠ¨è¾“å…¥äº¤æ˜“å“ˆå¸Œ

**æµç¨‹**:
```
ç®¡ç†å‘˜ç‚¹å‡»"æ‰¹å‡†æç°"æŒ‰é’®
    â†“
æ‰“å¼€æ‰¹å‡†å¯¹è¯æ¡†
    â†“
ç®¡ç†å‘˜åœ¨é“¾ä¸Šå®Œæˆè½¬è´¦ï¼ˆä½¿ç”¨ MetaMask æˆ–å…¶ä»–é’±åŒ…ï¼‰
    â†“
è¾“å…¥äº¤æ˜“å“ˆå¸Œ
    â†“
ç‚¹å‡»"ç¡®è®¤å¹¶åŒæ­¥çŠ¶æ€"
    â†“
è°ƒç”¨åç«¯ completeWithdrawal API
    â†“
æ›´æ–°æ•°æ®åº“çŠ¶æ€
```

**ä»£ç ä½ç½®**: `rabbit-ai-admin/pages/FinanceOps.tsx` - `handleCompleteApprove` å‡½æ•°

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒä½¿ç”¨ä»»ä½•é’±åŒ…ï¼ˆä¸é™äº MetaMaskï¼‰
- âœ… ç®¡ç†å‘˜æ‰‹åŠ¨åœ¨é“¾ä¸Šå®Œæˆè½¬è´¦
- âœ… åç«¯éªŒè¯äº¤æ˜“æœ‰æ•ˆæ€§

---

### 2. åç«¯éªŒè¯é€»è¾‘

**ä½ç½®**: `rabbit-ai-backend/src/services/admin.ts` - `completeWithdrawal` å‡½æ•°

**éªŒè¯é¡¹**:
1. âœ… **æç°è®°å½•å­˜åœ¨æ€§**: éªŒè¯æç°è®°å½•æ˜¯å¦å­˜åœ¨
2. âœ… **çŠ¶æ€éªŒè¯**: éªŒè¯çŠ¶æ€æ˜¯å¦ä¸º `Pending`
3. âœ… **é˜²é‡æ”¾æ”»å‡»**: éªŒè¯äº¤æ˜“å“ˆå¸Œæ˜¯å¦å·²è¢«ä½¿ç”¨
4. âœ… **é“¾ä¸Šäº¤æ˜“éªŒè¯**:
   - éªŒè¯äº¤æ˜“æ˜¯å¦å­˜åœ¨
   - éªŒè¯äº¤æ˜“æ˜¯å¦æˆåŠŸï¼ˆ`status === 1`ï¼‰
   - éªŒè¯æ¥æ”¶æ–¹æ˜¯å¦ä¸ºæç°ç”¨æˆ·åœ°å€
   - éªŒè¯é‡‘é¢æ˜¯å¦åŒ¹é…
   - âš ï¸ **ä¸éªŒè¯å‘é€æ–¹åœ°å€**ï¼ˆå…è®¸ä»ä»»ä½•åœ°å€è½¬å‡ºï¼‰

**å…³é”®ä»£ç **:
```typescript
// éªŒè¯é“¾ä¸Šäº¤æ˜“
const receipt = await provider.getTransactionReceipt(payoutTxHash);
if (!receipt) throw new ApiError('TX_NOT_FOUND', 'Payout tx receipt not found', 404);
if (receipt.status !== 1) throw new ApiError('TX_FAILED', 'Payout tx failed', 400);

// éªŒè¯ USDT Transfer äº‹ä»¶
const iface = new ethers.utils.Interface(ERC20_ABI);
// åªéªŒè¯æ¥æ”¶æ–¹å’Œé‡‘é¢ï¼Œä¸éªŒè¯å‘é€æ–¹
if (to === userAddr && value.eq(expectedValue)) {
  matched = true;
}
```

---

### 3. å‰ç«¯éªŒè¯é€»è¾‘

**ä½ç½®**: `rabbit-ai-admin/pages/FinanceOps.tsx`

**éªŒè¯é¡¹**:
1. âœ… **é’±åŒ…è¿æ¥éªŒè¯**: æ£€æŸ¥é’±åŒ…æ˜¯å¦å·²è¿æ¥
2. âœ… **USDT åˆçº¦ä¿¡æ¯éªŒè¯**: æ£€æŸ¥åˆçº¦ä¿¡æ¯æ˜¯å¦å·²åŠ è½½
3. âœ… **é’±åŒ…ä½™é¢éªŒè¯**: 
   - ç¡®è®¤å‰æ£€æŸ¥ä½™é¢
   - ç¡®è®¤åã€å‘é€å‰å†æ¬¡æ£€æŸ¥ä½™é¢ï¼ˆé˜²æ­¢åœ¨ç¡®è®¤æœŸé—´ä½™é¢å˜åŒ–ï¼‰

---

## ğŸ’¡ è‡ªåŠ¨æ”¾æ¬¾åŠŸèƒ½å¼€å‘æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: åç«¯è‡ªåŠ¨æ”¾æ¬¾ï¼ˆæ¨èï¼‰â­

#### 1.1 æ¶æ„è®¾è®¡

**æ ¸å¿ƒæ€è·¯**:
- åœ¨åç«¯å®ç°è‡ªåŠ¨æ”¾æ¬¾é€»è¾‘
- ä½¿ç”¨ç§é’¥åˆ›å»ºé’±åŒ…å®ä¾‹
- å®šæ—¶æ£€æŸ¥å¾…å®¡æ‰¹æç°ï¼Œè‡ªåŠ¨å¤„ç†ç¬¦åˆæ¡ä»¶çš„æç°

**ä¼˜åŠ¿**:
- âœ… å®‰å…¨æ€§é«˜ï¼šç§é’¥å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œä¸æš´éœ²ç»™å‰ç«¯
- âœ… å¯é æ€§é«˜ï¼šä¸ä¾èµ–å‰ç«¯çŠ¶æ€ï¼Œ24/7 è¿è¡Œ
- âœ… æ˜“äºç›‘æ§ï¼šå¯ä»¥åœ¨åç«¯æ·»åŠ æ—¥å¿—å’Œç›‘æ§

**åŠ£åŠ¿**:
- âš ï¸ éœ€è¦æœåŠ¡å™¨ç«¯å­˜å‚¨ç§é’¥ï¼ˆéœ€è¦åŠ å¯†å­˜å‚¨ï¼‰
- âš ï¸ éœ€è¦å®šæ—¶ä»»åŠ¡æˆ–äº‹ä»¶é©±åŠ¨æœºåˆ¶

#### 1.2 æŠ€æœ¯å®ç°

**åç«¯æ–°å¢åŠŸèƒ½**:

1. **ç§é’¥ç®¡ç† API**:
   ```typescript
   // POST /api/admin/system/auto-payout/configure
   {
     privateKey: string,  // åŠ å¯†åçš„ç§é’¥
     threshold: number,   // è‡ªåŠ¨æ”¾æ¬¾é˜ˆå€¼ï¼ˆé»˜è®¤ 10 USDTï¼‰
     enabled: boolean     // æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ”¾æ¬¾
   }
   ```

2. **è‡ªåŠ¨æ”¾æ¬¾æœåŠ¡**:
   ```typescript
   // src/services/autoPayout.ts
   export class AutoPayoutService {
     private wallet: ethers.Wallet;
     private threshold: number;
     private enabled: boolean;
     
     async processPendingWithdrawals() {
       // 1. è·å–æ‰€æœ‰å¾…å®¡æ‰¹æç°
       // 2. ç­›é€‰é‡‘é¢ < threshold çš„æç°
       // 3. æ£€æŸ¥é’±åŒ…ä½™é¢
       // 4. å‘é€ USDT è½¬è´¦äº¤æ˜“
       // 5. ç­‰å¾…äº¤æ˜“ç¡®è®¤
       // 6. è°ƒç”¨ completeWithdrawal
     }
   }
   ```

3. **å®šæ—¶ä»»åŠ¡**:
   ```typescript
   // src/index.ts
   // æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡å¾…å®¡æ‰¹æç°
   setInterval(async () => {
     if (autoPayoutService.isEnabled()) {
       await autoPayoutService.processPendingWithdrawals();
     }
   }, 30000);
   ```

**å‰ç«¯æ–°å¢åŠŸèƒ½**:

1. **è‡ªåŠ¨æ”¾æ¬¾é…ç½®é¡µé¢**:
   - ç§é’¥è¾“å…¥ï¼ˆåŠ å¯†ä¼ è¾“ï¼‰
   - é‡‘é¢é˜ˆå€¼é…ç½®
   - å¯ç”¨/ç¦ç”¨å¼€å…³
   - è‡ªåŠ¨æ”¾æ¬¾æ—¥å¿—æŸ¥çœ‹

2. **æç°åˆ—è¡¨æ˜¾ç¤º**:
   - æ ‡è®°å“ªäº›æç°ä¼šè¢«è‡ªåŠ¨æ”¾æ¬¾
   - æ˜¾ç¤ºè‡ªåŠ¨æ”¾æ¬¾çŠ¶æ€

#### 1.3 å®‰å…¨æªæ–½

1. **ç§é’¥åŠ å¯†å­˜å‚¨**:
   - ä½¿ç”¨ç¯å¢ƒå˜é‡åŠ å¯†å¯†é’¥
   - ç§é’¥åŠ å¯†åå­˜å‚¨åœ¨æ•°æ®åº“
   - è¿è¡Œæ—¶è§£å¯†

2. **æƒé™æ§åˆ¶**:
   - åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥é…ç½®è‡ªåŠ¨æ”¾æ¬¾
   - è®°å½•æ‰€æœ‰é…ç½®å˜æ›´æ—¥å¿—

3. **ä½™é¢ä¿æŠ¤**:
   - è®¾ç½®æœ€å°ä½™é¢é˜ˆå€¼ï¼ˆå¦‚ 100 USDTï¼‰
   - ä½™é¢ä¸è¶³æ—¶è‡ªåŠ¨åœæ­¢è‡ªåŠ¨æ”¾æ¬¾
   - å‘é€å‘Šè­¦é€šçŸ¥

4. **äº¤æ˜“é™åˆ¶**:
   - å•æ¬¡è‡ªåŠ¨æ”¾æ¬¾é‡‘é¢é™åˆ¶
   - æ¯æ—¥è‡ªåŠ¨æ”¾æ¬¾æ€»é¢é™åˆ¶
   - å•ç”¨æˆ·æ¯æ—¥è‡ªåŠ¨æ”¾æ¬¾æ¬¡æ•°é™åˆ¶

---

### æ–¹æ¡ˆ 2: å‰ç«¯è‡ªåŠ¨æ”¾æ¬¾

#### 2.1 æ¶æ„è®¾è®¡

**æ ¸å¿ƒæ€è·¯**:
- åœ¨å‰ç«¯å®ç°è‡ªåŠ¨æ”¾æ¬¾é€»è¾‘
- ä½¿ç”¨ç§é’¥åˆ›å»ºé’±åŒ…å®ä¾‹ï¼ˆåœ¨æµè§ˆå™¨ä¸­ï¼‰
- é¡µé¢æ‰“å¼€æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶å¤„ç†ç¬¦åˆæ¡ä»¶çš„æç°

**ä¼˜åŠ¿**:
- âœ… å®ç°ç®€å•ï¼šä¸éœ€è¦åç«¯æ”¹åŠ¨
- âœ… ç§é’¥ä¸å­˜å‚¨åœ¨æœåŠ¡å™¨

**åŠ£åŠ¿**:
- âŒ å®‰å…¨æ€§ä½ï¼šç§é’¥æš´éœ²åœ¨æµè§ˆå™¨ä¸­
- âŒ å¯é æ€§ä½ï¼šä¾èµ–å‰ç«¯é¡µé¢æ‰“å¼€
- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼šéœ€è¦é¡µé¢ä¸€ç›´æ‰“å¼€

**ç»“è®º**: âŒ **ä¸æ¨èæ­¤æ–¹æ¡ˆ**

---

### æ–¹æ¡ˆ 3: æ··åˆæ–¹æ¡ˆï¼ˆå‰ç«¯é…ç½® + åç«¯æ‰§è¡Œï¼‰

#### 3.1 æ¶æ„è®¾è®¡

**æ ¸å¿ƒæ€è·¯**:
- å‰ç«¯é…ç½®è‡ªåŠ¨æ”¾æ¬¾å‚æ•°ï¼ˆé˜ˆå€¼ã€å¯ç”¨çŠ¶æ€ï¼‰
- åç«¯å®šæ—¶æ£€æŸ¥å¹¶æ‰§è¡Œè‡ªåŠ¨æ”¾æ¬¾
- ç§é’¥é€šè¿‡å®‰å…¨æ–¹å¼ä¼ è¾“åˆ°åç«¯ï¼ˆä¸€æ¬¡æ€§é…ç½®ï¼‰

**ä¼˜åŠ¿**:
- âœ… å®‰å…¨æ€§é«˜ï¼šç§é’¥å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯
- âœ… å¯é æ€§é«˜ï¼šåç«¯ 24/7 è¿è¡Œ
- âœ… çµæ´»æ€§é«˜ï¼šå‰ç«¯å¯ä»¥éšæ—¶è°ƒæ•´é…ç½®

**å®ç°ç»†èŠ‚**:
- å‰ç«¯ï¼šé…ç½®ç•Œé¢ + çŠ¶æ€ç›‘æ§
- åç«¯ï¼šè‡ªåŠ¨æ”¾æ¬¾æœåŠ¡ + å®šæ—¶ä»»åŠ¡
- é€šä¿¡ï¼šé€šè¿‡ç³»ç»Ÿé…ç½® API

---

## ğŸ› ï¸ æ¨èæ–¹æ¡ˆè¯¦ç»†è®¾è®¡ï¼ˆæ–¹æ¡ˆ 1ï¼‰

### 1. æ•°æ®åº“è®¾è®¡

**æ–°å¢è¡¨**: `auto_payout_config`

```sql
CREATE TABLE auto_payout_config (
  id SERIAL PRIMARY KEY,
  private_key_encrypted TEXT NOT NULL,  -- åŠ å¯†åçš„ç§é’¥
  wallet_address TEXT NOT NULL,         -- é’±åŒ…åœ°å€ï¼ˆç”¨äºéªŒè¯ï¼‰
  threshold_usdt NUMERIC(18, 6) NOT NULL DEFAULT 10.0,  -- è‡ªåŠ¨æ”¾æ¬¾é˜ˆå€¼
  enabled BOOLEAN NOT NULL DEFAULT false,  -- æ˜¯å¦å¯ç”¨
  min_balance_usdt NUMERIC(18, 6) NOT NULL DEFAULT 100.0,  -- æœ€å°ä½™é¢é˜ˆå€¼
  daily_limit_usdt NUMERIC(18, 6),      -- æ¯æ—¥è‡ªåŠ¨æ”¾æ¬¾æ€»é¢é™åˆ¶
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_by TEXT                        -- æœ€åæ›´æ–°äºº
);
```

**æ–°å¢è¡¨**: `auto_payout_logs`

```sql
CREATE TABLE auto_payout_logs (
  id SERIAL PRIMARY KEY,
  withdrawal_id TEXT NOT NULL REFERENCES withdrawals(id),
  amount NUMERIC(18, 6) NOT NULL,
  tx_hash TEXT,
  status TEXT NOT NULL,  -- 'success', 'failed', 'pending'
  error_message TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### 2. åç«¯ API è®¾è®¡

#### 2.1 é…ç½®è‡ªåŠ¨æ”¾æ¬¾

```typescript
// POST /api/admin/system/auto-payout/configure
interface AutoPayoutConfigRequest {
  privateKey: string;        // ç§é’¥ï¼ˆå‰ç«¯åŠ å¯†åä¼ è¾“ï¼‰
  threshold: number;         // è‡ªåŠ¨æ”¾æ¬¾é˜ˆå€¼ï¼ˆUSDTï¼‰
  enabled: boolean;          // æ˜¯å¦å¯ç”¨
  minBalance?: number;       // æœ€å°ä½™é¢é˜ˆå€¼ï¼ˆUSDTï¼‰
  dailyLimit?: number;       // æ¯æ—¥è‡ªåŠ¨æ”¾æ¬¾æ€»é¢é™åˆ¶ï¼ˆUSDTï¼‰
}

// å“åº”
interface AutoPayoutConfigResponse {
  ok: boolean;
  walletAddress: string;     // é’±åŒ…åœ°å€ï¼ˆç”¨äºéªŒè¯ï¼‰
  threshold: number;
  enabled: boolean;
}
```

#### 2.2 è·å–è‡ªåŠ¨æ”¾æ¬¾é…ç½®

```typescript
// GET /api/admin/system/auto-payout/config
interface AutoPayoutConfigResponse {
  ok: boolean;
  walletAddress: string;
  threshold: number;
  enabled: boolean;
  minBalance: number;
  dailyLimit: number | null;
  currentBalance: string;     // å½“å‰é’±åŒ… USDT ä½™é¢
}
```

#### 2.3 è·å–è‡ªåŠ¨æ”¾æ¬¾æ—¥å¿—

```typescript
// GET /api/admin/system/auto-payout/logs?limit=50&offset=0
interface AutoPayoutLogsResponse {
  ok: boolean;
  items: Array<{
    id: number;
    withdrawalId: string;
    amount: number;
    txHash: string | null;
    status: 'success' | 'failed' | 'pending';
    errorMessage: string | null;
    createdAt: string;
  }>;
  total: number;
}
```

### 3. åç«¯æœåŠ¡å®ç°

#### 3.1 è‡ªåŠ¨æ”¾æ¬¾æœåŠ¡

```typescript
// src/services/autoPayout.ts
import { ethers } from 'ethers';
import { supabase } from '../infra/supabase.js';
import { config } from '../config.js';
import { completeWithdrawal } from './admin.js';

export class AutoPayoutService {
  private wallet: ethers.Wallet | null = null;
  private threshold: number = 10.0;
  private enabled: boolean = false;
  private minBalance: number = 100.0;
  private provider: ethers.providers.Provider;
  private usdtContract: ethers.Contract;

  constructor(provider: ethers.providers.Provider) {
    this.provider = provider;
    // åˆå§‹åŒ– USDT åˆçº¦
    this.usdtContract = new ethers.Contract(
      config.usdtContract,
      ERC20_ABI,
      provider
    );
  }

  // é…ç½®è‡ªåŠ¨æ”¾æ¬¾
  async configure(params: {
    privateKey: string;
    threshold: number;
    enabled: boolean;
    minBalance?: number;
    dailyLimit?: number;
  }): Promise<void> {
    // 1. éªŒè¯ç§é’¥
    const wallet = new ethers.Wallet(params.privateKey);
    const address = wallet.address;

    // 2. åŠ å¯†ç§é’¥ï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡å¯†é’¥ï¼‰
    const encryptedKey = this.encryptPrivateKey(params.privateKey);

    // 3. ä¿å­˜é…ç½®åˆ°æ•°æ®åº“
    await supabase.from('auto_payout_config').upsert({
      private_key_encrypted: encryptedKey,
      wallet_address: address.toLowerCase(),
      threshold_usdt: params.threshold,
      enabled: params.enabled,
      min_balance_usdt: params.minBalance || 100.0,
      daily_limit_usdt: params.dailyLimit || null,
      updated_at: new Date().toISOString(),
    });

    // 4. æ›´æ–°å†…å­˜çŠ¶æ€
    this.wallet = wallet.connect(this.provider);
    this.threshold = params.threshold;
    this.enabled = params.enabled;
    this.minBalance = params.minBalance || 100.0;
  }

  // å¤„ç†å¾…å®¡æ‰¹æç°
  async processPendingWithdrawals(): Promise<void> {
    if (!this.enabled || !this.wallet) {
      return;
    }

    try {
      // 1. æ£€æŸ¥é’±åŒ…ä½™é¢
      const balance = await this.getUsdtBalance();
      if (balance < this.minBalance) {
        console.warn(`[AutoPayout] é’±åŒ…ä½™é¢ä¸è¶³ï¼Œåœæ­¢è‡ªåŠ¨æ”¾æ¬¾ã€‚å½“å‰ä½™é¢: ${balance} USDTï¼Œæœ€å°ä½™é¢: ${this.minBalance} USDT`);
        return;
      }

      // 2. è·å–å¾…å®¡æ‰¹æç°ï¼ˆé‡‘é¢ < thresholdï¼‰
      const { data: withdrawals, error } = await supabase
        .from('withdrawals')
        .select('id, address, amount, status')
        .eq('status', 'Pending')
        .lt('amount', this.threshold)
        .order('created_at', { ascending: true })
        .limit(10);  // æ¯æ¬¡å¤„ç†æœ€å¤š 10 ç¬”

      if (error) {
        console.error('[AutoPayout] è·å–å¾…å®¡æ‰¹æç°å¤±è´¥:', error);
        return;
      }

      if (!withdrawals || withdrawals.length === 0) {
        return;  // æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æç°
      }

      // 3. å¤„ç†æ¯ç¬”æç°
      for (const withdrawal of withdrawals) {
        await this.processWithdrawal(withdrawal);
      }
    } catch (error: any) {
      console.error('[AutoPayout] å¤„ç†å¾…å®¡æ‰¹æç°å¤±è´¥:', error);
    }
  }

  // å¤„ç†å•ç¬”æç°
  private async processWithdrawal(withdrawal: any): Promise<void> {
    const withdrawalId = withdrawal.id;
    const userAddress = withdrawal.address;
    const amount = parseFloat(withdrawal.amount);

    try {
      // 1. æ£€æŸ¥ä½™é¢
      const balance = await this.getUsdtBalance();
      if (balance < amount) {
        await this.logFailure(withdrawalId, amount, 'ä½™é¢ä¸è¶³');
        return;
      }

      // 2. å‘é€ USDT è½¬è´¦äº¤æ˜“
      const tx = await this.sendUsdtTransfer(userAddress, amount);
      console.log(`[AutoPayout] äº¤æ˜“å·²å‘é€: ${tx.hash}`);

      // 3. è®°å½•æ—¥å¿—ï¼ˆpendingï¼‰
      await this.logPending(withdrawalId, amount, tx.hash);

      // 4. ç­‰å¾…äº¤æ˜“ç¡®è®¤
      const receipt = await tx.wait();
      console.log(`[AutoPayout] äº¤æ˜“å·²ç¡®è®¤: ${receipt.transactionHash}`);

      // 5. è°ƒç”¨ completeWithdrawal
      await completeWithdrawal(
        withdrawalId,
        receipt.transactionHash,
        this.provider
      );

      // 6. è®°å½•æˆåŠŸæ—¥å¿—
      await this.logSuccess(withdrawalId, amount, receipt.transactionHash);
    } catch (error: any) {
      console.error(`[AutoPayout] å¤„ç†æç°å¤±è´¥ (${withdrawalId}):`, error);
      await this.logFailure(withdrawalId, amount, error.message || 'æœªçŸ¥é”™è¯¯');
    }
  }

  // å‘é€ USDT è½¬è´¦
  private async sendUsdtTransfer(to: string, amount: number): Promise<ethers.ContractTransaction> {
    const decimals = await this.usdtContract.decimals();
    const amountWei = ethers.utils.parseUnits(amount.toString(), decimals);
    
    return await this.usdtContract.connect(this.wallet!).transfer(to, amountWei);
  }

  // è·å– USDT ä½™é¢
  private async getUsdtBalance(): Promise<number> {
    const balanceWei = await this.usdtContract.balanceOf(this.wallet!.address);
    const decimals = await this.usdtContract.decimals();
    return parseFloat(ethers.utils.formatUnits(balanceWei, decimals));
  }

  // æ—¥å¿—è®°å½•æ–¹æ³•
  private async logPending(withdrawalId: string, amount: number, txHash: string): Promise<void> {
    await supabase.from('auto_payout_logs').insert({
      withdrawal_id: withdrawalId,
      amount,
      tx_hash: txHash,
      status: 'pending',
    });
  }

  private async logSuccess(withdrawalId: string, amount: number, txHash: string): Promise<void> {
    await supabase.from('auto_payout_logs')
      .update({ status: 'success' })
      .eq('withdrawal_id', withdrawalId);
  }

  private async logFailure(withdrawalId: string, amount: number, errorMessage: string): Promise<void> {
    await supabase.from('auto_payout_logs').insert({
      withdrawal_id: withdrawalId,
      amount,
      status: 'failed',
      error_message: errorMessage,
    });
  }

  // ç§é’¥åŠ å¯†/è§£å¯†
  private encryptPrivateKey(privateKey: string): string {
    // ä½¿ç”¨ç¯å¢ƒå˜é‡å¯†é’¥åŠ å¯†
    const encryptionKey = process.env.AUTO_PAYOUT_ENCRYPTION_KEY || 'default-key-change-me';
    // å®ç°åŠ å¯†é€»è¾‘ï¼ˆå¯ä»¥ä½¿ç”¨ crypto åº“ï¼‰
    // ...
    return encryptedKey;
  }
}
```

#### 3.2 å®šæ—¶ä»»åŠ¡é›†æˆ

```typescript
// src/index.ts
import { AutoPayoutService } from './services/autoPayout.js';

// åˆå§‹åŒ–è‡ªåŠ¨æ”¾æ¬¾æœåŠ¡
const autoPayoutService = new AutoPayoutService(getProvider());

// åŠ è½½é…ç½®
async function loadAutoPayoutConfig() {
  const { data } = await supabase
    .from('auto_payout_config')
    .select('*')
    .limit(1)
    .maybeSingle();
  
  if (data && data.enabled) {
    // è§£å¯†ç§é’¥
    const privateKey = decryptPrivateKey(data.private_key_encrypted);
    await autoPayoutService.configure({
      privateKey,
      threshold: parseFloat(data.threshold_usdt),
      enabled: data.enabled,
      minBalance: parseFloat(data.min_balance_usdt),
      dailyLimit: data.daily_limit_usdt ? parseFloat(data.daily_limit_usdt) : undefined,
    });
  }
}

// å¯åŠ¨æ—¶åŠ è½½é…ç½®
await loadAutoPayoutConfig();

// å®šæ—¶ä»»åŠ¡ï¼šæ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡
setInterval(async () => {
  if (autoPayoutService.isEnabled()) {
    await autoPayoutService.processPendingWithdrawals();
  }
}, 30000);
```

### 4. å‰ç«¯å®ç°

#### 4.1 è‡ªåŠ¨æ”¾æ¬¾é…ç½®ç»„ä»¶

```typescript
// pages/AutoPayoutConfig.tsx
const AutoPayoutConfig: React.FC = () => {
  const [privateKey, setPrivateKey] = useState('');
  const [threshold, setThreshold] = useState(10);
  const [enabled, setEnabled] = useState(false);
  const [minBalance, setMinBalance] = useState(100);
  const [config, setConfig] = useState<AutoPayoutConfig | null>(null);

  const handleSave = async () => {
    // 1. éªŒè¯ç§é’¥æ ¼å¼
    if (!/^0x[a-fA-F0-9]{64}$/.test(privateKey)) {
      showNotification('error', 'ç§é’¥æ ¼å¼ä¸æ­£ç¡®');
      return;
    }

    // 2. åŠ å¯†ç§é’¥ï¼ˆå‰ç«¯åŠ å¯†åä¼ è¾“ï¼‰
    const encryptedKey = await encryptPrivateKey(privateKey);

    // 3. è°ƒç”¨ API
    await configureAutoPayout({
      privateKey: encryptedKey,
      threshold,
      enabled,
      minBalance,
    });
  };

  return (
    <div>
      <h2>è‡ªåŠ¨æ”¾æ¬¾é…ç½®</h2>
      {/* é…ç½®è¡¨å• */}
    </div>
  );
};
```

#### 4.2 æç°åˆ—è¡¨å¢å¼º

```typescript
// pages/FinanceOps.tsx
// åœ¨æç°å¡ç‰‡ä¸­æ˜¾ç¤ºè‡ªåŠ¨æ”¾æ¬¾æ ‡è®°
{withdrawal.amount < autoPayoutThreshold && (
  <div className="flex items-center gap-2 text-emerald-400 text-xs">
    <Zap size={12} />
    <span>å°†è‡ªåŠ¨æ”¾æ¬¾</span>
  </div>
)}
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | æ–¹æ¡ˆ 1: åç«¯è‡ªåŠ¨æ”¾æ¬¾ | æ–¹æ¡ˆ 2: å‰ç«¯è‡ªåŠ¨æ”¾æ¬¾ | æ–¹æ¡ˆ 3: æ··åˆæ–¹æ¡ˆ |
|------|---------------------|---------------------|-----------------|
| **å®‰å…¨æ€§** | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ |
| **å¯é æ€§** | â­â­â­â­â­ | â­â­ | â­â­â­â­â­ |
| **å®ç°å¤æ‚åº¦** | â­â­â­ | â­â­ | â­â­â­â­ |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­ | â­â­â­â­ | â­â­â­ |
| **æ¨èåº¦** | â­â­â­â­â­ | âŒ | â­â­â­â­ |

---

## ğŸ¯ æ¨èæ–¹æ¡ˆæ€»ç»“

**æ¨èæ–¹æ¡ˆ**: **æ–¹æ¡ˆ 1 - åç«¯è‡ªåŠ¨æ”¾æ¬¾**

**ç†ç”±**:
1. âœ… å®‰å…¨æ€§æœ€é«˜ï¼šç§é’¥å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼ŒåŠ å¯†ä¿æŠ¤
2. âœ… å¯é æ€§æœ€é«˜ï¼š24/7 è¿è¡Œï¼Œä¸ä¾èµ–å‰ç«¯
3. âœ… æ˜“äºç›‘æ§ï¼šå®Œæ•´çš„æ—¥å¿—å’ŒçŠ¶æ€ç›‘æ§
4. âœ… æ˜“äºæ‰©å±•ï¼šå¯ä»¥æ·»åŠ æ›´å¤šå®‰å…¨æªæ–½å’Œé™åˆ¶

**å®æ–½æ­¥éª¤**:
1. åˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆ`auto_payout_config`, `auto_payout_logs`ï¼‰
2. å®ç°åç«¯è‡ªåŠ¨æ”¾æ¬¾æœåŠ¡
3. æ·»åŠ åç«¯ APIï¼ˆé…ç½®ã€æŸ¥è¯¢ã€æ—¥å¿—ï¼‰
4. å®ç°å‰ç«¯é…ç½®ç•Œé¢
5. é›†æˆå®šæ—¶ä»»åŠ¡
6. æµ‹è¯•å’Œéƒ¨ç½²

---

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ç§é’¥å®‰å…¨**:
   - å¿…é¡»åŠ å¯†å­˜å‚¨
   - ä½¿ç”¨ç¯å¢ƒå˜é‡å¯†é’¥
   - å®šæœŸè½®æ¢å¯†é’¥

2. **ä½™é¢ä¿æŠ¤**:
   - è®¾ç½®æœ€å°ä½™é¢é˜ˆå€¼
   - ä½™é¢ä¸è¶³æ—¶è‡ªåŠ¨åœæ­¢
   - å‘é€å‘Šè­¦é€šçŸ¥

3. **äº¤æ˜“é™åˆ¶**:
   - å•æ¬¡é‡‘é¢é™åˆ¶
   - æ¯æ—¥æ€»é¢é™åˆ¶
   - å•ç”¨æˆ·é¢‘ç‡é™åˆ¶

4. **ç›‘æ§å‘Šè­¦**:
   - è‡ªåŠ¨æ”¾æ¬¾æˆåŠŸ/å¤±è´¥é€šçŸ¥
   - ä½™é¢ä¸è¶³å‘Šè­¦
   - å¼‚å¸¸äº¤æ˜“å‘Šè­¦

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-09  
**çŠ¶æ€**: ğŸ“‹ å¾…é€‰æ‹©æ–¹æ¡ˆå¹¶å®æ–½

