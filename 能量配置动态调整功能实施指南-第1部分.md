# âš¡ èƒ½é‡é…ç½®åŠ¨æ€è°ƒæ•´åŠŸèƒ½å®æ–½æŒ‡å— - ç¬¬1éƒ¨åˆ†ï¼ˆåç«¯ï¼‰

**åˆ›å»ºæ—¥æœŸ**: 2026-01-06  
**åŠŸèƒ½æ¨¡å—**: èƒ½é‡å€¼è§„åˆ™åŠ¨æ€é…ç½®  
**éš¾åº¦ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰  
**é¢„è®¡è€—æ—¶**: 2-3 å°æ—¶

---

## ğŸ“Š åŠŸèƒ½æ¦‚è¿°

### éœ€æ±‚èƒŒæ™¯

æ ¹æ®ã€Šèƒ½é‡å€¼æ¶ˆè€—é€»è¾‘å®¡æŸ¥æŠ¥å‘Š-2026-01-06.mdã€‹ï¼Œå½“å‰ç³»ç»Ÿçš„èƒ½é‡å€¼å‚æ•°å…¨éƒ¨ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼š

```typescript
// âŒ å½“å‰ç¡¬ç¼–ç æ–¹å¼
const withdrawEnergyRatio = 10;  // 1 USDT = 10 Energy
const claimSelfReward = 1;       // ç”¨æˆ·é¢†å–ç©ºæŠ•å¥–åŠ±
const claimReferrerFirst = 3;    // é¦–æ¬¡é‚€è¯·é¢å¤–å¥–åŠ±
const claimReferrerRepeat = 1;   // éé¦–æ¬¡ç®¡é“æ”¶ç›Š
```

**é—®é¢˜**:
- âŒ ä¿®æ”¹å‚æ•°éœ€è¦æ”¹ä»£ç ã€é‡æ–°éƒ¨ç½²
- âŒ æ— æ³•å¿«é€Ÿå“åº”å¸‚åœºå˜åŒ–
- âŒ è¿è¥äººå‘˜æ— æ³•è‡ªä¸»è°ƒæ•´

**ç›®æ ‡**:
- âœ… åå°ç®¡ç†å‘˜å¯ä»¥åŠ¨æ€è°ƒæ•´æ‰€æœ‰èƒ½é‡å€¼å‚æ•°
- âœ… ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡æ–°éƒ¨ç½²
- âœ… å¸¦ç¼“å­˜æœºåˆ¶ï¼Œä¸å½±å“æ€§èƒ½

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®¡ç†å‘˜ä¿®æ”¹é…ç½®   â”‚
â”‚  (å‰ç«¯é¡µé¢)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ PUT /api/admin/energy/config
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  energyConfig   â”‚
â”‚   Fastifyè·¯ç”±   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ energyConfig.ts â”‚ â—„â”€â”€â”€â”€ 5åˆ†é’Ÿç¼“å­˜
â”‚   Serviceå±‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  energy_config  â”‚
â”‚   æ•°æ®åº“è¡¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ è¯»å–é…ç½®
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  withdraw.ts    â”‚
â”‚ process_claim   â”‚ â—„â”€â”€â”€â”€ å®é™…ä¸šåŠ¡é€»è¾‘
â”‚   æç°/é¢†å–      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤æ¸…å•

### âœ… é˜¶æ®µ 1: æ•°æ®åº“å±‚ï¼ˆå·²å®Œæˆï¼‰

- [x] åˆ›å»º `energy_config` è¡¨
- [x] æ’å…¥é»˜è®¤é…ç½®æ•°æ®
- [x] è®¾ç½®å­—æ®µçº¦æŸå’Œé»˜è®¤å€¼

**æ–‡ä»¶**: `rabbit-ai-backend/db/create_energy_config.sql`

---

### âœ… é˜¶æ®µ 2: åç«¯æœåŠ¡å±‚ï¼ˆå·²å®Œæˆï¼‰

- [x] åˆ›å»º `energyConfig.ts` æœåŠ¡æ–‡ä»¶
- [x] å®ç° `getEnergyConfig()` è·å–é…ç½®
- [x] å®ç° `updateEnergyConfig()` æ›´æ–°é…ç½®
- [x] æ·»åŠ  5 åˆ†é’Ÿç¼“å­˜æœºåˆ¶

**æ–‡ä»¶**: `rabbit-ai-backend/src/services/energyConfig.ts`

---

### âœ… é˜¶æ®µ 3: API è·¯ç”±å±‚ï¼ˆå·²å®Œæˆï¼‰

- [x] åˆ›å»º `energyConfigRoutes.ts` è·¯ç”±æ–‡ä»¶
- [x] å®ç° GET `/api/admin/energy/config` æ¥å£
- [x] å®ç° PUT `/api/admin/energy/config` æ¥å£
- [x] æ·»åŠ ç®¡ç†å‘˜æƒé™æ ¡éªŒ

**æ–‡ä»¶**: `rabbit-ai-backend/src/api/energyConfigRoutes.ts`

---

### ğŸ”„ é˜¶æ®µ 4: é›†æˆåˆ°ä¸šåŠ¡é€»è¾‘ï¼ˆæœ¬éƒ¨åˆ†é‡ç‚¹ï¼‰

#### 4.1 ä¿®æ”¹ `withdraw.ts` - æç°èƒ½é‡æ‰£é™¤

**æ–‡ä»¶**: `rabbit-ai-backend/src/services/withdraw.ts`

**å½“å‰é€»è¾‘**:
```typescript
// âŒ ç¡¬ç¼–ç æ¯”ä¾‹
const energyNeeded = Math.floor(amount * 10); // 1 USDT = 10 Energy
```

**ä¿®æ”¹ä¸ºåŠ¨æ€åŠ è½½**:
```typescript
import { getEnergyConfig } from './energyConfig.js';

export async function requestWithdraw(
  address: string,
  amount: number,
  provider: ethers.providers.Provider
) {
  // ğŸŸ¢ åŠ¨æ€è·å–é…ç½®
  const energyConfig = await getEnergyConfig();
  const energyNeeded = Math.floor(amount * energyConfig.withdraw_energy_ratio);
  
  console.log(`[Withdraw] ğŸ”‹ æç° ${amount} USDT éœ€è¦ ${energyNeeded} Energy (æ¯”ä¾‹: ${energyConfig.withdraw_energy_ratio})`);
  
  // ... ç°æœ‰é€»è¾‘ç»§ç»­
  const { data: user, error: userErr } = await supabase
    .from('users')
    .select('energy_value')
    .eq('wallet_address', address.toLowerCase())
    .single();
  
  if (userErr || !user) {
    throw new ApiError('USER_NOT_FOUND', 'User not found', 404);
  }
  
  // æ£€æŸ¥èƒ½é‡å€¼æ˜¯å¦è¶³å¤Ÿ
  if (user.energy_value < energyNeeded) {
    throw new ApiError(
      'INSUFFICIENT_ENERGY',
      `Insufficient energy. Required: ${energyNeeded}, Available: ${user.energy_value}`,
      400
    );
  }
  
  // æ‰£é™¤èƒ½é‡å€¼å¹¶åˆ›å»ºæç°è®°å½•ï¼ˆç°æœ‰é€»è¾‘ä¿æŒä¸å˜ï¼‰
  // ...
}
```

**ä¿®æ”¹ä½ç½®**: æ‰¾åˆ° `requestWithdraw` å‡½æ•°ä¸­è®¡ç®— `energyNeeded` çš„åœ°æ–¹ã€‚

---

#### 4.2 ä¿®æ”¹ `process_claim_energy` æ•°æ®åº“å‡½æ•°

**æ–‡ä»¶**: `rabbit-ai-backend/db/functions/process_claim_energy.sql`

**å½“å‰é€»è¾‘**:
```sql
-- âŒ ç¡¬ç¼–ç å¥–åŠ±
DECLARE
  v_self_energy INTEGER := 1;      -- ç”¨æˆ·è‡ªå·±å¥–åŠ±
  v_referrer_first INTEGER := 3;   -- é¦–æ¬¡é‚€è¯·å¥–åŠ±
  v_referrer_repeat INTEGER := 1;  -- éé¦–æ¬¡å¥–åŠ±
```

**ä¿®æ”¹ç­–ç•¥**: ç”±äº PostgreSQL å‡½æ•°å†…éƒ¨æ— æ³•ç›´æ¥è°ƒç”¨ Node.js æœåŠ¡ï¼Œæˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆ A: é€šè¿‡å‚æ•°ä¼ é€’ï¼ˆæ¨èï¼‰**

1. ä¿®æ”¹å‡½æ•°ç­¾åï¼Œæ¥æ”¶é…ç½®å‚æ•°ï¼š
```sql
CREATE OR REPLACE FUNCTION process_claim_energy(
  p_claimer_address TEXT,
  p_referrer_address TEXT DEFAULT NULL,
  -- ğŸŸ¢ æ–°å¢é…ç½®å‚æ•°
  p_self_reward INTEGER DEFAULT 1,
  p_referrer_first INTEGER DEFAULT 3,
  p_referrer_repeat INTEGER DEFAULT 1
) RETURNS JSONB AS $$
DECLARE
  v_self_energy INTEGER := p_self_reward;
  v_referrer_first INTEGER := p_referrer_first;
  v_referrer_repeat INTEGER := p_referrer_repeat;
  -- ... å…¶ä»–å˜é‡
BEGIN
  -- å‡½æ•°é€»è¾‘ä¿æŒä¸å˜ï¼Œä½¿ç”¨å‚æ•°ä¼ å…¥çš„å€¼
  -- ...
END;
$$ LANGUAGE plpgsql;
```

2. ä¿®æ”¹åç«¯è°ƒç”¨ä»£ç  `src/services/airdrop.ts`:
```typescript
import { getEnergyConfig } from './energyConfig.js';

export async function claimAirdrop(
  address: string,
  referrer: string | null,
  provider: ethers.providers.Provider
) {
  // ğŸŸ¢ åŠ¨æ€è·å–é…ç½®
  const energyConfig = await getEnergyConfig();
  
  console.log(`[Claim] âš¡ ä½¿ç”¨åŠ¨æ€èƒ½é‡é…ç½®:`, energyConfig);
  
  // è°ƒç”¨æ•°æ®åº“å‡½æ•°æ—¶ä¼ å…¥é…ç½®å‚æ•°
  const { data, error } = await supabase.rpc('process_claim_energy', {
    p_claimer_address: address.toLowerCase(),
    p_referrer_address: referrer ? referrer.toLowerCase() : null,
    p_self_reward: energyConfig.claim_self_reward,
    p_referrer_first: energyConfig.claim_referrer_first,
    p_referrer_repeat: energyConfig.claim_referrer_repeat,
  });
  
  if (error) throw error;
  return data;
}
```

**æ–¹æ¡ˆ B: ä»æ•°æ®åº“è¡¨è¯»å–ï¼ˆå¤‡é€‰ï¼‰**

å¦‚æœå‡½æ•°å†…éƒ¨å¿…é¡»è¯»å–é…ç½®ï¼Œå¯ä»¥åœ¨å‡½æ•°å†…éƒ¨æŸ¥è¯¢ `energy_config` è¡¨ï¼š
```sql
CREATE OR REPLACE FUNCTION process_claim_energy(
  p_claimer_address TEXT,
  p_referrer_address TEXT DEFAULT NULL
) RETURNS JSONB AS $$
DECLARE
  v_self_energy INTEGER;
  v_referrer_first INTEGER;
  v_referrer_repeat INTEGER;
BEGIN
  -- ğŸŸ¢ ä»è¡¨ä¸­è¯»å–é…ç½®
  SELECT 
    (value)::INTEGER INTO v_self_energy 
  FROM energy_config 
  WHERE key = 'claim_self_reward';
  
  SELECT 
    (value)::INTEGER INTO v_referrer_first 
  FROM energy_config 
  WHERE key = 'claim_referrer_first';
  
  SELECT 
    (value)::INTEGER INTO v_referrer_repeat 
  FROM energy_config 
  WHERE key = 'claim_referrer_repeat';
  
  -- è®¾ç½®é»˜è®¤å€¼ï¼ˆé˜²æ­¢è¡¨ä¸­æ²¡æœ‰æ•°æ®ï¼‰
  v_self_energy := COALESCE(v_self_energy, 1);
  v_referrer_first := COALESCE(v_referrer_first, 3);
  v_referrer_repeat := COALESCE(v_referrer_repeat, 1);
  
  -- åç»­é€»è¾‘ä¿æŒä¸å˜
  -- ...
END;
$$ LANGUAGE plpgsql;
```

**æ¨èä½¿ç”¨æ–¹æ¡ˆ A**ï¼Œå› ä¸ºï¼š
- âœ… æ›´çµæ´»ï¼Œå¯ä»¥åˆ©ç”¨ Node.js å±‚çš„ç¼“å­˜
- âœ… ä¸å¢åŠ æ•°æ®åº“æŸ¥è¯¢è´Ÿæ‹…
- âœ… ä»£ç æ›´æ¸…æ™°

---

#### 4.3 æ³¨å†Œè·¯ç”±åˆ° Fastify

**æ–‡ä»¶**: `rabbit-ai-backend/src/server.ts`

æ‰¾åˆ°è·¯ç”±æ³¨å†Œéƒ¨åˆ†ï¼Œæ·»åŠ èƒ½é‡é…ç½®è·¯ç”±ï¼š

```typescript
// ç°æœ‰å¯¼å…¥
import { registerAdminRoutes } from './api/adminRoutes.js';
import { registerAirdropRoutes } from './api/airdropRoutes.js';
// ... å…¶ä»–è·¯ç”±

// ğŸŸ¢ æ–°å¢å¯¼å…¥
import { registerEnergyConfigRoutes } from './api/energyConfigRoutes.js';

// åœ¨ app.register() éƒ¨åˆ†æ·»åŠ 
await app.register(async (app) => {
  // ç°æœ‰è·¯ç”±
  registerAdminRoutes(app);
  registerAirdropRoutes(app);
  // ... å…¶ä»–è·¯ç”±
  
  // ğŸŸ¢ æ³¨å†Œèƒ½é‡é…ç½®è·¯ç”±
  registerEnergyConfigRoutes(app);
  
  console.log('[Server] âœ… æ‰€æœ‰è·¯ç”±å·²æ³¨å†Œ');
});
```

---

## ğŸ”§ ä»£ç ä¿®æ”¹å®æ“æŒ‡å—

### æ­¥éª¤ 1: æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
cd rabbit-ai-backend
```

**é€‰é¡¹ A: ä½¿ç”¨ Supabase CLI**
```bash
# å¦‚æœå·²å®‰è£… Supabase CLI
supabase migration new create_energy_config
# å°† db/create_energy_config.sql å†…å®¹å¤åˆ¶åˆ°ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶
supabase db push
```

**é€‰é¡¹ B: æ‰‹åŠ¨æ‰§è¡Œ SQL**
```bash
# ç™»å½• Supabase Dashboard
# æ‰“å¼€ SQL Editor
# å¤åˆ¶ db/create_energy_config.sql å…¨éƒ¨å†…å®¹
# ç‚¹å‡» Run æ‰§è¡Œ
```

**éªŒè¯**:
```sql
-- æŸ¥çœ‹è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT * FROM energy_config;

-- åº”è¯¥è¿”å› 4 è¡Œæ•°æ®ï¼š
-- withdraw_energy_ratio | 10
-- claim_self_reward     | 1
-- claim_referrer_first  | 3
-- claim_referrer_repeat | 1
```

---

### æ­¥éª¤ 2: æ·»åŠ åç«¯æœåŠ¡å’Œè·¯ç”±

**2.1 åˆ›å»º `energyConfig.ts`**
```bash
# æ–‡ä»¶å·²åˆ›å»ºåœ¨ src/services/energyConfig.ts
# æ— éœ€é¢å¤–æ“ä½œï¼Œå†…å®¹å·²åŒ…å«ç¼“å­˜æœºåˆ¶
```

**2.2 åˆ›å»º `energyConfigRoutes.ts`**
```bash
# æ–‡ä»¶å·²åˆ›å»ºåœ¨ src/api/energyConfigRoutes.ts
# åŒ…å« GET å’Œ PUT ä¸¤ä¸ªæ¥å£
```

**2.3 æ³¨å†Œè·¯ç”±**

ä¿®æ”¹ `src/server.ts`ï¼Œåœ¨è·¯ç”±æ³¨å†Œéƒ¨åˆ†æ·»åŠ ï¼š
```typescript
import { registerEnergyConfigRoutes } from './api/energyConfigRoutes.js';

// åœ¨ app.register() ä¸­æ·»åŠ 
registerEnergyConfigRoutes(app);
```

---

### æ­¥éª¤ 3: ä¿®æ”¹æç°é€»è¾‘

**æ–‡ä»¶**: `src/services/withdraw.ts`

æ‰¾åˆ° `requestWithdraw` å‡½æ•°ï¼ˆå¤§çº¦åœ¨ç¬¬ 20-60 è¡Œï¼‰ï¼Œå®šä½åˆ°è¿™æ®µä»£ç ï¼š
```typescript
// åŸä»£ç ï¼ˆå¤§çº¦ç¬¬ 35 è¡Œï¼‰
const energyNeeded = Math.floor(amount * 10);
```

**ä¿®æ”¹ä¸º**:
```typescript
// ğŸŸ¢ ç¬¬ 1 æ­¥ï¼šåœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
import { getEnergyConfig } from './energyConfig.js';

// ğŸŸ¢ ç¬¬ 2 æ­¥ï¼šåœ¨ requestWithdraw å‡½æ•°å†…ä¿®æ”¹
export async function requestWithdraw(
  address: string,
  amount: number,
  provider: ethers.providers.Provider
) {
  // è·å–åŠ¨æ€é…ç½®
  const energyConfig = await getEnergyConfig();
  const energyNeeded = Math.floor(amount * energyConfig.withdraw_energy_ratio);
  
  console.log(`[Withdraw] ğŸ”‹ æç° ${amount} USDT éœ€è¦ ${energyNeeded} Energy (æ¯”ä¾‹: ${energyConfig.withdraw_energy_ratio})`);
  
  // ... åç»­é€»è¾‘ä¿æŒä¸å˜
}
```

---

### æ­¥éª¤ 4: ä¿®æ”¹é¢†å–ç©ºæŠ•é€»è¾‘

**æ–‡ä»¶**: `src/services/airdrop.ts`

æ‰¾åˆ° `claimAirdrop` å‡½æ•°ï¼Œå®šä½åˆ°è°ƒç”¨ `process_claim_energy` çš„åœ°æ–¹ï¼š

```typescript
// ğŸŸ¢ ç¬¬ 1 æ­¥ï¼šåœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
import { getEnergyConfig } from './energyConfig.js';

// ğŸŸ¢ ç¬¬ 2 æ­¥ï¼šä¿®æ”¹ claimAirdrop å‡½æ•°
export async function claimAirdrop(
  address: string,
  referrer: string | null,
  provider: ethers.providers.Provider
) {
  // è·å–åŠ¨æ€é…ç½®
  const energyConfig = await getEnergyConfig();
  
  console.log(`[Claim] âš¡ ä½¿ç”¨åŠ¨æ€èƒ½é‡é…ç½®:`, energyConfig);
  
  // è°ƒç”¨æ•°æ®åº“å‡½æ•°æ—¶ä¼ å…¥é…ç½®
  const { data, error } = await supabase.rpc('process_claim_energy', {
    p_claimer_address: address.toLowerCase(),
    p_referrer_address: referrer ? referrer.toLowerCase() : null,
    p_self_reward: energyConfig.claim_self_reward,
    p_referrer_first: energyConfig.claim_referrer_first,
    p_referrer_repeat: energyConfig.claim_referrer_repeat,
  });
  
  if (error) {
    console.error('[Claim] âŒ è°ƒç”¨æ•°æ®åº“å‡½æ•°å¤±è´¥:', error);
    throw error;
  }
  
  console.log(`[Claim] âœ… èƒ½é‡å€¼å·²å‘æ”¾:`, data);
  return data;
}
```

---

### æ­¥éª¤ 5: ä¿®æ”¹æ•°æ®åº“å‡½æ•°ï¼ˆæ¨èæ–¹æ¡ˆ Aï¼‰

**æ–‡ä»¶**: `db/functions/process_claim_energy.sql`

**ä¿®æ”¹å‡½æ•°ç­¾å**:
```sql
CREATE OR REPLACE FUNCTION process_claim_energy(
  p_claimer_address TEXT,
  p_referrer_address TEXT DEFAULT NULL,
  -- ğŸŸ¢ æ–°å¢å‚æ•°
  p_self_reward INTEGER DEFAULT 1,
  p_referrer_first INTEGER DEFAULT 3,
  p_referrer_repeat INTEGER DEFAULT 1
) RETURNS JSONB AS $$
DECLARE
  v_claimer_energy INTEGER := 0;
  v_referrer_energy INTEGER := 0;
  v_claimer_before INTEGER := 0;
  v_claimer_after INTEGER := 0;
  v_referrer_before INTEGER := 0;
  v_referrer_after INTEGER := 0;
  v_is_first_claim BOOLEAN := FALSE;
  
  -- ğŸŸ¢ ä½¿ç”¨å‚æ•°å€¼
  v_self_energy INTEGER := p_self_reward;
  v_referrer_first INTEGER := p_referrer_first;
  v_referrer_repeat INTEGER := p_referrer_repeat;
BEGIN
  -- åç»­é€»è¾‘å®Œå…¨ä¸å˜ï¼Œä½¿ç”¨ä¸Šé¢çš„å˜é‡
  -- ...
  
  -- åŸæœ‰çš„èƒ½é‡è®¡ç®—é€»è¾‘
  v_claimer_energy := v_self_energy; -- ç”¨æˆ·å¥–åŠ±
  
  IF p_referrer_address IS NOT NULL THEN
    SELECT is_first_claim INTO v_is_first_claim 
    FROM users 
    WHERE wallet_address = p_claimer_address;
    
    IF v_is_first_claim THEN
      v_referrer_energy := v_referrer_first; -- é¦–æ¬¡å¥–åŠ±
    ELSE
      v_referrer_energy := v_referrer_repeat; -- ç®¡é“æ”¶ç›Š
    END IF;
  END IF;
  
  -- ... åç»­æ›´æ–°é€»è¾‘ä¸å˜
END;
$$ LANGUAGE plpgsql;
```

**æ‰§è¡Œæ›´æ–°**:
```bash
# åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œä¸Šè¿° SQL
# æˆ–è€…åˆ›å»ºè¿ç§»æ–‡ä»¶
```

---

## ğŸ§ª åç«¯æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1: éªŒè¯æ•°æ®åº“è¡¨

```bash
# åœ¨ Supabase SQL Editor æ‰§è¡Œ
SELECT * FROM energy_config ORDER BY key;
```

**é¢„æœŸç»“æœ**:
```
key                     | value | description                          | updated_at
------------------------|-------|--------------------------------------|-------------------------
claim_referrer_first    | 3     | æ¨èäººé¦–æ¬¡é‚€è¯·è·å¾—çš„èƒ½é‡ (é¢å¤–å¥–åŠ±)    | 2026-01-06 ...
claim_referrer_repeat   | 1     | æ¨èäººéé¦–æ¬¡é‚€è¯·è·å¾—çš„èƒ½é‡ (ç®¡é“æ”¶ç›Š)  | 2026-01-06 ...
claim_self_reward       | 1     | ç”¨æˆ·è‡ªå·±é¢†å–ç©ºæŠ•è·å¾—çš„èƒ½é‡             | 2026-01-06 ...
withdraw_energy_ratio   | 10    | æç°èƒ½é‡æ¶ˆè€—æ¯”ä¾‹ (1 USDT = X Energy)  | 2026-01-06 ...
```

---

### æµ‹è¯• 2: æµ‹è¯• API æ¥å£

**2.1 è·å–é…ç½®**
```bash
curl -X GET http://localhost:3000/api/admin/energy/config \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

**é¢„æœŸå“åº”**:
```json
{
  "ok": true,
  "config": {
    "withdraw_energy_ratio": 10,
    "claim_self_reward": 1,
    "claim_referrer_first": 3,
    "claim_referrer_repeat": 1
  }
}
```

**2.2 æ›´æ–°é…ç½®**
```bash
curl -X PUT http://localhost:3000/api/admin/energy/config \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "key": "withdraw_energy_ratio",
    "value": 15,
    "description": "æç°èƒ½é‡æ¶ˆè€—æ¯”ä¾‹ (1 USDT = 15 Energy)"
  }'
```

**é¢„æœŸå“åº”**:
```json
{
  "ok": true,
  "message": "Energy config withdraw_energy_ratio updated successfully"
}
```

**2.3 éªŒè¯ç¼“å­˜å¤±æ•ˆ**
```bash
# å†æ¬¡è·å–é…ç½®ï¼Œåº”è¯¥çœ‹åˆ°æ–°å€¼
curl -X GET http://localhost:3000/api/admin/energy/config \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

**é¢„æœŸå“åº”**:
```json
{
  "ok": true,
  "config": {
    "withdraw_energy_ratio": 15,  // ğŸŸ¢ å·²æ›´æ–°
    "claim_self_reward": 1,
    "claim_referrer_first": 3,
    "claim_referrer_repeat": 1
  }
}
```

---

### æµ‹è¯• 3: éªŒè¯ä¸šåŠ¡é€»è¾‘åº”ç”¨

**3.1 æµ‹è¯•æç°èƒ½é‡æ‰£é™¤**

1. ä¿®æ”¹é…ç½®ï¼šå°† `withdraw_energy_ratio` æ”¹ä¸º `15`
2. æ¨¡æ‹Ÿæç° `1 USDT`
3. æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
```
[Withdraw] ğŸ”‹ æç° 1 USDT éœ€è¦ 15 Energy (æ¯”ä¾‹: 15)
```
4. æŸ¥çœ‹æ•°æ®åº“ï¼Œç”¨æˆ·èƒ½é‡å€¼åº”è¯¥æ‰£é™¤ `15`

**3.2 æµ‹è¯•é¢†å–ç©ºæŠ•èƒ½é‡å¥–åŠ±**

1. ä¿®æ”¹é…ç½®ï¼š
   - `claim_self_reward` æ”¹ä¸º `2`
   - `claim_referrer_first` æ”¹ä¸º `5`
2. æ¨¡æ‹Ÿæ–°ç”¨æˆ·é¢†å–ç©ºæŠ•ï¼ˆæœ‰æ¨èäººï¼‰
3. æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
```
[Claim] âš¡ ä½¿ç”¨åŠ¨æ€èƒ½é‡é…ç½®: {
  claim_self_reward: 2,
  claim_referrer_first: 5,
  ...
}
```
4. æŸ¥çœ‹æ•°æ®åº“ï¼š
   - ç”¨æˆ·èƒ½é‡å€¼å¢åŠ  `2`
   - æ¨èäººèƒ½é‡å€¼å¢åŠ  `5`ï¼ˆé¦–æ¬¡ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç¼“å­˜æœºåˆ¶
- âœ… é…ç½®ç¼“å­˜ 5 åˆ†é’Ÿ
- âš ï¸ ä¿®æ”¹é…ç½®åæœ€å¤š 5 åˆ†é’Ÿç”Ÿæ•ˆ
- ğŸ’¡ å¦‚éœ€ç«‹å³ç”Ÿæ•ˆï¼Œé‡å¯åç«¯æœåŠ¡

### 2. é»˜è®¤å€¼ä¿æŠ¤
- âœ… æ‰€æœ‰é…ç½®éƒ½æœ‰é»˜è®¤å€¼
- âœ… å³ä½¿æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œä¹Ÿä¼šä½¿ç”¨é»˜è®¤å€¼
- âœ… ä¸ä¼šå½±å“ä¸šåŠ¡è¿ç»­æ€§

### 3. æƒé™æ§åˆ¶
- âœ… æ‰€æœ‰é…ç½®æ¥å£éƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
- âš ï¸ ç¡®ä¿ `assertAdmin()` æ­£ç¡®éªŒè¯ JWT Token

### 4. æ•°æ®éªŒè¯
- âœ… æ‰€æœ‰é…ç½®å€¼å¿…é¡» â‰¥ 0
- âœ… ä½¿ç”¨ Zod schema éªŒè¯
- âš ï¸ ä¸æ¥å—è´Ÿæ•°æˆ–éæ•°å­—

---

## ğŸ“Š è¿›åº¦æ€»ç»“

### âœ… å·²å®Œæˆ
- [x] æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡
- [x] åç«¯æœåŠ¡å±‚ï¼ˆå¸¦ç¼“å­˜ï¼‰
- [x] API è·¯ç”±å±‚ï¼ˆå¸¦æƒé™æ ¡éªŒï¼‰
- [x] ä¸šåŠ¡é€»è¾‘é›†æˆæ–¹æ¡ˆ

### ğŸ”„ å¾…å®Œæˆï¼ˆç¬¬2éƒ¨åˆ†ï¼‰
- [ ] å‰ç«¯ API è°ƒç”¨å°è£…
- [ ] å‰ç«¯ç®¡ç†é¡µé¢é›†æˆ
- [ ] å®Œæ•´æµ‹è¯•æµç¨‹
- [ ] éƒ¨ç½²å’Œä¸Šçº¿æŒ‡å—

---

**ä¸‹ä¸€æ­¥**: ç»§ç»­ç¼–å†™ã€Šèƒ½é‡é…ç½®åŠ¨æ€è°ƒæ•´åŠŸèƒ½å®æ–½æŒ‡å—-ç¬¬2éƒ¨åˆ†ã€‹ï¼ŒåŒ…å«å‰ç«¯é›†æˆã€æµ‹è¯•å’Œéƒ¨ç½²ã€‚

**é¢„è®¡å®Œæˆæ—¶é—´**: ç¬¬1éƒ¨åˆ†å®Œæˆå 30 åˆ†é’Ÿ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-06  
**ä½œè€…**: Cursor AI Assistant  
**çŠ¶æ€**: âœ… ç¬¬1éƒ¨åˆ†å®Œæˆ

