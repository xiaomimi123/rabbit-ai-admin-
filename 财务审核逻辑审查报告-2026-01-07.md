# è´¢åŠ¡å®¡æ ¸é€»è¾‘å®¡æŸ¥æŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2026-01-07  
**å®¡æŸ¥èŒƒå›´**: åå°ç®¡ç†é¡µé¢ - è´¢åŠ¡å®¡æ ¸åŠŸèƒ½  
**å®¡æŸ¥ç›®æ ‡**: åˆ†æè´¢åŠ¡å®¡æ ¸åŠŸèƒ½çš„æ•°æ®æ˜¾ç¤ºã€éªŒè¯é€»è¾‘å’Œå®‰å…¨æ€§

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

è´¢åŠ¡å®¡æ ¸åŠŸèƒ½æ˜¯ç®¡ç†å‘˜å¤„ç†ç”¨æˆ·æç°ç”³è¯·çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæ”¯æŒä¸¤ç§å‘æ”¾æ¨¡å¼ï¼š
1. **MetaMask è‡ªåŠ¨å‘æ”¾æ¨¡å¼**: è¿æ¥é’±åŒ…åï¼Œé€šè¿‡ MetaMask ç›´æ¥è½¬è´¦å¹¶è‡ªåŠ¨éªŒè¯
2. **æ‰‹åŠ¨è¾“å…¥äº¤æ˜“å“ˆå¸Œæ¨¡å¼**: ç®¡ç†å‘˜åœ¨é“¾ä¸Šå®Œæˆè½¬è´¦åï¼Œæ‰‹åŠ¨è¾“å…¥äº¤æ˜“å“ˆå¸Œè¿›è¡ŒéªŒè¯

### æ ¸å¿ƒç‰¹ç‚¹

- âœ… **åŒé‡éªŒè¯æœºåˆ¶**: å‰ç«¯ä½™é¢æ£€æŸ¥ + åç«¯é“¾ä¸ŠéªŒè¯
- âœ… **é’±åŒ…åœ°å€åŒ¹é…**: éªŒè¯è¿æ¥çš„é’±åŒ…åœ°å€æ˜¯å¦ä¸é…ç½®çš„ç®¡ç†å‘˜é’±åŒ…ä¸€è‡´
- âœ… **é˜²é‡æ”¾æ”»å‡»**: é˜²æ­¢åŒä¸€äº¤æ˜“å“ˆå¸Œè¢«é‡å¤ä½¿ç”¨
- âœ… **é“¾ä¸Šäº¤æ˜“éªŒè¯**: éªŒè¯äº¤æ˜“æ¥æ”¶æ–¹ã€é‡‘é¢æ˜¯å¦åŒ¹é…
- âœ… **ç§»åŠ¨ç«¯æ”¯æŒ**: æ”¯æŒç§»åŠ¨ç«¯ MetaMask è¿æ¥å’Œæ“ä½œ

---

## ğŸ” å‰ç«¯æ˜¾ç¤ºå­—æ®µåˆ†æ

### 1. æç°ç”³è¯·åˆ—è¡¨æ˜¾ç¤º

**ä½ç½®**: `rabbit-ai-admin/pages/FinanceOps.tsx` (ç¬¬ 478-531 è¡Œ)

**æ˜¾ç¤ºçš„å­—æ®µ**:

| å­—æ®µ | æ•°æ®æ¥æº | æ˜¾ç¤ºæ ¼å¼ | è¯´æ˜ |
|------|---------|---------|------|
| **ç”¨æˆ·åœ°å€** | `w.address` | `text-sm font-mono text-zinc-300 break-all` | å®Œæ•´é’±åŒ…åœ°å€ï¼Œæ”¯æŒæ¢è¡Œ |
| **æç°é‡‘é¢** | `w.amount` | `$X.XX USDT` | æ ¼å¼åŒ–æ˜¾ç¤ºï¼Œä¿ç•™2ä½å°æ•° |
| **æç°ç¼–å·** | `w.id` | `ç¼–å·: {id}` | æç°è®°å½•çš„å”¯ä¸€æ ‡è¯† |
| **ç”³è¯·æ—¶é—´** | `w.createdAt` | `ç”³è¯·äº {æ—¶é—´}` | ä½¿ç”¨ `toLocaleString()` æ ¼å¼åŒ– |

**ä»£ç ç¤ºä¾‹**:
```typescript
<div className="flex items-center gap-2">
  <span className="text-sm font-mono text-zinc-300 break-all">{w.address}</span>
</div>
<div className="flex items-center gap-3 mt-1">
  <p className="text-2xl font-black text-white tracking-tighter">${w.amount.toFixed(2)} USDT</p>
  <span className="text-[10px] bg-zinc-800 px-2 py-0.5 rounded uppercase font-bold text-zinc-500 tracking-wider">ç¼–å·: {w.id}</span>
</div>
<p className="text-[11px] text-zinc-500 mt-1">ç”³è¯·äº {w.createdAt}</p>
```

### 2. åç«¯è¿”å›çš„æ•°æ®ç»“æ„

**API**: `GET /api/admin/withdrawals/pending`

**è¿”å›æ•°æ®ç»“æ„**:
```typescript
{
  ok: boolean;
  items: Array<{
    id: string;                    // æç°è®°å½•ID
    address: string;                // ç”¨æˆ·é’±åŒ…åœ°å€
    amount: string;                 // æç°é‡‘é¢ï¼ˆUSDTï¼‰
    status: string;                 // çŠ¶æ€ï¼ˆPendingï¼‰
    energyLockedAmount: string;     // é”å®šçš„èƒ½é‡å€¼ï¼ˆâš ï¸ å‰ç«¯æœªæ˜¾ç¤ºï¼‰
    payoutTxHash: string | null;    // é“¾ä¸Šäº¤æ˜“å“ˆå¸Œï¼ˆå¦‚æœå·²å®Œæˆï¼‰
    createdAt: string;              // åˆ›å»ºæ—¶é—´
    updatedAt: string;              // æ›´æ–°æ—¶é—´
    alert: boolean;                 // æ˜¯å¦å‘Šè­¦ï¼ˆâš ï¸ å‰ç«¯æœªä½¿ç”¨ï¼‰
  }>;
}
```

### 3. å‰ç«¯æœªæ˜¾ç¤ºçš„å­—æ®µ

**é—®é¢˜å‘ç°**:
- âŒ `energyLockedAmount`: é”å®šçš„èƒ½é‡å€¼æœªåœ¨å‰ç«¯æ˜¾ç¤º
- âŒ `alert`: å‘Šè­¦æ ‡å¿—æœªåœ¨å‰ç«¯ä½¿ç”¨
- âŒ `updatedAt`: æ›´æ–°æ—¶é—´æœªæ˜¾ç¤º

**å»ºè®®**:
- å¯ä»¥è€ƒè™‘åœ¨æç°å¡ç‰‡ä¸­æ˜¾ç¤ºé”å®šçš„èƒ½é‡å€¼ï¼Œå¸®åŠ©ç®¡ç†å‘˜äº†è§£æç°æˆæœ¬
- å¦‚æœ `alert` ä¸º `true`ï¼Œå¯ä»¥æ˜¾ç¤ºè­¦å‘Šå›¾æ ‡æˆ–ç‰¹æ®Šæ ·å¼

---

## ğŸ” éªŒè¯é€»è¾‘åˆ†æ

### 1. æç°ç”³è¯·éªŒè¯ï¼ˆåç«¯ï¼‰

**ä½ç½®**: `rabbit-ai-backend/src/services/withdraw.ts` (`applyWithdraw` å‡½æ•°)

**éªŒè¯é¡¹**:

#### 1.1 é‡‘é¢éªŒè¯
```typescript
const amount = Number(amountStr);
if (!Number.isFinite(amount) || amount <= 0) {
  throw new ApiError('INVALID_REQUEST', 'Invalid amount');
}
```
- âœ… éªŒè¯é‡‘é¢æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
- âœ… éªŒè¯é‡‘é¢æ˜¯å¦å¤§äº 0

#### 1.2 USDT ä½™é¢éªŒè¯
```typescript
const availableUsdt = Math.max(0, realTimeEarnings - totalPending);
if (availableUsdt < amount) {
  throw new ApiError('USDT_NOT_ENOUGH', `USDT not enough (available ${availableUsdt.toFixed(6)}, need ${amount})`, 400);
}
```
- âœ… è®¡ç®—å®æ—¶æ”¶ç›Šï¼ˆLazy Settleï¼‰
- âœ… å‡å»æ‰€æœ‰ Pending çŠ¶æ€çš„æç°é‡‘é¢
- âœ… éªŒè¯å¯ç”¨ä½™é¢æ˜¯å¦è¶³å¤Ÿ

#### 1.3 èƒ½é‡éªŒè¯
```typescript
const withdrawEnergyRatio = await getEnergyConfigValueCached(EnergyConfigKeys.WITHDRAW_RATIO);
const requiredEnergy = Math.ceil(amount * withdrawEnergyRatio);
if (energyAvailable < requiredEnergy) {
  throw new ApiError('ENERGY_NOT_ENOUGH', `Energy not enough (need >= ${requiredEnergy}, available ${energyAvailable})`, 400);
}
```
- âœ… ä½¿ç”¨åŠ¨æ€é…ç½®è·å–èƒ½é‡æ¶ˆè€—æ¯”ä¾‹ï¼ˆé»˜è®¤ 1 USDT = 10 Energyï¼‰
- âœ… è®¡ç®—æ‰€éœ€èƒ½é‡ï¼ˆå‘ä¸Šå–æ•´ï¼‰
- âœ… éªŒè¯å¯ç”¨èƒ½é‡æ˜¯å¦è¶³å¤Ÿ

#### 1.4 é˜²é‡å¤æäº¤éªŒè¯
```typescript
const { data: pending } = await supabase
  .from('withdrawals')
  .select('id,amount,status,created_at')
  .eq('address', addr)
  .eq('status', 'Pending')
  .order('created_at', { ascending: false })
  .limit(1);

const now = Date.now();
if (pending && pending.length > 0) {
  const lastPendingTime = new Date(pending[0].created_at).getTime();
  if (now - lastPendingTime < 5 * 60 * 1000) { // 5åˆ†é’Ÿå†…
    throw new ApiError('DUPLICATE_REQUEST', 'Duplicate withdrawal request within 5 minutes', 400);
  }
}
```
- âœ… æ£€æŸ¥ 5 åˆ†é’Ÿå†…æ˜¯å¦æœ‰ Pending çŠ¶æ€çš„æç°ç”³è¯·
- âœ… é˜²æ­¢ç”¨æˆ·é‡å¤æäº¤

---

### 2. å®Œæˆæç°éªŒè¯ï¼ˆåç«¯ï¼‰

**ä½ç½®**: `rabbit-ai-backend/src/services/admin.ts` (`completeWithdrawal` å‡½æ•°)

**éªŒè¯é¡¹**:

#### 2.1 æç°è®°å½•å­˜åœ¨æ€§éªŒè¯
```typescript
const { data: w } = await supabase
  .from('withdrawals')
  .select('id,address,amount,status,payout_tx_hash,energy_locked_amount')
  .eq('id', params.withdrawalId)
  .maybeSingle();

if (!w) throw new ApiError('NOT_FOUND', 'Withdrawal not found', 404);
```
- âœ… éªŒè¯æç°è®°å½•æ˜¯å¦å­˜åœ¨

#### 2.2 çŠ¶æ€éªŒè¯
```typescript
const status = String((w as any).status);
if (status === 'Completed') {
  return { ok: true, id: (w as any).id, status, duplicated: true, payoutTxHash: (w as any).payout_tx_hash };
}
if (status !== 'Pending') {
  throw new ApiError('INVALID_STATE', `Withdrawal status is ${status}`, 400);
}
```
- âœ… éªŒè¯æç°çŠ¶æ€æ˜¯å¦ä¸º `Pending`
- âœ… å¦‚æœå·²å®Œæˆï¼Œè¿”å›é‡å¤æ ‡è®°ï¼ˆå¹‚ç­‰æ€§ï¼‰

#### 2.3 é˜²é‡æ”¾æ”»å‡»éªŒè¯
```typescript
const { data: used } = await supabase
  .from('withdrawals')
  .select('id,status')
  .eq('payout_tx_hash', params.payoutTxHash)
  .limit(1);

if (used && used.length > 0 && String((used[0] as any).id) !== String((w as any).id)) {
  throw new ApiError('INVALID_PAYOUT', 'PAYOUT_TX_ALREADY_USED', 400);
}
```
- âœ… éªŒè¯äº¤æ˜“å“ˆå¸Œæ˜¯å¦å·²è¢«å…¶ä»–æç°è®°å½•ä½¿ç”¨
- âœ… é˜²æ­¢åŒä¸€ç¬”é“¾ä¸Šäº¤æ˜“è¢«é‡å¤ç”¨äºå®Œæˆå¤šä¸ªæç°ç”³è¯·

#### 2.4 é“¾ä¸Šäº¤æ˜“éªŒè¯
```typescript
const receipt = await params.provider.getTransactionReceipt(params.payoutTxHash);
if (!receipt) throw new ApiError('TX_NOT_FOUND', 'Payout tx receipt not found', 404);
if (receipt.status !== 1) throw new ApiError('TX_FAILED', 'Payout tx failed', 400);

const iface = new ethers.utils.Interface(ERC20_ABI);
let matched = false;
for (const log of receipt.logs) {
  if (!log.address || lower(log.address) !== lower(usdtAddr)) continue;
  try {
    const parsed = iface.parseLog(log);
    if (parsed.name !== 'Transfer') continue;
    const to = lower(parsed.args.to);
    const value = parsed.args.value as ethers.BigNumber;
    // åªéªŒè¯æ¥æ”¶æ–¹å’Œé‡‘é¢ï¼Œä¸éªŒè¯å‘é€æ–¹ï¼ˆå…è®¸ä»ä»»ä½•åœ°å€è½¬å‡ºï¼‰
    if (to === userAddr && value.eq(expectedValue)) {
      matched = true;
      break;
    }
  } catch {
    // ignore
  }
}
if (!matched) throw new ApiError('INVALID_PAYOUT', 'USDT Transfer not matched (to/value)', 400);
```
- âœ… éªŒè¯äº¤æ˜“æ˜¯å¦å­˜åœ¨
- âœ… éªŒè¯äº¤æ˜“æ˜¯å¦æˆåŠŸï¼ˆ`status === 1`ï¼‰
- âœ… éªŒè¯äº¤æ˜“æ¥æ”¶æ–¹æ˜¯å¦ä¸ºæç°ç”¨æˆ·åœ°å€
- âœ… éªŒè¯äº¤æ˜“é‡‘é¢æ˜¯å¦åŒ¹é…
- âš ï¸ **æ³¨æ„**: ä¸éªŒè¯å‘é€æ–¹åœ°å€ï¼ˆå…è®¸ä»ä»»ä½•åœ°å€è½¬å‡ºï¼Œæ”¯æŒ MetaMask æ‰‹åŠ¨å‘æ”¾ï¼‰

---

### 3. å‰ç«¯éªŒè¯é€»è¾‘

**ä½ç½®**: `rabbit-ai-admin/pages/FinanceOps.tsx`

#### 3.1 é’±åŒ…è¿æ¥éªŒè¯
```typescript
if (!walletConnected || !walletAddress) {
  showNotification('warning', 'è¯·å…ˆè¿æ¥å‡ºæ¬¾é’±åŒ…');
  return;
}
```
- âœ… éªŒè¯é’±åŒ…æ˜¯å¦å·²è¿æ¥

#### 3.2 USDT åˆçº¦ä¿¡æ¯éªŒè¯
```typescript
if (!usdtContractInfo) {
  showNotification('error', 'USDT åˆçº¦ä¿¡æ¯æœªåŠ è½½ï¼Œè¯·ç¨åé‡è¯•');
  return;
}
```
- âœ… éªŒè¯ USDT åˆçº¦ä¿¡æ¯æ˜¯å¦å·²åŠ è½½

#### 3.3 é’±åŒ…ä½™é¢éªŒè¯ï¼ˆå‘æ”¾å‰ï¼‰
```typescript
const { getUSDTBalance } = await import('../utils/web3');
const balance = await getUSDTBalance(usdtContractInfo.address, walletAddress);
const balanceNum = parseFloat(balance);
const amountNum = withdrawal.amount;

if (balanceNum < amountNum) {
  showNotification('error', `é’±åŒ… USDT ä½™é¢ä¸è¶³ï¼å½“å‰ä½™é¢: ${balanceNum.toFixed(2)} USDTï¼Œéœ€è¦: ${amountNum.toFixed(2)} USDT`);
  return;
}
```
- âœ… åœ¨ç¡®è®¤å¯¹è¯æ¡†å¼¹å‡ºå‰æ£€æŸ¥ä½™é¢
- âœ… åœ¨ç¡®è®¤åã€å‘é€äº¤æ˜“å‰å†æ¬¡æ£€æŸ¥ä½™é¢ï¼ˆé˜²æ­¢åœ¨ç¡®è®¤æœŸé—´ä½™é¢å˜åŒ–ï¼‰

#### 3.4 é’±åŒ…åœ°å€åŒ¹é…éªŒè¯
```typescript
useEffect(() => {
  if (walletAddress && adminPayoutAddress) {
    const matched = walletAddress.toLowerCase() === adminPayoutAddress.toLowerCase();
    setWalletAddressMatched(matched);
    if (!matched) {
      showNotification('warning', `è¿æ¥çš„é’±åŒ…åœ°å€ä¸é…ç½®çš„ç®¡ç†å‘˜é’±åŒ…åœ°å€ä¸åŒ¹é…ã€‚é…ç½®åœ°å€: ${adminPayoutAddress.substring(0, 6)}...${adminPayoutAddress.substring(38)}`);
    } else {
      showNotification('success', 'é’±åŒ…åœ°å€éªŒè¯é€šè¿‡ï¼Œä¸ç®¡ç†å‘˜é…ç½®ä¸€è‡´');
    }
  }
}, [walletAddress, adminPayoutAddress]);
```
- âœ… éªŒè¯è¿æ¥çš„é’±åŒ…åœ°å€æ˜¯å¦ä¸ç³»ç»Ÿé…ç½®çš„ç®¡ç†å‘˜é’±åŒ…åœ°å€ä¸€è‡´
- âœ… å¦‚æœä¸åŒ¹é…ï¼Œæ˜¾ç¤ºè­¦å‘Šï¼ˆä½†ä¸é˜»æ­¢æ“ä½œï¼Œå› ä¸ºæ”¯æŒ MetaMask æ‰‹åŠ¨å‘æ”¾ï¼‰

#### 3.5 äº¤æ˜“å“ˆå¸Œè¾“å…¥éªŒè¯ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰
```typescript
<button 
  onClick={handleCompleteApprove}
  disabled={!txHash || processingId === activeWithdrawal.id}
  // ...
>
```
- âœ… éªŒè¯äº¤æ˜“å“ˆå¸Œæ˜¯å¦å·²è¾“å…¥ï¼ˆæŒ‰é’®ç¦ç”¨çŠ¶æ€ï¼‰
- âœ… éªŒè¯äº¤æ˜“å“ˆå¸Œæ ¼å¼ï¼ˆé€šè¿‡åç«¯ API éªŒè¯ï¼‰

---

## ğŸ›¡ï¸ å®‰å…¨æ€§åˆ†æ

### 1. å·²å®ç°çš„å®‰å…¨æªæ–½

#### âœ… é˜²é‡æ”¾æ”»å‡»
- åç«¯éªŒè¯äº¤æ˜“å“ˆå¸Œæ˜¯å¦å·²è¢«ä½¿ç”¨
- é˜²æ­¢åŒä¸€ç¬”é“¾ä¸Šäº¤æ˜“è¢«é‡å¤ç”¨äºå®Œæˆå¤šä¸ªæç°ç”³è¯·

#### âœ… é“¾ä¸Šäº¤æ˜“éªŒè¯
- éªŒè¯äº¤æ˜“æ˜¯å¦å­˜åœ¨
- éªŒè¯äº¤æ˜“æ˜¯å¦æˆåŠŸ
- éªŒè¯äº¤æ˜“æ¥æ”¶æ–¹å’Œé‡‘é¢æ˜¯å¦åŒ¹é…

#### âœ… çŠ¶æ€éªŒè¯
- éªŒè¯æç°çŠ¶æ€æ˜¯å¦ä¸º `Pending`
- é˜²æ­¢é‡å¤å®Œæˆå·²å®Œæˆçš„æç°

#### âœ… ä½™é¢éªŒè¯
- å‰ç«¯åœ¨å‘æ”¾å‰æ£€æŸ¥é’±åŒ…ä½™é¢
- åç«¯åœ¨æç°ç”³è¯·æ—¶éªŒè¯ç”¨æˆ·ä½™é¢

#### âœ… èƒ½é‡éªŒè¯
- åç«¯éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰è¶³å¤Ÿçš„èƒ½é‡
- ä½¿ç”¨åŠ¨æ€é…ç½®è®¡ç®—æ‰€éœ€èƒ½é‡

---

### 2. æ½œåœ¨å®‰å…¨é£é™©

#### âš ï¸ é£é™© 1: ä¸éªŒè¯å‘é€æ–¹åœ°å€

**é—®é¢˜æè¿°**:
åç«¯ `completeWithdrawal` å‡½æ•°åªéªŒè¯æ¥æ”¶æ–¹å’Œé‡‘é¢ï¼Œä¸éªŒè¯å‘é€æ–¹åœ°å€ã€‚

**å½“å‰ä»£ç **:
```typescript
// åªéªŒè¯æ¥æ”¶æ–¹å’Œé‡‘é¢ï¼Œä¸éªŒè¯å‘é€æ–¹ï¼ˆå…è®¸ä»ä»»ä½•åœ°å€è½¬å‡ºï¼‰
if (to === userAddr && value.eq(expectedValue)) {
  matched = true;
  break;
}
```

**å½±å“**:
- âœ… **æ­£é¢**: æ”¯æŒ MetaMask æ‰‹åŠ¨å‘æ”¾ï¼Œç®¡ç†å‘˜å¯ä»¥ä»ä»»ä½•é’±åŒ…åœ°å€å‘æ”¾
- âš ï¸ **é£é™©**: å¦‚æœç®¡ç†å‘˜è¯¯æ“ä½œï¼Œä»é”™è¯¯çš„åœ°å€å‘æ”¾ï¼Œç³»ç»Ÿä»ä¼šæ ‡è®°ä¸ºå®Œæˆ

**ç¼“è§£æªæ–½**:
- å‰ç«¯æ˜¾ç¤ºé’±åŒ…åœ°å€åŒ¹é…çŠ¶æ€ï¼Œæé†’ç®¡ç†å‘˜
- ç®¡ç†å‘˜åœ¨å‘æ”¾å‰ä¼šçœ‹åˆ°è¿æ¥çš„é’±åŒ…åœ°å€

**å»ºè®®**:
- å¦‚æœç³»ç»Ÿè¦æ±‚å¿…é¡»ä»é…ç½®çš„ç®¡ç†å‘˜é’±åŒ…å‘æ”¾ï¼Œå¯ä»¥åœ¨åç«¯æ·»åŠ å‘é€æ–¹éªŒè¯ï¼ˆå¯é€‰é…ç½®ï¼‰

---

#### âš ï¸ é£é™© 2: å‰ç«¯ä½™é¢æ£€æŸ¥å¯èƒ½è¢«ç»•è¿‡

**é—®é¢˜æè¿°**:
å‰ç«¯åœ¨å‘æ”¾å‰æ£€æŸ¥ä½™é¢ï¼Œä½†å¦‚æœç”¨æˆ·åœ¨å‰ç«¯ä»£ç è¢«ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ç»•è¿‡æ£€æŸ¥ã€‚

**å½±å“**:
- å‰ç«¯æ£€æŸ¥åªæ˜¯ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- çœŸæ­£çš„ä¿æŠ¤åœ¨åç«¯çš„é“¾ä¸ŠéªŒè¯ï¼ˆå¦‚æœä½™é¢ä¸è¶³ï¼Œäº¤æ˜“ä¼šå¤±è´¥ï¼‰

**ç¼“è§£æªæ–½**:
- åç«¯é“¾ä¸ŠéªŒè¯æ˜¯æœ€ç»ˆä¿éšœ
- å‰ç«¯æ£€æŸ¥å¤±è´¥æ—¶ï¼ŒMetaMask äº¤æ˜“ä¹Ÿä¼šå¤±è´¥

**å»ºè®®**:
- å½“å‰è®¾è®¡æ˜¯åˆç†çš„ï¼Œå‰ç«¯æ£€æŸ¥ç”¨äºæå‰å‘ç°é—®é¢˜ï¼Œåç«¯éªŒè¯æ˜¯æœ€ç»ˆä¿éšœ

---

#### âš ï¸ é£é™© 3: äº¤æ˜“å“ˆå¸Œæ ¼å¼éªŒè¯ä¸è¶³

**é—®é¢˜æè¿°**:
å‰ç«¯åªæ£€æŸ¥äº¤æ˜“å“ˆå¸Œæ˜¯å¦ä¸ºç©ºï¼Œä¸éªŒè¯æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚

**å½“å‰ä»£ç **:
```typescript
disabled={!txHash || processingId === activeWithdrawal.id}
```

**å½±å“**:
- å¦‚æœç”¨æˆ·è¾“å…¥é”™è¯¯çš„äº¤æ˜“å“ˆå¸Œï¼Œä¼šåœ¨åç«¯éªŒè¯æ—¶å¤±è´¥
- ç”¨æˆ·ä½“éªŒå¯èƒ½ä¸å¤Ÿå‹å¥½

**å»ºè®®**:
- å¯ä»¥æ·»åŠ å‰ç«¯æ ¼å¼éªŒè¯ï¼ˆä¾‹å¦‚ï¼šå¿…é¡»ä»¥ `0x` å¼€å¤´ï¼Œé•¿åº¦ä¸º 66 å­—ç¬¦ï¼‰
- ä½†åç«¯éªŒè¯æ˜¯æœ€ç»ˆä¿éšœï¼Œå‰ç«¯éªŒè¯åªæ˜¯ä¼˜åŒ–

---

## ğŸ“Š æ•°æ®æµç¨‹åˆ†æ

### 1. æç°ç”³è¯·æµç¨‹

```
ç”¨æˆ·æäº¤æç°ç”³è¯·
    â†“
åç«¯ applyWithdraw éªŒè¯
    â”œâ”€ é‡‘é¢éªŒè¯ (> 0)
    â”œâ”€ USDT ä½™é¢éªŒè¯ (Lazy Settle)
    â”œâ”€ èƒ½é‡éªŒè¯ (åŠ¨æ€é…ç½®)
    â””â”€ é˜²é‡å¤æäº¤éªŒè¯ (5åˆ†é’Ÿå†…)
    â†“
é”å®šèƒ½é‡å’Œ USDT
    â”œâ”€ energy_locked += requiredEnergy
    â”œâ”€ usdt_locked += amount
    â””â”€ usdt_total = realTimeEarnings - amount
    â†“
åˆ›å»ºæç°è®°å½• (status: Pending)
    â†“
è¿”å›ç”³è¯·æˆåŠŸ
```

### 2. å®Œæˆæç°æµç¨‹ï¼ˆMetaMask è‡ªåŠ¨æ¨¡å¼ï¼‰

```
ç®¡ç†å‘˜ç‚¹å‡»"å‘æ”¾"æŒ‰é’®
    â†“
å‰ç«¯éªŒè¯
    â”œâ”€ é’±åŒ…è¿æ¥éªŒè¯
    â”œâ”€ USDT åˆçº¦ä¿¡æ¯éªŒè¯
    â””â”€ é’±åŒ…ä½™é¢éªŒè¯ï¼ˆä¸¤æ¬¡æ£€æŸ¥ï¼‰
    â†“
æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    â†“
ç®¡ç†å‘˜ç¡®è®¤
    â†“
å‰ç«¯è°ƒç”¨ MetaMask transferUSDT
    â†“
ç­‰å¾…äº¤æ˜“ç¡®è®¤
    â†“
è°ƒç”¨åç«¯ completeWithdrawal API
    â”œâ”€ æç°è®°å½•å­˜åœ¨æ€§éªŒè¯
    â”œâ”€ çŠ¶æ€éªŒè¯ (Pending)
    â”œâ”€ é˜²é‡æ”¾æ”»å‡»éªŒè¯
    â””â”€ é“¾ä¸Šäº¤æ˜“éªŒè¯ (æ¥æ”¶æ–¹ã€é‡‘é¢)
    â†“
æ›´æ–°æ•°æ®åº“
    â”œâ”€ é‡Šæ”¾é”å®šçš„èƒ½é‡å’Œ USDT
    â”œâ”€ æ‰£é™¤æ€»èƒ½é‡
    â””â”€ æ›´æ–°æç°çŠ¶æ€ä¸º Completed
    â†“
è¿”å›æˆåŠŸ
```

### 3. å®Œæˆæç°æµç¨‹ï¼ˆæ‰‹åŠ¨è¾“å…¥äº¤æ˜“å“ˆå¸Œæ¨¡å¼ï¼‰

```
ç®¡ç†å‘˜ç‚¹å‡»"æ‰¹å‡†æç°"æŒ‰é’®
    â†“
æ‰“å¼€æ‰¹å‡†å¯¹è¯æ¡†
    â†“
ç®¡ç†å‘˜åœ¨é“¾ä¸Šå®Œæˆè½¬è´¦ï¼ˆä½¿ç”¨ MetaMask æˆ–å…¶ä»–é’±åŒ…ï¼‰
    â†“
è¾“å…¥äº¤æ˜“å“ˆå¸Œ
    â†“
ç‚¹å‡»"ç¡®è®¤å¹¶åŒæ­¥çŠ¶æ€"
    â†“
è°ƒç”¨åç«¯ completeWithdrawal API
    â”œâ”€ æç°è®°å½•å­˜åœ¨æ€§éªŒè¯
    â”œâ”€ çŠ¶æ€éªŒè¯ (Pending)
    â”œâ”€ é˜²é‡æ”¾æ”»å‡»éªŒè¯
    â””â”€ é“¾ä¸Šäº¤æ˜“éªŒè¯ (æ¥æ”¶æ–¹ã€é‡‘é¢)
    â†“
æ›´æ–°æ•°æ®åº“
    â”œâ”€ é‡Šæ”¾é”å®šçš„èƒ½é‡å’Œ USDT
    â”œâ”€ æ‰£é™¤æ€»èƒ½é‡
    â””â”€ æ›´æ–°æç°çŠ¶æ€ä¸º Completed
    â†“
è¿”å›æˆåŠŸ
```

---

## âœ… éªŒè¯æ€»ç»“

### å‰ç«¯éªŒè¯

| éªŒè¯é¡¹ | ä½ç½® | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|------|
| é’±åŒ…è¿æ¥ | `handleRelease` | âœ… | æ£€æŸ¥é’±åŒ…æ˜¯å¦å·²è¿æ¥ |
| USDT åˆçº¦ä¿¡æ¯ | `handleRelease` | âœ… | æ£€æŸ¥åˆçº¦ä¿¡æ¯æ˜¯å¦å·²åŠ è½½ |
| é’±åŒ…ä½™é¢ï¼ˆç¬¬ä¸€æ¬¡ï¼‰ | `handleRelease` | âœ… | ç¡®è®¤å‰æ£€æŸ¥ä½™é¢ |
| é’±åŒ…ä½™é¢ï¼ˆç¬¬äºŒæ¬¡ï¼‰ | `handleRelease` | âœ… | ç¡®è®¤åã€å‘é€å‰å†æ¬¡æ£€æŸ¥ |
| é’±åŒ…åœ°å€åŒ¹é… | `useEffect` | âœ… | éªŒè¯è¿æ¥åœ°å€ä¸é…ç½®åœ°å€æ˜¯å¦ä¸€è‡´ |
| äº¤æ˜“å“ˆå¸Œè¾“å…¥ | `handleCompleteApprove` | âš ï¸ | åªæ£€æŸ¥æ˜¯å¦ä¸ºç©ºï¼Œä¸éªŒè¯æ ¼å¼ |

### åç«¯éªŒè¯

| éªŒè¯é¡¹ | ä½ç½® | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|------|
| é‡‘é¢éªŒè¯ | `applyWithdraw` | âœ… | éªŒè¯é‡‘é¢ > 0 |
| USDT ä½™é¢éªŒè¯ | `applyWithdraw` | âœ… | Lazy Settle + éªŒè¯å¯ç”¨ä½™é¢ |
| èƒ½é‡éªŒè¯ | `applyWithdraw` | âœ… | åŠ¨æ€é…ç½® + éªŒè¯å¯ç”¨èƒ½é‡ |
| é˜²é‡å¤æäº¤ | `applyWithdraw` | âœ… | 5åˆ†é’Ÿå†…ä¸èƒ½é‡å¤æäº¤ |
| æç°è®°å½•å­˜åœ¨æ€§ | `completeWithdrawal` | âœ… | éªŒè¯è®°å½•æ˜¯å¦å­˜åœ¨ |
| çŠ¶æ€éªŒè¯ | `completeWithdrawal` | âœ… | éªŒè¯çŠ¶æ€æ˜¯å¦ä¸º Pending |
| é˜²é‡æ”¾æ”»å‡» | `completeWithdrawal` | âœ… | éªŒè¯äº¤æ˜“å“ˆå¸Œæ˜¯å¦å·²è¢«ä½¿ç”¨ |
| é“¾ä¸Šäº¤æ˜“å­˜åœ¨æ€§ | `completeWithdrawal` | âœ… | éªŒè¯äº¤æ˜“æ˜¯å¦å­˜åœ¨ |
| é“¾ä¸Šäº¤æ˜“çŠ¶æ€ | `completeWithdrawal` | âœ… | éªŒè¯äº¤æ˜“æ˜¯å¦æˆåŠŸ |
| é“¾ä¸Šäº¤æ˜“æ¥æ”¶æ–¹ | `completeWithdrawal` | âœ… | éªŒè¯æ¥æ”¶æ–¹æ˜¯å¦ä¸ºæç°ç”¨æˆ· |
| é“¾ä¸Šäº¤æ˜“é‡‘é¢ | `completeWithdrawal` | âœ… | éªŒè¯é‡‘é¢æ˜¯å¦åŒ¹é… |
| é“¾ä¸Šäº¤æ˜“å‘é€æ–¹ | `completeWithdrawal` | âŒ | **ä¸éªŒè¯**ï¼ˆæ”¯æŒ MetaMask æ‰‹åŠ¨å‘æ”¾ï¼‰ |

---

## ğŸ¯ æ”¹è¿›å»ºè®®

### ä¼˜å…ˆçº§ P1ï¼ˆå»ºè®®å®æ–½ï¼‰

1. **æ˜¾ç¤ºé”å®šçš„èƒ½é‡å€¼**
   - åœ¨æç°å¡ç‰‡ä¸­æ˜¾ç¤º `energyLockedAmount`
   - å¸®åŠ©ç®¡ç†å‘˜äº†è§£æç°æˆæœ¬

2. **äº¤æ˜“å“ˆå¸Œæ ¼å¼éªŒè¯**
   - å‰ç«¯æ·»åŠ æ ¼å¼éªŒè¯ï¼ˆ`0x` å¼€å¤´ï¼Œ66 å­—ç¬¦ï¼‰
   - æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

3. **å‘Šè­¦åŠŸèƒ½ä½¿ç”¨**
   - å¦‚æœ `alert` ä¸º `true`ï¼Œæ˜¾ç¤ºè­¦å‘Šå›¾æ ‡æˆ–ç‰¹æ®Šæ ·å¼
   - å¸®åŠ©ç®¡ç†å‘˜è¯†åˆ«å¼‚å¸¸æç°

### ä¼˜å…ˆçº§ P2ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

4. **å‘é€æ–¹åœ°å€éªŒè¯ï¼ˆå¯é€‰ï¼‰**
   - å¦‚æœç³»ç»Ÿè¦æ±‚å¿…é¡»ä»é…ç½®çš„ç®¡ç†å‘˜é’±åŒ…å‘æ”¾ï¼Œå¯ä»¥æ·»åŠ å‘é€æ–¹éªŒè¯
   - ä½œä¸ºå¯é€‰é…ç½®é¡¹ï¼Œä¸å½±å“ MetaMask æ‰‹åŠ¨å‘æ”¾åŠŸèƒ½

5. **æç°å†å²è®°å½•**
   - æ˜¾ç¤ºå·²å®Œæˆçš„æç°è®°å½•
   - å¸®åŠ©ç®¡ç†å‘˜è¿½è¸ªå†å²æ“ä½œ

---

## ğŸ“ æ€»ç»“

### ä¼˜ç‚¹

- âœ… **éªŒè¯æœºåˆ¶å®Œå–„**: å‰ç«¯å’Œåç«¯éƒ½æœ‰å¤šå±‚éªŒè¯
- âœ… **å®‰å…¨æ€§é«˜**: é˜²é‡æ”¾æ”»å‡»ã€é“¾ä¸Šäº¤æ˜“éªŒè¯ã€çŠ¶æ€éªŒè¯
- âœ… **ç”¨æˆ·ä½“éªŒå¥½**: æ”¯æŒ MetaMask è‡ªåŠ¨å‘æ”¾å’Œæ‰‹åŠ¨è¾“å…¥ä¸¤ç§æ¨¡å¼
- âœ… **ç§»åŠ¨ç«¯æ”¯æŒ**: æ”¯æŒç§»åŠ¨ç«¯ MetaMask è¿æ¥å’Œæ“ä½œ
- âœ… **ä½™é¢æ£€æŸ¥**: å‰ç«¯åœ¨å‘æ”¾å‰æ£€æŸ¥ä½™é¢ï¼Œé¿å…äº¤æ˜“å¤±è´¥

### ç¼ºç‚¹

- âŒ **å‰ç«¯å­—æ®µæ˜¾ç¤ºä¸å®Œæ•´**: `energyLockedAmount` å’Œ `alert` æœªä½¿ç”¨
- âš ï¸ **å‘é€æ–¹åœ°å€ä¸éªŒè¯**: æ”¯æŒä»ä»»ä½•åœ°å€å‘æ”¾ï¼ˆè®¾è®¡é€‰æ‹©ï¼Œé Bugï¼‰
- âš ï¸ **äº¤æ˜“å“ˆå¸Œæ ¼å¼éªŒè¯ä¸è¶³**: å‰ç«¯åªæ£€æŸ¥æ˜¯å¦ä¸ºç©º

### å»ºè®®

**å½“å‰ç³»ç»Ÿè®¾è®¡åˆç†ï¼ŒéªŒè¯æœºåˆ¶å®Œå–„**ã€‚å»ºè®®çš„æ”¹è¿›ä¸»è¦æ˜¯ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼Œä¸å½±å“å®‰å…¨æ€§ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-07  
**å®¡æŸ¥äºº**: AI Assistant  
**å®¡æŸ¥èŒƒå›´**: è´¢åŠ¡å®¡æ ¸åŠŸèƒ½å®Œæ•´æ•°æ®æµç¨‹å’ŒéªŒè¯é€»è¾‘

