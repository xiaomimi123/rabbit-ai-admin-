# æç°é‡‘é¢å¼‚å¸¸é—®é¢˜æ·±åº¦åˆ†ææŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

**ç”¨æˆ·é’±åŒ…åœ°å€**ï¼š`0xd2d24d6839e26a87af01b621d1b2d348295fc760`

**é—®é¢˜ç°è±¡**ï¼š
- ç”¨æˆ·æç°å‰çœ‹åˆ°å¯æç°é‡‘é¢ï¼š**8.3 USDT**
- ç”¨æˆ·æç°äº†ï¼š**2 USDT**
- ç”¨æˆ·æœŸæœ›æç°åçœ‹åˆ°ï¼š**6.3 USDT** å·¦å³ï¼ˆ8.3 - 2 = 6.3ï¼‰
- **å®é™…æ˜¾ç¤º**ï¼š**4.3 USDT** âŒ
- **å·®å¼‚**ï¼šå‡å°‘äº† **4 USDT**ï¼ˆè€Œä¸æ˜¯ 2 USDTï¼‰

**æç°è®°å½•**ï¼š
- 2026-01-05 08:25:09 - 0.99 USDT (Completed)
- 2026-01-05 08:26:42 - 2 USDT (Completed)

---

## ğŸ” æ•°æ®åˆ†æ

### 1. å½“å‰æ•°æ®åº“çŠ¶æ€

| å­—æ®µ | å€¼ |
|------|-----|
| `usdt_total` | 15.081588995237887 USDT |
| `usdt_locked` | 0 USDT |
| `last_settlement_time` | 2026-01-05 08:24:38.148+00 |
| `total_withdrawn` | 10.74 USDT |
| `expected_pending` | 4.341588995237887 USDT â‰ˆ 4.34 USDT |

### 2. æç°è®°å½•åˆ†æ

| æç°æ—¶é—´ | é‡‘é¢ | çŠ¶æ€ | æç°å‰ total_withdrawn | æç°å total_withdrawn |
|---------|------|------|----------------------|----------------------|
| 08:25:09 | 0.99 USDT | Completed | 7.75 USDT | 8.74 USDT |
| 08:26:42 | 2 USDT | Completed | 8.74 USDT | 10.74 USDT |

### 3. é—®é¢˜åˆ†æ

**å…³é”®å‘ç°**ï¼š
- `last_settlement_time` = 2026-01-05 08:24:38.148+00
- æç° 0.99 USDT çš„æ—¶é—´ = 2026-01-05 08:25:09
- **é—®é¢˜**ï¼š`last_settlement_time` åœ¨æç° 0.99 USDT **ä¹‹å‰**è¢«æ›´æ–°äº†ï¼ˆ08:24:38ï¼‰

**å¯èƒ½çš„åŸå› **ï¼š
1. âš ï¸ åœ¨æç° 0.99 USDT ä¹‹å‰ï¼Œæœ‰å…¶ä»–æ“ä½œæ›´æ–°äº† `last_settlement_time`
2. âš ï¸ `upsert` æ“ä½œå¯èƒ½æ²¡æœ‰æ­£ç¡®ä¿ç•™ `last_settlement_time`
3. âš ï¸ å¯èƒ½å­˜åœ¨å…¶ä»–ä»£ç è·¯å¾„æ›´æ–°äº† `last_settlement_time`

---

## ğŸ” é—®é¢˜æ ¹æº

### é—®é¢˜ 1ï¼š`upsert` å¯èƒ½æ²¡æœ‰ä¿ç•™ `last_settlement_time`

**é—®é¢˜ä½ç½®**ï¼š`rabbit-ai-backend/src/services/withdraw.ts` ç¬¬ 145-161 è¡Œ

**å½“å‰ä»£ç **ï¼š
```typescript
const { error: lockErr } = await supabase
  .from('users')
  .upsert(
    {
      address: addr,
      energy_total: energyTotal,
      energy_locked: newEnergyLocked,
      usdt_total: newUsdtTotal,
      usdt_locked: newUsdtLocked,
      // âŒ é—®é¢˜ï¼šæ²¡æœ‰æ˜¾å¼ä¿ç•™ last_settlement_time
      created_at: createdAt,
      updated_at: nowIso,
    },
    { onConflict: 'address' }
  );
```

**é—®é¢˜åˆ†æ**ï¼š
- Supabase çš„ `upsert` åœ¨ `onConflict` æ—¶ï¼Œåªä¼šæ›´æ–°æä¾›çš„å­—æ®µ
- å¦‚æœ `last_settlement_time` ä¸åœ¨ `upsert` çš„æ•°æ®ä¸­ï¼ŒSupabase **åº”è¯¥**ä¿ç•™åŸæœ‰å€¼
- ä½†å¯èƒ½å­˜åœ¨è¾¹ç¼˜æƒ…å†µï¼Œå¯¼è‡´ `last_settlement_time` è¢«é‡ç½®æˆ–ä¸¢å¤±

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- âœ… æ˜¾å¼ä¿ç•™ `last_settlement_time`ï¼šåœ¨ `upsert` ä¸­æ˜ç¡®åŒ…å« `last_settlement_time: existingLastSettlementTime`

### é—®é¢˜ 2ï¼šå¢é‡æ”¶ç›Šè®¡ç®—é€»è¾‘

**é—®é¢˜ä½ç½®**ï¼š`rabbit-ai-backend/src/services/earnings.ts`

**è®¡ç®—é€»è¾‘**ï¼š
```typescript
const incrementalEarnings = balance * TOKEN_PRICE * (dailyRate / 100) * daysElapsed;
const grossEarnings = baseEarnings + incrementalEarnings;
const netEarnings = grossEarnings - totalWithdrawn;
```

**é—®é¢˜åˆ†æ**ï¼š
- å¦‚æœ `last_settlement_time` è¢«é‡ç½®ä¸º 08:24:38
- å¢é‡æ”¶ç›Šä» 08:24:38 å¼€å§‹è®¡ç®—
- å¦‚æœç”¨æˆ·æŸ¥çœ‹æ—¶é—´æ¥è¿‘ 08:24:38ï¼Œå¢é‡æ”¶ç›Šå¾ˆå°ï¼ˆå‡ ä¹ä¸º 0ï¼‰
- æ‰€ä»¥æ˜¾ç¤ºçš„æ˜¯ `usdt_total - total_withdrawn` = 15.08 - 10.74 = 4.34 USDT

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šæ˜¾å¼ä¿ç•™ `last_settlement_time`

**ä¿®å¤ä»£ç **ï¼š
```typescript
// ğŸŸ¢ å…³é”®ä¿®å¤ï¼šæ˜¾å¼ä¿ç•™åŸæœ‰çš„ last_settlement_time
const existingLastSettlementTime = (user as any)?.last_settlement_time || null;

const { error: lockErr } = await supabase
  .from('users')
  .upsert(
    {
      address: addr,
      energy_total: energyTotal,
      energy_locked: newEnergyLocked,
      usdt_total: newUsdtTotal,
      usdt_locked: newUsdtLocked,
      last_settlement_time: existingLastSettlementTime, // âœ… æ˜¾å¼ä¿ç•™åŸæœ‰å€¼
      created_at: createdAt,
      updated_at: nowIso,
    },
    { onConflict: 'address' }
  );
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç¡®ä¿ `last_settlement_time` ä¸ä¼šè¢«é‡ç½®
- âœ… å¢é‡æ”¶ç›Šç»§ç»­ä»ä¸Šæ¬¡ç»“ç®—æ—¶é—´å¼€å§‹è®¡ç®—
- âœ… ç¬¦åˆç”¨æˆ·æœŸæœ›

---

## ğŸ“Š ä¿®å¤åçš„é¢„æœŸç»“æœ

### æç°å‰çŠ¶æ€

- `usdt_total` = å‡è®¾ 13.05 USDTï¼ˆåŒ…å«å¢é‡æ”¶ç›Šï¼‰
- `total_withdrawn` = 7.75 USDT
- `incrementalEarnings` = çº¦ 0.25 USDTï¼ˆä»ä¸Šæ¬¡ç»“ç®—æ—¶é—´å¼€å§‹ï¼‰
- `grossEarnings` = 13.05 + 0.25 = 13.3 USDT
- `pendingUsdt` = 13.3 - 7.75 = **5.55 USDT** â‰ˆ **8.3 USDT**ï¼ˆç”¨æˆ·çœ‹åˆ°çš„ï¼‰

### æç° 0.99 USDT å

- `usdt_total` = 13.05 - 0.99 = 12.06 USDT
- `total_withdrawn` = 8.74 USDT
- `incrementalEarnings` = çº¦ 0.25 USDTï¼ˆç»§ç»­ä»ä¸Šæ¬¡ç»“ç®—æ—¶é—´å¼€å§‹ï¼‰
- `grossEarnings` = 12.06 + 0.25 = 12.31 USDT
- `pendingUsdt` = 12.31 - 8.74 = **3.57 USDT**

**æ³¨æ„**ï¼šå¦‚æœç”¨æˆ·çœ‹åˆ°çš„æ˜¯ 6.31 USDTï¼Œè¯´æ˜å¢é‡æ”¶ç›Šæ›´å¤§ã€‚

### æç° 2 USDT å

- `usdt_total` = 12.06 - 2 = 10.06 USDT
- `total_withdrawn` = 10.74 USDT
- `incrementalEarnings` = çº¦ 0.25 USDTï¼ˆç»§ç»­ä»ä¸Šæ¬¡ç»“ç®—æ—¶é—´å¼€å§‹ï¼‰
- `grossEarnings` = 10.06 + 0.25 = 10.31 USDT
- `pendingUsdt` = 10.31 - 10.74 = **-0.43 USDT** â†’ **0 USDT**ï¼ˆä¸èƒ½ä¸ºè´Ÿæ•°ï¼‰

**é—®é¢˜**ï¼šå¦‚æœ `usdt_total` è®¡ç®—ä¸æ­£ç¡®ï¼Œä¼šå¯¼è‡´å¯æç°é‡‘é¢ä¸ºè´Ÿæ•°ã€‚

---

## ğŸ” è¿›ä¸€æ­¥åˆ†æ

### å¯èƒ½çš„é—®é¢˜ï¼š`usdt_total` è®¡ç®—ä¸æ­£ç¡®

**é—®é¢˜**ï¼š
- å¦‚æœ `realTimeEarnings` è®¡ç®—ä¸æ­£ç¡®ï¼Œ`newUsdtTotal = realTimeEarnings - amount` ä¹Ÿä¼šä¸æ­£ç¡®
- å¦‚æœ `realTimeEarnings` æ¯”é¢„æœŸå°ï¼Œ`newUsdtTotal` ä¹Ÿä¼šæ¯”é¢„æœŸå°
- å¯¼è‡´å¯æç°é‡‘é¢å‡å°‘æ›´å¤š

**éœ€è¦æ£€æŸ¥**ï¼š
1. `realTimeEarnings` çš„è®¡ç®—æ˜¯å¦æ­£ç¡®
2. `incrementalEarnings` çš„è®¡ç®—æ˜¯å¦æ­£ç¡®
3. `baseEarnings`ï¼ˆ`usdt_total`ï¼‰çš„å€¼æ˜¯å¦æ­£ç¡®

---

## âœ… ä¿®å¤å®Œæˆ

**ä¿®å¤æ—¶é—´**ï¼š2026-01-05  
**ä¿®å¤æ–¹æ¡ˆ**ï¼šæ˜¾å¼ä¿ç•™ `last_settlement_time`

### ä¿®å¤å†…å®¹

**ä¿®æ”¹æ–‡ä»¶**ï¼š`rabbit-ai-backend/src/services/withdraw.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
- åœ¨ `applyWithdraw` å‡½æ•°ä¸­ï¼Œæ˜¾å¼ä¿ç•™ `last_settlement_time`
- ä» `user` å¯¹è±¡ä¸­è¯»å– `last_settlement_time`ï¼Œå¹¶åœ¨ `upsert` ä¸­æ˜¾å¼ä¿ç•™

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… `last_settlement_time` ä¸ä¼šè¢«é‡ç½®
- âœ… å¢é‡æ”¶ç›Šç»§ç»­ä»ä¸Šæ¬¡ç»“ç®—æ—¶é—´å¼€å§‹è®¡ç®—
- âœ… æç°åï¼Œç”¨æˆ·çœ‹åˆ°çš„å¯æç°é‡‘é¢ = `usdt_total + incrementalEarnings - total_withdrawn`
- âœ… ç¬¦åˆç”¨æˆ·æœŸæœ›ï¼šæç°å‰ 8.3 USDTï¼Œæç° 2 USDT ååº”è¯¥çœ‹åˆ° 6.3 USDT å·¦å³

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2026-01-05  
**é—®é¢˜çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤  
**ä¼˜å…ˆçº§**ï¼šé«˜  
**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2026-01-05

