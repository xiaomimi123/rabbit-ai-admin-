# å›¢é˜Ÿå…³ç³»é¡µé¢åˆ†é¡µé—®é¢˜å®¡æŸ¥æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

**é—®é¢˜è¡¨ç°**ï¼š
- åœ¨åå°ç®¡ç†é¡µé¢çš„"å›¢é˜Ÿå…³ç³»"åŠŸèƒ½ä¸­ï¼ŒæŸ¥è¯¢å‡ºæ¥çš„æ•°æ®åªèƒ½æ˜¾ç¤ºä¸‹é¢ 50 ä¸ªå›¢é˜Ÿæˆå‘˜
- ç”¨æˆ·å®é™…é‚€è¯·äº† 94 ä¸ªä¸‹çº§æˆå‘˜ï¼Œä½†é¡µé¢åªèƒ½æ˜¾ç¤ºå‰ 50 ä¸ª
- ç¼ºå°‘åˆ†é¡µåŠŸèƒ½ï¼Œæ— æ³•æŸ¥çœ‹æ‰€æœ‰å›¢é˜Ÿæˆå‘˜

**ç”¨æˆ·åé¦ˆ**ï¼š
- ç”¨æˆ·åœ°å€ï¼šæŸ¥è¯¢æŸä¸ªç”¨æˆ·æ—¶
- å®é™…é‚€è¯·äººæ•°ï¼š94 äºº
- æ˜¾ç¤ºäººæ•°ï¼š50 äºº
- ç¼ºå¤±äººæ•°ï¼š44 äºº

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### 1. åç«¯ç¡¬ç¼–ç é™åˆ¶

**é—®é¢˜ä½ç½®**ï¼š`rabbit-ai-backend/src/services/admin.ts` ç¬¬ 744-750 è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```typescript
// 3. æŸ¥è¯¢ä¸‹çº§ï¼ˆè¢«æ¨èäººåˆ—è¡¨ï¼Œæœ€å¤š50ä¸ªï¼ŒæŒ‰é‚€è¯·æ•°å€’åºï¼‰
const { data: downlineUsers, error: downlineErr } = await supabase
  .from('users')
  .select('address,energy_total,invite_count,created_at')
  .eq('referrer_address', addr)
  .order('invite_count', { ascending: false })
  .limit(50);  // âŒ é—®é¢˜ï¼šç¡¬ç¼–ç é™åˆ¶ä¸º 50 æ¡
```

**é—®é¢˜åˆ†æ**ï¼š
1. âŒ åç«¯ç¡¬ç¼–ç  `.limit(50)`ï¼Œåªè¿”å›å‰ 50 æ¡æ•°æ®
2. âŒ API æ¥å£ä¸æ”¯æŒåˆ†é¡µå‚æ•°ï¼ˆ`limit` å’Œ `offset`ï¼‰
3. âŒ å‰ç«¯æ— æ³•è·å–æ€»æ•°ï¼Œæ— æ³•å®ç°åˆ†é¡µ
4. âŒ å¦‚æœç”¨æˆ·é‚€è¯·è¶…è¿‡ 50 äººï¼Œæ— æ³•æŸ¥çœ‹æ‰€æœ‰å›¢é˜Ÿæˆå‘˜

### 2. å‰ç«¯ç¼ºå°‘åˆ†é¡µåŠŸèƒ½

**é—®é¢˜ä½ç½®**ï¼š`rabbit-ai-admin/pages/TeamHierarchy.tsx` ç¬¬ 182-238 è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```typescript
{/* ä¸‹çº§å›¢é˜Ÿ */}
<div>
  <h2 className="text-lg font-bold text-white mb-3 flex items-center gap-2">
    <ArrowDown className="text-purple-400" size={20} />
    ä¸‹çº§å›¢é˜Ÿ ({downline.length} äºº)  // âŒ é—®é¢˜ï¼šåªæ˜¾ç¤ºè¿”å›çš„æ•°æ®æ•°é‡
  </h2>
  {downline.length > 0 ? (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {downline.map((member, index) => (
        // ... æ˜¾ç¤ºå›¢é˜Ÿæˆå‘˜å¡ç‰‡
      ))}
    </div>
  ) : (
    <EmptyState variant="database" title="æš‚æ— ä¸‹çº§å›¢é˜Ÿæˆå‘˜" />
  )}
</div>
```

**é—®é¢˜åˆ†æ**ï¼š
1. âŒ å‰ç«¯ç›´æ¥æ˜¾ç¤ºæ‰€æœ‰ `downline` æ•°æ®ï¼Œæ²¡æœ‰åˆ†é¡µ
2. âŒ æ²¡æœ‰åˆ†é¡µæ§ä»¶ï¼ˆä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µï¼‰
3. âŒ æ²¡æœ‰æ˜¾ç¤ºæ€»äººæ•°å’Œå½“å‰é¡µèŒƒå›´
4. âŒ å¦‚æœæ•°æ®é‡å¤§ï¼Œé¡µé¢ä¼šå¾ˆé•¿ï¼Œå½±å“æ€§èƒ½

### 3. API æ¥å£è®¾è®¡é—®é¢˜

**é—®é¢˜ä½ç½®**ï¼š`rabbit-ai-backend/src/api/routes/admin.ts` ç¬¬ 164-174 è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```typescript
app.get('/api/admin/users/:address/team', async (req: FastifyRequest, reply: FastifyReply) => {
  if (!assertAdmin(req, reply)) return;
  const addrParsed = AddressSchema.safeParse(String((req.params as any)?.address || '').toLowerCase());
  if (!addrParsed.success) return reply.status(400).send({ ok: false, code: 'INVALID_REQUEST', message: addrParsed.error.message });
  try {
    return await adminGetUserTeam(addrParsed.data);  // âŒ é—®é¢˜ï¼šæ²¡æœ‰ä¼ é€’åˆ†é¡µå‚æ•°
  } catch (e) {
    const err = toErrorResponse(e);
    return reply.status(400).send(err);
  }
});
```

**é—®é¢˜åˆ†æ**ï¼š
1. âŒ API æ¥å£ä¸æ¥å—æŸ¥è¯¢å‚æ•°ï¼ˆ`limit` å’Œ `offset`ï¼‰
2. âŒ è¿”å›æ•°æ®ä¸­æ²¡æœ‰æ€»æ•°ï¼ˆ`total`ï¼‰å­—æ®µ
3. âŒ æ— æ³•æ”¯æŒæœåŠ¡ç«¯åˆ†é¡µ

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ·»åŠ åˆ†é¡µæ”¯æŒï¼ˆæ¨èï¼‰

**ä¿®å¤æ€è·¯**ï¼š
1. **åç«¯ä¿®æ”¹**ï¼š
   - ä¿®æ”¹ `adminGetUserTeam` å‡½æ•°ï¼Œæ·»åŠ  `limit` å’Œ `offset` å‚æ•°
   - æ·»åŠ æ€»æ•°æŸ¥è¯¢ï¼ˆä½¿ç”¨ `count: 'exact'`ï¼‰
   - è¿”å› `total` å­—æ®µï¼Œæ–¹ä¾¿å‰ç«¯å®ç°åˆ†é¡µ

2. **API æ¥å£ä¿®æ”¹**ï¼š
   - æ¥å—æŸ¥è¯¢å‚æ•° `limit`ï¼ˆé»˜è®¤ 50ï¼‰å’Œ `offset`ï¼ˆé»˜è®¤ 0ï¼‰
   - è¿”å›æ ¼å¼ä¸­æ·»åŠ  `total` å­—æ®µ

3. **å‰ç«¯ä¿®æ”¹**ï¼š
   - ä½¿ç”¨ `usePagination` Hook ç®¡ç†åˆ†é¡µçŠ¶æ€
   - æ·»åŠ åˆ†é¡µæ§ä»¶ï¼ˆä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ/é¡µç ï¼‰
   - æ˜¾ç¤ºæ€»äººæ•°å’Œå½“å‰é¡µèŒƒå›´
   - åˆ†é¡µå˜åŒ–æ—¶é‡æ–°è¯·æ±‚æ•°æ®

**ä¿®å¤ä»£ç ç¤ºä¾‹**ï¼š

**åç«¯** (`rabbit-ai-backend/src/services/admin.ts`)ï¼š
```typescript
export async function adminGetUserTeam(
  address: string,
  options?: { limit?: number; offset?: number }
) {
  const limit = options?.limit || 50;
  const offset = options?.offset || 0;
  
  // ... æŸ¥è¯¢ç›®æ ‡ç”¨æˆ·å’Œä¸Šçº§çš„ä»£ç ä¿æŒä¸å˜ ...
  
  // 3. æŸ¥è¯¢ä¸‹çº§ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
  const { data: downlineUsers, error: downlineErr, count } = await supabase
    .from('users')
    .select('address,energy_total,invite_count,created_at', { count: 'exact' })
    .eq('referrer_address', addr)
    .order('invite_count', { ascending: false })
    .range(offset, offset + limit - 1);  // âœ… ä½¿ç”¨ range å®ç°åˆ†é¡µ
  
  // ... å¤„ç†æ•°æ® ...
  
  return {
    ok: true,
    target,
    upline,
    downline,
    total: count || 0,  // âœ… è¿”å›æ€»æ•°
  };
}
```

**API è·¯ç”±** (`rabbit-ai-backend/src/api/routes/admin.ts`)ï¼š
```typescript
app.get('/api/admin/users/:address/team', async (req: FastifyRequest, reply: FastifyReply) => {
  if (!assertAdmin(req, reply)) return;
  const addrParsed = AddressSchema.safeParse(String((req.params as any)?.address || '').toLowerCase());
  if (!addrParsed.success) return reply.status(400).send({ ok: false, code: 'INVALID_REQUEST', message: addrParsed.error.message });
  
  // âœ… è§£æåˆ†é¡µå‚æ•°
  const limit = Number((req.query as any)?.limit || 50);
  const offset = Number((req.query as any)?.offset || 0);
  
  try {
    return await adminGetUserTeam(addrParsed.data, { limit, offset });
  } catch (e) {
    const err = toErrorResponse(e);
    return reply.status(400).send(err);
  }
});
```

**å‰ç«¯ API** (`rabbit-ai-admin/lib/api.ts`)ï¼š
```typescript
export async function getUserTeam(
  address: string,
  options?: { limit?: number; offset?: number }
) {
  const params = new URLSearchParams();
  if (options?.limit) params.append('limit', String(options.limit));
  if (options?.offset) params.append('offset', String(options.offset));
  
  const queryString = params.toString();
  return apiFetch<{
    ok: boolean;
    target: { /* ... */ };
    upline: { /* ... */ } | null;
    downline: Array<{ /* ... */ }>;
    total: number;  // âœ… æ·»åŠ æ€»æ•°å­—æ®µ
  }>(`/admin/users/${encodeURIComponent(address)}/team${queryString ? `?${queryString}` : ''}`);
}
```

**å‰ç«¯é¡µé¢** (`rabbit-ai-admin/pages/TeamHierarchy.tsx`)ï¼š
```typescript
import { usePagination } from '../hooks';

const TeamHierarchy: React.FC = () => {
  // ... å…¶ä»–çŠ¶æ€ ...
  const [totalDownline, setTotalDownline] = useState(0);
  const pagination = usePagination({ pageSize: 50 });  // âœ… ä½¿ç”¨åˆ†é¡µ Hook
  
  const handleSearch = async () => {
    // ... éªŒè¯åœ°å€ ...
    
    setLoading(true);
    try {
      const data = await getUserTeam(address, {
        limit: pagination.pageSize,
        offset: pagination.offset,
      });
      
      if (data.ok) {
        setTarget(data.target);
        setUpline(data.upline);
        setDownline(data.downline || []);
        pagination.setTotal(data.total || 0);  // âœ… è®¾ç½®æ€»æ•°
        setTotalDownline(data.total || 0);
        showNotification('success', 'æŸ¥è¯¢æˆåŠŸ');
      }
    } catch (e: any) {
      // ... é”™è¯¯å¤„ç† ...
    } finally {
      setLoading(false);
    }
  };
  
  // âœ… åˆ†é¡µå˜åŒ–æ—¶é‡æ–°åŠ è½½æ•°æ®
  useEffect(() => {
    if (target) {
      handleSearch();
    }
  }, [pagination.page]);
  
  // ... æ¸²æŸ“ä»£ç  ...
  
  {/* ä¸‹çº§å›¢é˜Ÿ */}
  <div>
    <h2 className="text-lg font-bold text-white mb-3 flex items-center gap-2">
      <ArrowDown className="text-purple-400" size={20} />
      ä¸‹çº§å›¢é˜Ÿ ({totalDownline} äºº)  {/* âœ… æ˜¾ç¤ºæ€»äººæ•° */}
    </h2>
    
    {/* âœ… æ·»åŠ åˆ†é¡µæ§ä»¶ */}
    {totalDownline > pagination.pageSize && (
      <div className="flex items-center justify-between mb-4">
        <div className="text-sm text-zinc-500">
          æ˜¾ç¤ºç¬¬ {pagination.offset + 1}-{Math.min(pagination.offset + pagination.pageSize, totalDownline)} æ¡ï¼Œ
          å…± {totalDownline} æ¡
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={pagination.prevPage}
            disabled={!pagination.hasPrev}
            className="px-3 py-1 bg-zinc-800 border border-zinc-700 rounded text-sm text-zinc-300 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-zinc-700"
          >
            ä¸Šä¸€é¡µ
          </button>
          <span className="text-sm text-zinc-400">
            ç¬¬ {pagination.page} / {pagination.totalPages} é¡µ
          </span>
          <button
            onClick={pagination.nextPage}
            disabled={!pagination.hasNext}
            className="px-3 py-1 bg-zinc-800 border border-zinc-700 rounded text-sm text-zinc-300 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-zinc-700"
          >
            ä¸‹ä¸€é¡µ
          </button>
        </div>
      </div>
    )}
    
    {/* å›¢é˜Ÿæˆå‘˜åˆ—è¡¨ */}
    {downline.length > 0 ? (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {downline.map((member, index) => (
          // ... å›¢é˜Ÿæˆå‘˜å¡ç‰‡ ...
        ))}
      </div>
    ) : (
      <EmptyState variant="database" title="æš‚æ— ä¸‹çº§å›¢é˜Ÿæˆå‘˜" />
    )}
  </div>
};
```

---

## ğŸ¯ æ¨èä¿®å¤æ–¹æ¡ˆ

**æ¨èä½¿ç”¨æ–¹æ¡ˆ 1ï¼šæ·»åŠ åˆ†é¡µæ”¯æŒ**

**ä¼˜åŠ¿**ï¼š
- âœ… æ”¯æŒæŸ¥çœ‹æ‰€æœ‰å›¢é˜Ÿæˆå‘˜ï¼ˆä¸å— 50 æ¡é™åˆ¶ï¼‰
- âœ… æå‡æ€§èƒ½ï¼ˆæ¯æ¬¡åªåŠ è½½ä¸€é¡µæ•°æ®ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼ˆæœ‰åˆ†é¡µæ§ä»¶ï¼Œå¯ä»¥ç¿»é¡µæŸ¥çœ‹ï¼‰
- âœ… ä¸ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´ï¼ˆä½¿ç”¨ `usePagination` Hookï¼‰

**å®æ–½æ­¥éª¤**ï¼š
1. ä¿®æ”¹åç«¯ `adminGetUserTeam` å‡½æ•°ï¼Œæ·»åŠ åˆ†é¡µå‚æ•°å’Œæ€»æ•°æŸ¥è¯¢
2. ä¿®æ”¹ API è·¯ç”±ï¼Œæ¥å—æŸ¥è¯¢å‚æ•°
3. ä¿®æ”¹å‰ç«¯ API å‡½æ•°ï¼Œæ”¯æŒåˆ†é¡µå‚æ•°
4. ä¿®æ”¹å‰ç«¯é¡µé¢ï¼Œæ·»åŠ åˆ†é¡µé€»è¾‘å’Œ UI

---

## ğŸ“Š å½±å“è¯„ä¼°

### ä¿®å¤å‰
- âŒ åªèƒ½æ˜¾ç¤ºå‰ 50 ä¸ªå›¢é˜Ÿæˆå‘˜
- âŒ æ— æ³•æŸ¥çœ‹æ‰€æœ‰å›¢é˜Ÿæˆå‘˜
- âŒ å¦‚æœç”¨æˆ·é‚€è¯·è¶…è¿‡ 50 äººï¼Œéƒ¨åˆ†æˆå‘˜æ— æ³•æŸ¥çœ‹

### ä¿®å¤å
- âœ… æ”¯æŒåˆ†é¡µï¼Œå¯ä»¥æŸ¥çœ‹æ‰€æœ‰å›¢é˜Ÿæˆå‘˜
- âœ… æ¯æ¬¡åªåŠ è½½ä¸€é¡µæ•°æ®ï¼Œæ€§èƒ½æ›´å¥½
- âœ… æ˜¾ç¤ºæ€»äººæ•°å’Œå½“å‰é¡µèŒƒå›´
- âœ… æœ‰åˆ†é¡µæ§ä»¶ï¼Œæ–¹ä¾¿ç¿»é¡µ

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

**åç«¯**ï¼š
- `rabbit-ai-backend/src/services/admin.ts` - ä¿®æ”¹ `adminGetUserTeam` å‡½æ•°
- `rabbit-ai-backend/src/api/routes/admin.ts` - ä¿®æ”¹ API è·¯ç”±

**å‰ç«¯**ï¼š
- `rabbit-ai-admin/lib/api.ts` - ä¿®æ”¹ `getUserTeam` å‡½æ•°
- `rabbit-ai-admin/pages/TeamHierarchy.tsx` - æ·»åŠ åˆ†é¡µé€»è¾‘å’Œ UI

### é£é™©è¯„ä¼°
- **é£é™©ç­‰çº§**ï¼šä½
- **å½±å“èŒƒå›´**ï¼šå›¢é˜Ÿå…³ç³»æŸ¥è¯¢é¡µé¢
- **å›æ»šéš¾åº¦**ï¼šä½
- **å…¼å®¹æ€§**ï¼šå‘åå…¼å®¹ï¼ˆé»˜è®¤å‚æ•°ä¿æŒåŸæœ‰è¡Œä¸ºï¼‰

---

## âœ… æ£€æŸ¥æ¸…å•

- [ ] ä¿®æ”¹åç«¯ `adminGetUserTeam` å‡½æ•°ï¼Œæ·»åŠ åˆ†é¡µå‚æ•°
- [ ] æ·»åŠ æ€»æ•°æŸ¥è¯¢ï¼ˆ`count: 'exact'`ï¼‰
- [ ] ä¿®æ”¹ API è·¯ç”±ï¼Œæ¥å—æŸ¥è¯¢å‚æ•°
- [ ] ä¿®æ”¹å‰ç«¯ API å‡½æ•°ï¼Œæ”¯æŒåˆ†é¡µå‚æ•°
- [ ] ä¿®æ”¹å‰ç«¯é¡µé¢ï¼Œä½¿ç”¨ `usePagination` Hook
- [ ] æ·»åŠ åˆ†é¡µæ§ä»¶ UI
- [ ] æ˜¾ç¤ºæ€»äººæ•°å’Œå½“å‰é¡µèŒƒå›´
- [ ] æµ‹è¯•åˆ†é¡µåŠŸèƒ½ï¼ˆæŸ¥è¯¢æœ‰ 94 ä¸ªå›¢é˜Ÿæˆå‘˜çš„ç”¨æˆ·ï¼‰
- [ ] æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼ˆåªæœ‰ 1 ä¸ªã€50 ä¸ªã€100+ ä¸ªå›¢é˜Ÿæˆå‘˜ï¼‰

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-05  
**é—®é¢˜çŠ¶æ€**: ğŸ”´ å¾…ä¿®å¤  
**ä¼˜å…ˆçº§**: é«˜  
**é¢„è®¡ä¿®å¤æ—¶é—´**: 1-2 å°æ—¶

